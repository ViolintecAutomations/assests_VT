{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <!-- Header Section -->
      <div class="text-center mb-4">
        <h2 class="display-6 fw-bold text-primary mb-2">
          <i class="bi bi-upload-circle me-2"></i>Upload Purchase Order
        </h2>
        <p class="text-muted">Create and upload purchase orders for approved purchase requests</p>
      </div>

      <!-- Main Form Card -->
      <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white py-3">
          <h5 class="mb-0">
            <i class="bi bi-file-earmark-text me-2"></i>Purchase Order Details
          </h5>
        </div>
        <div class="card-body p-5">
          <form id="po-upload-form" enctype="multipart/form-data" method="post">
            
            <!-- PR Number Input Section -->
            <div class="row mb-4">
              <div class="col-12">
                <label for="pr_number_input" class="form-label fw-bold">
                  <i class="bi bi-hash me-1"></i>PR Number
                </label>
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-light">
                      <i class="bi bi-hash text-primary"></i>
                    </span>
                  <input type="text" class="form-control form-control-lg" id="pr_number_input" 
                         placeholder="Enter PR number (e.g., PR20250731101524)" required>
                    <input type="hidden" id="pr_id" name="pr_id" required>
                  <button type="button" class="btn btn-primary" onclick="loadPRDetails()">
                    <i class="bi bi-search me-1"></i>Load PR Details
                  </button>
                </div>
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>Enter the PR number to load its details
                </small>
              </div>
            </div>

            <!-- PR Details Box -->
            <div id="pr_details_box" class="row mb-4" style="display: none;">
              <div class="col-12">
                <div class="card border-primary bg-light">
                  <div class="card-header bg-primary text-white py-2">
                    <h6 class="mb-0">
                      <i class="bi bi-info-circle me-2"></i>PR Details
                    </h6>
                  </div>
                  <div class="card-body p-3">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-2">
                          <strong>PR Number:</strong> <span id="pr_details_number"></span>
                        </div>
                        <div class="mb-2">
                          <strong>Status:</strong> <span id="pr_details_status" class="badge"></span>
                        </div>
                        <div class="mb-2">
                          <strong>Requester:</strong> <span id="pr_details_requester"></span>
                        </div>
                        <div class="mb-2">
                          <strong>Created:</strong> <span id="pr_details_created"></span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-2">
                          <strong>Total Amount:</strong> <span id="pr_details_amount"></span>
                        </div>
                        <div class="mb-2">
                          <strong>Approved Items:</strong> <span id="pr_details_items_count"></span>
                        </div>
                        <div class="mb-2">
                          <strong>Justification:</strong> <span id="pr_details_justification"></span>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3">
                      <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPRItems()">
                        <i class="bi bi-list-ul me-1"></i>View Approved Items
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- PR Items Modal -->
            <div class="modal fade" id="prItemsModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      <i class="bi bi-list-ul me-2"></i>PR Items
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div id="pr_items_table"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- PO Details Section -->
            <div class="row g-4 mb-4">
              <div class="col-md-6">
                <label for="po_number" class="form-label fw-bold">
                  <i class="bi bi-tag me-1"></i>PO Number
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-hash text-success"></i>
                  </span>
                  <input type="text" class="form-control" id="po_number" name="po_number" 
                         placeholder="Enter PO number" required>
    </div>
    </div>
              
              <div class="col-md-6">
                <label for="po_date" class="form-label fw-bold">
                  <i class="bi bi-calendar me-1"></i>PO Date
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-calendar-date text-info"></i>
                  </span>
      <input type="date" class="form-control" id="po_date" name="po_date" required>
    </div>
              </div>
            </div>

            <div class="row g-4 mb-4">
              <div class="col-md-6">
                <label for="expected_delivery_date" class="form-label fw-bold">
                  <i class="bi bi-truck me-1"></i>Expected Delivery Date
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-calendar-check text-warning"></i>
                  </span>
                  <input type="date" class="form-control" id="expected_delivery_date" 
                         name="expected_delivery_date" required>
                </div>
              </div>
              
              <div class="col-md-6">
                <label for="vendor_name" class="form-label fw-bold">
                  <i class="bi bi-building me-1"></i>Vendor Name
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-shop text-danger"></i>
                  </span>
                  <input type="text" class="form-control" id="vendor_name" name="vendor_name" 
                         placeholder="Enter vendor name" required>
                </div>
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>Auto-populated from PR details
                </small>
              </div>
            </div>

            <!-- File Upload Section -->
            <div class="row mb-4">
              <div class="col-12">
                <label for="po_file" class="form-label fw-bold">
                  <i class="bi bi-file-earmark-pdf me-1"></i>PO File (PDF)
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-upload text-primary"></i>
                  </span>
                  <input type="file" class="form-control" id="po_file" name="po_file" 
                         accept="application/pdf" required>
                </div>
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>Only PDF files are accepted
                </small>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="row">
              <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5 py-3">
                  <i class="bi bi-upload me-2"></i>Upload Purchase Order
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="po-upload-msg" class="mt-4"></div>
    </div>
    </div>
</div>

<style>
/* Custom Styles */
.bg-gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
  border-radius: 15px;
  overflow: hidden;
  min-height: 600px;
}

.card-header {
  border-bottom: none;
}

.card-body {
  padding: 3rem !important;
}

.form-control, .input-group-text {
  border-radius: 8px;
  font-size: 1rem;
}

.form-control-lg {
  font-size: 1.1rem;
  padding: 0.75rem 1rem;
}

.form-control:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 10px;
  transition: all 0.3s ease;
  font-size: 1.1rem;
  padding: 1rem 2rem;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* PR Dropdown Styling */
.pr-dropdown-item {
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  transition: all 0.2s ease;
  font-size: 1rem;
}

.pr-dropdown-item:hover {
  background-color: #f8f9fa;
  transform: translateX(4px);
}

.pr-dropdown-item.selected {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.pr-dropdown-item .pr-number {
  font-weight: 600;
  font-size: 1.2rem;
}

.pr-dropdown-item .pr-details {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
}

.pr-dropdown-item.selected .pr-details {
  color: #e9ecef;
}

/* Alert Styling */
.alert {
  border-radius: 10px;
  border: none;
  font-size: 1rem;
  padding: 1rem 1.5rem;
}

.alert-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
}

.alert-danger {
  background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
  color: white;
}

/* Responsive Design */
@media (max-width: 1200px) {
  .col-lg-10 {
    max-width: 95%;
  }
}

@media (max-width: 768px) {
  .container-fluid {
    padding: 1rem;
  }
  
  .card-body {
    padding: 2rem !important;
  }
  
  .btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1rem;
  }
  
  .form-control-lg {
    font-size: 1rem;
  }
}

@media (min-width: 1400px) {
  .col-xl-8 {
    max-width: 90%;
  }
  
  .card-body {
    padding: 4rem !important;
  }
}

/* Loading Animation */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Form Validation Styling */
.form-control.is-invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control.is-valid {
  border-color: #28a745;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Enhanced spacing for larger screens */
@media (min-width: 1600px) {
  .container-fluid {
    max-width: 1800px;
    margin: 0 auto;
  }
  
  .card {
    min-height: 700px;
  }
  
  .form-control, .input-group-text {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
  }
  
  .btn-lg {
    font-size: 1.2rem;
    padding: 1.25rem 2.5rem;
  }
}
</style>

<script>
let selectedPR = null;

// Load PR details function
function loadPRDetails() {
  const prNumber = document.getElementById('pr_number_input').value.trim();
  
  if (!prNumber) {
    alert('Please enter a PR number');
    return;
  }
  
  // Show loading state
  const detailsBox = document.getElementById('pr_details_box');
  detailsBox.innerHTML = '<div class="text-center"><div class="loading-spinner"></div> Loading PR details...</div>';
  detailsBox.style.display = 'block';
  
  // Fetch PR details by number
  fetch(`/api/purchase_requests/by_number/${prNumber}`)
    .then(response => response.json())
  .then(data => {
      if (data.success) {
        // Check if there are any approved items
        const approvedItems = data.items.filter(item => item.approval_status === 'approved');
        if (approvedItems.length === 0) {
          detailsBox.innerHTML = '<div class="alert alert-warning">PR found but no items have been approved yet. Please approve items first.</div>';
        } else {
          displayPRDetails(data.purchase_request, data.items);
          selectedPR = data.purchase_request;
          document.getElementById('pr_id').value = data.purchase_request.id;
        }
      } else {
        detailsBox.innerHTML = '<div class="alert alert-danger">PR not found</div>';
      }
    })
    .catch(error => {
      console.error('Error loading PR details:', error);
      detailsBox.innerHTML = '<div class="alert alert-danger">Network error: Unable to load PR details. Please check your connection and try again.</div>';
    });
}

// Display PR details
function displayPRDetails(pr, items) {
  const detailsBox = document.getElementById('pr_details_box');
  
  // Format dates
  const createdDate = new Date(pr.created_at).toLocaleDateString();
  
  // Count approved items
  const approvedItems = items.filter(item => item.approval_status === 'approved');
  
  // Auto-populate vendor name from the first approved item
  if (approvedItems.length > 0) {
    const vendorName = approvedItems[0].vendor || 'N/A';
    const vendorInput = document.getElementById('vendor_name');
    vendorInput.value = vendorName;
    
    // Check if there are multiple vendors
    const uniqueVendors = [...new Set(approvedItems.map(item => item.vendor))];
    if (uniqueVendors.length > 1) {
      // Show notification about multiple vendors
      showMessage(`Multiple vendors found in PR. Using first vendor: ${vendorName}. You can modify if needed.`, 'info');
    }
    
    // Add a small visual indicator that vendor was auto-populated
    vendorInput.style.backgroundColor = '#e8f5e8';
    setTimeout(() => {
      vendorInput.style.backgroundColor = '';
    }, 2000);
  }
  
  detailsBox.innerHTML = `
    <div class="col-12">
      <div class="card border-primary bg-light">
        <div class="card-header bg-primary text-white py-2">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>PR Details
          </h6>
        </div>
        <div class="card-body p-3">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-2">
                <strong>PR Number:</strong> <span>${pr.pr_number}</span>
              </div>
              <div class="mb-2">
                <strong>Status:</strong> <span class="badge bg-success">${pr.status}</span>
              </div>
              <div class="mb-2">
                <strong>Requester:</strong> <span>${pr.requester_name}</span>
              </div>
              <div class="mb-2">
                <strong>Created:</strong> <span>${createdDate}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <strong>Total Amount:</strong> <span>₹${pr.total_amount || 0}</span>
              </div>
              <div class="mb-2">
                <strong>Approved Items:</strong> <span>${approvedItems.length} items</span>
              </div>
              <div class="mb-2">
                <strong>Justification:</strong> <span>${pr.justification || 'N/A'}</span>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPRItems('${pr.pr_number}')">
              <i class="bi bi-list-ul me-1"></i>View Approved Items
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  detailsBox.style.display = 'block';
}

// Show PR items in modal
function showPRItems(prNumber) {
  fetch(`/api/purchase_requests/by_number/${prNumber}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const items = data.items.filter(item => item.approval_status === 'approved');
        const tableContainer = document.getElementById('pr_items_table');
        
        let tableHTML = `
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Asset Type</th>
                  <th>Configuration</th>
                  <th>Brand</th>
                  <th>Vendor</th>
                  <th>Quantity to Procure</th>
                  <th>Unit Cost</th>
                  <th>Total Cost</th>
                  <th>FAVOR</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        items.forEach(item => {
          const totalCost = (item.unit_cost || 0) * (item.quantity_to_procure || 0);
          let additional = {};
          try {
            if (item.additional_fields) {
              additional = typeof item.additional_fields === 'string' ? JSON.parse(item.additional_fields) : item.additional_fields;
            }
          } catch (e) { additional = {}; }
          const processor = additional['processor'] || item.processor || '';
          const ram = additional['ram'] || item.ram || '';
          const rom = additional['rom'] || item.rom || '';
          const sysType = additional['system-type'] || additional['system_type'] || item.system_type || '';
          const configFallbackParts = [];
          if (processor) configFallbackParts.push(`Processor: ${processor}`);
          if (ram) configFallbackParts.push(`RAM: ${ram}`);
          if (rom) configFallbackParts.push(`ROM: ${rom}`);
          if (sysType) configFallbackParts.push(`Type: ${sysType}`);
          const configText = item.configuration || (configFallbackParts.length ? configFallbackParts.join(', ') : '-');
          tableHTML += `
            <tr>
              <td>${item.asset_type_name}</td>
              <td>${configText}</td>
              <td>${item.brand || '-'}</td>
              <td>${item.vendor || '-'}</td>
              <td>${item.quantity_to_procure}</td>
              <td>₹${(item.unit_cost || 0).toFixed(2)}</td>
              <td>₹${totalCost.toFixed(2)}</td>
              <td><span class="badge bg-${item.favor === 'Yes' ? 'success' : 'secondary'}">${item.favor || 'No'}</span></td>
            </tr>
          `;
        });
        
        tableHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        tableContainer.innerHTML = tableHTML;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('prItemsModal'));
        modal.show();
      }
    })
    .catch(error => {
      console.error('Error loading PR items:', error);
    });
}

// Handle Enter key on PR number input
document.getElementById('pr_number_input').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    loadPRDetails();
  }
});

// Handle form submit
const form = document.getElementById('po-upload-form');
form.onsubmit = function(e) {
  e.preventDefault();
  
  // Validate PR selection
  if (!document.getElementById('pr_id').value) {
    showMessage('Please load a PR first', 'danger');
    return;
  }
  
  // Show loading state
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<div class="loading-spinner me-2"></div>Uploading...';
  submitBtn.disabled = true;
  
  const formData = new FormData(form);
  fetch('/api/purchase_orders', {
    method: 'POST',
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showMessage(data.message, 'success');
      form.reset();
      selectedPR = null;
      document.getElementById('pr_details_box').style.display = 'none';
    } else {
      showMessage(data.error || 'Upload failed', 'danger');
    }
  })
  .catch(() => {
    showMessage('Upload failed', 'danger');
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
};

// Show message function
function showMessage(message, type) {
  const msgDiv = document.getElementById('po-upload-msg');
  msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('po_date').value = today;
  
  // Set expected delivery date to 30 days from now
  const deliveryDate = new Date();
  deliveryDate.setDate(deliveryDate.getDate() + 30);
  document.getElementById('expected_delivery_date').value = deliveryDate.toISOString().split('T')[0];
});
</script>
{% endblock %} 