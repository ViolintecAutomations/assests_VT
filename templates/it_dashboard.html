{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-tools text-primary me-2"></i>
                        IT Team Dashboard
                    </h1>
                    <p class="text-muted">Welcome back, {{ current_user.email }}</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                        <i class="fas fa-user-shield me-1"></i>
                        IT Team Member
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Assets
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ asset_counts|sum(attribute='count') }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-desktop fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Available Assets
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="available-count">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Assigned Assets
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="assigned-count">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Maintenance Issues
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ maintenance_requests|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Type Distribution -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Asset Distribution by Type</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="assetTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Asset Types</h6>
                </div>
                <div class="card-body">
                    {% for asset in asset_counts %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-sm font-weight-bold">{{ asset.asset_type }}</span>
                        <span class="badge bg-primary">{{ asset.count }}</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ (asset.count / asset_counts|sum(attribute='count') * 100)|round(1) }}%"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <!-- Maintenance Requests -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Maintenance Requests</h6>
                    <a href="/maintenance" class="btn btn-sm btn-primary">
                        <i class="fas fa-tools me-1"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if maintenance_requests %}
                        {% for request in maintenance_requests %}
                        <div class="d-flex align-items-center mb-3 p-2 border rounded">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-warning fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">{{ request.serial_number }} ({{ request.brand }} {{ request.model }})</div>
                                <div class="text-muted small">{{ request.issue_details[:50] }}...</div>
                                <div class="text-muted small">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ request.reported_at.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-{{ 'warning' if request.status == 'open' else 'info' if request.status == 'in_progress' else 'success' }}">
                                    {{ request.status.replace('_', ' ').title() }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>No pending maintenance requests</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Assignments -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Asset Assignments</h6>
                    <a href="/assign" class="btn btn-sm btn-primary">
                        <i class="fas fa-user-plus me-1"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_assignments %}
                        {% for assignment in recent_assignments %}
                        <div class="d-flex align-items-center mb-3 p-2 border rounded">
                            <div class="flex-shrink-0">
                                <i class="fas fa-user-check text-success fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold">{{ assignment.serial_number }} ({{ assignment.brand }} {{ assignment.model }})</div>
                                <div class="text-muted small">Assigned to: {{ assignment.name }}</div>
                                <div class="text-muted small">
                                    <i class="fas fa-building me-1"></i>
                                    {{ assignment.unit }}
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="text-muted small">
                                    {{ assignment.assigned_at.strftime('%Y-%m-%d') }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p>No recent assignments</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for asset type chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load asset counts
function loadAssetCounts() {
    fetch('/api/available_assets')
        .then(response => response.json())
        .then(data => {
            document.getElementById('available-count').textContent = data.length;
        });
    
    fetch('/api/assigned_assets')
        .then(response => response.json())
        .then(data => {
            document.getElementById('assigned-count').textContent = data.length;
        });
}

// Asset type chart
const ctx = document.getElementById('assetTypeChart').getContext('2d');
const assetTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [{% for asset in asset_counts %}'{{ asset.asset_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for asset in asset_counts %}{{ asset.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
            ],
            hoverBackgroundColor: [
                '#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02424',
                '#6b6d7d', '#4a4b54', '#224abe', '#13855c', '#1f8a9a'
            ],
            hoverBorderColor: "rgba(234, 236, 244, 1)",
        }],
    },
    options: {
        maintainAspectRatio: false,
        tooltips: {
            backgroundColor: "rgb(255,255,255)",
            bodyFontColor: "#858796",
            borderColor: '#dddfeb',
            borderWidth: 1,
            xPadding: 15,
            yPadding: 15,
            displayColors: false,
            caretPadding: 10,
        },
        legend: {
            display: true,
            position: 'bottom'
        },
        cutoutPercentage: 80,
    },
});

// Load counts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAssetCounts();
});
</script>
{% endblock %} 