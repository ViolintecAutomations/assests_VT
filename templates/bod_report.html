{% extends 'base.html' %}

{% block content %}
<style>
    .report-section {
        margin-bottom: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .status-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }
    
    .status-table th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
    }
    
    .status-table td {
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        vertical-align: top;
    }
    
    .status-working {
        color: #28a745;
        font-weight: 500;
    }
    
    .status-not-working {
        color: #dc3545;
        font-weight: 500;
    }
    
    .status-warning {
        color: #ffc107;
        font-weight: 500;
    }
    
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .report-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .report-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .questions-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .question-item {
        margin-bottom: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    
    .export-buttons {
        margin-bottom: 2rem;
        text-align: right;
    }
    
    .readonly-field {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
    }
    
    .editable-cell {
        background-color: #fff3cd;
        border: 1px dashed #ffc107;
        transition: all 0.3s ease;
    }
    
    .editable-cell:focus {
        background-color: #fff;
        border: 2px solid #007bff;
        outline: none;
        box-shadow: 0 0 5px rgba(0,123,255,0.3);
    }
    
    .edit-mode .status-table td[contenteditable="true"] {
        background-color: #fff3cd;
        border: 1px dashed #ffc107;
        cursor: text;
    }
    
    .edit-mode .status-table td[contenteditable="true"]:hover {
        background-color: #ffeaa7;
    }
    
    .status-dropdown {
        padding: 2px 6px;
        border: 1px solid #ddd;
        border-radius: 3px;
        background: white;
        font-size: 0.9rem;
    }
    
    .status-dropdown.status-working {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .status-dropdown.status-not-working {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    
    .remarks-input {
        font-size: 0.9rem;
        padding: 4px 8px;
    }
    
    .remarks-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
</style>

<div class="container-fluid">
    <!-- Report Header -->
    <div class="report-header">
        <h1 class="report-title">
            <i class="fas fa-clipboard-check me-2"></i>
            BOD - IT Infrastructure Status Report
        </h1>
        <p class="report-subtitle">
            Daily Pre-Day Infrastructure Status Check
            <br>
            <small>Generated on: <span id="currentDateTime"></span></small>
        </p>
    </div>

    <!-- Export Buttons -->
    <div class="export-buttons">
        <button class="btn btn-success me-2" id="saveReportBtn" onclick="saveBodReport()">
            <i class="fas fa-save me-1"></i>
            Save Report
        </button>
        <button class="btn btn-outline-primary me-2" onclick="exportToMarkdown()">
            <i class="fas fa-download me-1"></i>
            Export as Markdown
        </button>
        <button class="btn btn-outline-success me-2" onclick="printReport()">
            <i class="fas fa-print me-1"></i>
            Print Report
        </button>
        <button class="btn btn-outline-warning" onclick="clearAllSavedRows()" title="Clear all dynamically added rows for current location">
            <i class="fas fa-trash me-1"></i>
            Clear Saved Rows
        </button>
    </div>

    <!-- Internet Links Details Form - Separate Section -->
    <div class="report-section">
        <div class="section-header">
            <i class="fas fa-info-circle me-2"></i>
            BOD 
        </div>
        <div class="section-content">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="name" class="form-label">Name</label>
                    <div class="input-group">
                        <select class="form-select" id="name" placeholder="Select your name">
                            <option value="">Select your name</option>
                        </select>
                        {% if current_user.is_authenticated and current_user.role == 'super_admin' %}
                        <button class="btn btn-outline-success" type="button" onclick="addBodName()" title="Add new BOD name">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-danger" type="button" onclick="deleteBodName()" title="Remove selected BOD name">
                            <i class="fas fa-minus"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="date" class="form-label">Date</label>
                    <input type="text" class="form-control" id="date" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="location" class="form-label">Location</label>
                    <select class="form-select" id="location">
                        <option value="">Select Location</option>
                        <option value="unit-1">Unit-1</option>
                        <option value="unit-2">Unit-2</option>
                        <option value="unit-3">Unit-3</option>
                        <option value="unit-4">Unit-4</option>
                        <option value="unit-5">Unit-5</option>
                        <option value="GSS">GSS</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="submittedTime" class="form-label">Submitted Time</label>
                    <input type="text" class="form-control" id="submittedTime" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="primaryInternet" class="form-label">Primary Internet</label>
                    <div class="input-group">
                        <select class="form-select" id="primaryInternet">
                            <option value="">Select Primary Internet</option>
                        </select>
                        {% if current_user.is_authenticated and current_user.role == 'super_admin' %}
                        <button class="btn btn-outline-success" type="button" onclick="addPrimaryInternetBod()" title="Add new primary internet">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-danger" type="button" onclick="deletePrimaryInternetBod()" title="Remove selected primary internet">
                            <i class="fas fa-minus"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="secondaryInternet" class="form-label">Secondary Internet</label>
                    <div class="input-group">
                        <select class="form-select" id="secondaryInternet">
                            <option value="">Select Secondary Internet</option>
                        </select>
                        {% if current_user.is_authenticated and current_user.role == 'super_admin' %}
                        <button class="btn btn-outline-success" type="button" onclick="addPrimaryInternetBod()" title="Add new secondary internet">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-danger" type="button" onclick="deletePrimaryInternetBod()" title="Remove selected secondary internet">
                            <i class="fas fa-minus"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. Internet Links Section -->
    <div class="report-section">
        <div class="section-header">
                            <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-wifi me-2"></i>
                        1. Network
                    </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('network')" title="Add new network row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
                </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="internet-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Leased Lines/DSL Links</th>
                        <th>Choose Link</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Remarks</th>
                        <th>Checked Time</th>
                        {% if current_user.role == 'super_admin' %}
                        <th>Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td><input type="text" class="form-control leased-line-input second-column-input" value="Tata Leased Line IP : XXX" oninput="checkTataLeasedLine(this)"></td>
                        <td>Primary</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                                       <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                   <div class="reason-content">
                       <div class="mb-2">
                           <label class="form-label">call raised or not:</label>
                           <select class="form-select" id="call-raised-1" onchange="handleCallRaisedChange(1)">
                               <option value="">Select</option>
                               <option value="Yes">Yes</option>
                               <option value="No">No</option>
                           </select>
                       </div>
                       <div id="call-number-container-1" style="display: none;">
                           <input type="text" class="form-control" id="call-number-1" placeholder="Enter call number">
                       </div>
                       <div id="call-warning-1" style="display: none;">
                           <div class="alert alert-warning py-2 mb-0">
                               <small>❌ Please raise the call and put the ticket</small>
                           </div>
                       </div>
                   </div>
               </td>
                        <td><input type="text" class="form-control remarks-input" id="remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="checked-time-1">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'network')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td><input type="text" class="form-control leased-line-input second-column-input" value="Airtel Internet - XXX" readonly oninput="checkTataLeasedLine(this)"></td>
                        <td>Secondary</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                                       <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                   <div class="reason-content">
                       <div class="mb-2">
                           <label class="form-label">call raised or not:</label>
                           <select class="form-select" id="call-raised-2" onchange="handleCallRaisedChange(2)">
                               <option value="">Select</option>
                               <option value="Yes">Yes</option>
                               <option value="No">No</option>
                           </select>
                       </div>
                       <div id="call-number-container-2" style="display: none;">
                           <input type="text" class="form-control" id="call-number-2" placeholder="Enter call number">
                       </div>
                       <div id="call-warning-2" style="display: none;">
                           <div class="alert alert-warning py-2 mb-0">
                               <small>❌ Please raise the call and put the ticket</small>
                           </div>
                       </div>
                   </div>
               </td>
                        <td><input type="text" class="form-control remarks-input" id="remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="checked-time-2">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'network')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="3">
                        <td>3</td>
                        <td><input type="text" class="form-control leased-line-input second-column-input" value="DSL XXX" readonly oninput="checkTataLeasedLine(this)"></td>
                        <td>
                            <select class="form-select link-select">
                                <option value="Primary">Primary</option>
                                <option value="Secondary" selected>Secondary</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateStatus(this, 3)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                                       <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                   <div class="reason-content">
                       <div class="mb-2">
                           <label class="form-label">call raised or not:</label>
                           <select class="form-select" id="call-raised-3" onchange="handleCallRaisedChange(3)">
                               <option value="">Select</option>
                               <option value="Yes">Yes</option>
                               <option value="No">No</option>
                           </select>
                       </div>
                       <div id="call-number-container-3" style="display: none;">
                           <input type="text" class="form-control" id="call-number-3" placeholder="Enter call number">
                       </div>
                       <div id="call-warning-3" style="display: none;">
                           <div class="alert alert-warning py-2 mb-0">
                               <small>❌ Please raise the call and put the ticket</small>
                           </div>
                       </div>
                   </div>
               </td>
                        <td><input type="text" class="form-control remarks-input" id="remarks-3" placeholder="Enter remarks if needed"></td>
                        <td><span id="checked-time-3">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'network')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="4">
                        <td>4</td>
                        <td><input type="text" class="form-control leased-line-input second-column-input" value="BSNL XXX" readonly oninput="checkTataLeasedLine(this)"></td>
                        <td>
                            <select class="form-select link-select">
                                <option value="Primary">Primary</option>
                                <option value="Secondary" selected>Secondary</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateStatus(this, 4)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                                       <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                   <div class="reason-content">
                       <div class="mb-2">
                           <label class="form-label">call raised or not:</label>
                           <select class="form-select" id="call-raised-4" onchange="handleCallRaisedChange(4)">
                               <option value="">Select</option>
                               <option value="Yes">Yes</option>
                               <option value="No">No</option>
                           </select>
                       </div>
                       <div id="call-number-container-4" style="display: none;">
                           <input type="text" class="form-control" id="call-number-4" placeholder="Enter call number">
                       </div>
                       <div id="call-warning-4" style="display: none;">
                           <div class="alert alert-warning py-2 mb-0">
                               <small>❌ Please raise the call and put the ticket</small>
                           </div>
                       </div>
                   </div>
               </td>
                        <td><input type="text" class="form-control remarks-input" id="remarks-4" placeholder="Enter remarks if needed"></td>
                        <td><span id="checked-time-4">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'network')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="5">
                        <td>5</td>
                        <td><input type="text" class="form-control leased-line-input second-column-input" value="DSL - XXX" readonly oninput="checkTataLeasedLine(this)"></td>
                        <td>
                            <select class="form-select link-select">
                                <option value="Primary">Primary</option>
                                <option value="Secondary" selected>Secondary</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateStatus(this, 5)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                                       <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                   <div class="reason-content">
                       <div class="mb-2">
                           <label class="form-label">call raised or not:</label>
                           <select class="form-select" id="call-raised-5" onchange="handleCallRaisedChange(5)">
                               <option value="">Select</option>
                               <option value="Yes">Yes</option>
                               <option value="No">No</option>
                           </select>
                       </div>
                       <div id="call-number-container-5" style="display: none;">
                           <input type="text" class="form-control" id="call-number-5" placeholder="Enter call number">
                       </div>
                       <div id="call-warning-5" style="display: none;">
                           <div class="alert alert-warning py-2 mb-0">
                               <small>❌ Please raise the call and put the ticket</small>
                           </div>
                       </div>
                   </div>
               </td>
                        <td><input type="text" class="form-control remarks-input" id="remarks-5" placeholder="Enter remarks if needed"></td>
                        <td><span id="checked-time-5">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'network')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 2. Server Connectivity Check Section -->
    <div class="report-section">
        <div class="section-header">
                            <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-server me-2"></i>
                        2. Server Connectivity Check
                    </div>
                    <button class="btn btn-sm btn-success" onclick="addNewRow('server_connectivity')" title="Add new server connectivity row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="server-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Server Name</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Remarks</th>
                        <th>Checked Time</th>
                        {% if current_user.role == 'super_admin' %}
                        <th>Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Sharing access Checking – Storage</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateServerStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">In form to IT Manager:</label>
                                    <select class="form-select" id="it-manager-1" onchange="handleITManagerChange(1)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="it-manager-warning-1" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please call the IT manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="server-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="server-time-1">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'server_connectivity')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>New NAS Server status</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateServerStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">In form to IT Manager:</label>
                                    <select class="form-select" id="it-manager-2" onchange="handleITManagerChange(2)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="it-manager-warning-2" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please call the IT manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="server-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="server-time-2">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'server_connectivity')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="3">
                        <td>3</td>
                        <td>Server Room AC Status</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateServerStatus(this, 3)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">In form to IT Manager:</label>
                                    <select class="form-select" id="it-manager-3" onchange="handleITManagerChange(3)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="it-manager-warning-3" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please call the IT manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="server-remarks-3" placeholder="Enter remarks if needed"></td>
                        <td><span id="server-time-3">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'server_connectivity')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. Antivirus Status Section -->
    <div class="report-section">
        <div class="section-header">
                            <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-shield-alt me-2"></i>
                        3. Antivirus Status For Renganathan T
                    </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('antivirus')" title="Add new antivirus row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
                </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="antivirus-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>System Name</th>
                        <th>Antivirus Status</th>
                        <th>Last Updated</th>
                        <th>Remarks</th>
                        <th>Checked Time</th>
                        {% if current_user.role == 'super_admin' %}
                        <th>Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>SentinalOne</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateAntivirusStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Updated">Updated</option>
                                <option value="Not Updated">Not Updated</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control" placeholder="Last updated date"></td>
                        <td><input type="text" class="form-control remarks-input" id="antivirus-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="antivirus-time-1">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'antivirus')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>SentinalOne inITLaptop</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateAntivirusStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Updated">Updated</option>
                                <option value="Not Updated">Not Updated</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control" placeholder="Last updated date"></td>
                        <td><input type="text" class="form-control remarks-input" id="antivirus-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="antivirus-time-2">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'antivirus')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 4. Common Sharing Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-folder-open me-2"></i>
                    4. Common Sharing (Disk Check and Usage)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('common_sharing')" title="Add new common sharing row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="sharing-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Folder Name</th>
                        <th>Common Storage</th>
                        <th>Status</th>
                        <th>Remarks</th>
                        <th>Checked Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Disk Check</td>
                        <td>Keep always under 75% Usage</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateSharingStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="ok">ok</option>
                                <option value="Not ok">Not ok</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="sharing-remarks-1" placeholder="Enter remarks if needed" onchange="updateSharingRemarks(this, 1)"></td>
                        <td><span id="sharing-time-1">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'common_sharing')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 5. Security Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-video me-2"></i>
                    5. Security (Cameras, DVRs, Recordings)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('security')" title="Add new security row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="security-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Name</th>
                        <th>No of working</th>
                        <th>No of not working</th>
                        <th>Remarks</th>
                        <th>Submitted Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Outside Cameras</td>
                        <td><input type="number" class="form-control remarks-input" id="security-working-1" value="16" onchange="updateSecurityStatus(this, 1)"></td>
                        <td><input type="number" class="form-control remarks-input" id="security-not-working-1" value="0" onchange="updateSecurityStatus(this, 1)"></td>
                        <td><input type="text" class="form-control remarks-input" id="security-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="security-time-1">08:44:17</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'security')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>Outside Cameras-Recording</td>
                        <td><input type="number" class="form-control remarks-input" id="security-working-2" value="16" onchange="updateSecurityStatus(this, 2)"></td>
                        <td><input type="number" class="form-control remarks-input" id="security-not-working-2" value="0" onchange="updateSecurityStatus(this, 2)"></td>
                        <td><input type="text" class="form-control remarks-input" id="security-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="security-time-2">08:44:20</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'security')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="3">
                        <td>3</td>
                        <td>DVR 1</td>
                        <td><input type="number" class="form-control remarks-input" id="security-working-3" value="16" onchange="updateSecurityStatus(this, 3)"></td>
                        <td><input type="number" class="form-control remarks-input" id="security-not-working-3" value="0" onchange="updateSecurityStatus(this, 3)"></td>
                        <td><input type="text" class="form-control remarks-input" id="security-remarks-3" placeholder="Enter remarks if needed"></td>
                        <td><span id="security-time-3">08:44:23</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'security')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="4">
                        <td>4</td>
                        <td>DVR 2</td>
                        <td><input type="number" class="form-control remarks-input" id="security-working-4" value="16" onchange="updateSecurityStatus(this, 4)"></td>
                        <td><input type="number" class="form-control remarks-input" id="security-not-working-4" value="0" onchange="updateSecurityStatus(this, 4)"></td>
                        <td><input type="text" class="form-control remarks-input" id="security-remarks-4" placeholder="Enter remarks if needed"></td>
                        <td><span id="security-time-4">08:44:26</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'security')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="5">
                        <td>5</td>
                        <td>Inside Cameras</td>
                        <td><input type="number" class="form-control remarks-input" id="security-working-5" value="16" onchange="updateSecurityStatus(this, 5)"></td>
                        <td><input type="number" class="form-control remarks-input" id="security-not-working-5" value="1" onchange="updateSecurityStatus(this, 5)"></td>
                        <td><input type="text" class="form-control remarks-input" id="security-remarks-5" placeholder="Enter remarks if needed"></td>
                        <td><span id="security-time-5">08:44:28</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'security')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 6. Telecommunication Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-phone me-2"></i>
                    6. Telecommunication (Local Phone)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('telecom')" title="Add new telecommunication row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="telecom-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Remarks</th>
                        <th>Submitted Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Check Local Phone (Security)</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateTelecomStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager or HR:</label>
                                    <select class="form-select" id="telecom-it-hr-1" onchange="handleTelecomITHrChange(1)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="telecom-it-hr-warning-1" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager or HR
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="telecom-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="telecom-time-1">-</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'telecom')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 7. Technology Room Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-tv me-2"></i>
                    7. Technology Room (TV, Audio, Network)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('tech_room')" title="Add new technology room row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="techroom-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Equipment</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Remarks</th>
                        <th>Submitted Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>TV</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateTechRoomStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager:</label>
                                    <select class="form-select" id="techroom-it-manager-1" onchange="handleTechRoomITManagerChange(1)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="techroom-it-manager-warning-1" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="techroom-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="techroom-time-1">08:45:02</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'tech_room')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>Audio if available</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateTechRoomStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager:</label>
                                    <select class="form-select" id="techroom-it-manager-2" onchange="handleTechRoomITManagerChange(2)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="techroom-it-manager-warning-2" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="techroom-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="techroom-time-2">08:45:06</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'tech_room')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="3">
                        <td>3</td>
                        <td>Network</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateTechRoomStatus(this, 3)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager:</label>
                                    <select class="form-select" id="techroom-it-manager-3" onchange="handleTechRoomITManagerChange(3)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="techroom-it-manager-warning-3" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="techroom-remarks-3" placeholder="Enter remarks if needed"></td>
                        <td><span id="techroom-time-3">08:45:07</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'tech_room')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 8. Printers Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-print me-2"></i>
                    8. Printers (Status, Readings)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('printers')" title="Add new printer row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="printers-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Reading Yesterday</th>
                        <th>Reading Today</th>
                        <th>Remarks</th>
                        <th>Submitted Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Rental Printer</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updatePrinterStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" id="printer-reason-1" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div>
                                <label>Inform to IT Manager:</label>
                                <select class="form-select" id="printer-it-manager-1" onchange="handlePrinterITManagerChange(1)">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <div id="printer-it-manager-warning-1" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control" id="printer-yesterday-1" placeholder="No Data" readonly style="background-color: #f8f9fa;"></td>
                        <td><input type="text" class="form-control" id="printer-today-1" placeholder="Enter today's reading" onchange="updatePrinterStatus(this, 1)"></td>
                        <td><input type="text" class="form-control remarks-input" id="printer-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="printer-time-1">08:55:08</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'printers')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>Accounts Printer Ip:</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updatePrinterStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" id="printer-reason-2" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div>
                                <label>Inform to IT Manager:</label>
                                <select class="form-select" id="printer-it-manager-2" onchange="handlePrinterITManagerChange(2)">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <div id="printer-it-manager-warning-2" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control" id="printer-yesterday-2" placeholder="No Data" readonly style="background-color: #f8f9fa;"></td>
                        <td><input type="text" class="form-control" id="printer-today-2" placeholder="Enter today's reading" onchange="updatePrinterStatus(this, 2)"></td>
                        <td><input type="text" class="form-control remarks-input" id="printer-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="printer-time-2">08:55:15</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'printers')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="3">
                        <td>3</td>
                        <td>Printer</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updatePrinterStatus(this, 3)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" id="printer-reason-3" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div>
                                <label>Inform to IT Manager:</label>
                                <select class="form-select" id="printer-it-manager-3" onchange="handlePrinterITManagerChange(3)">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                                <div id="printer-it-manager-warning-3" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control" id="printer-yesterday-3" placeholder="No Data" readonly style="background-color: #f8f9fa;"></td>
                        <td><input type="text" class="form-control" id="printer-today-3" placeholder="Enter today's reading" onchange="updatePrinterStatus(this, 3)"></td>
                        <td><input type="text" class="form-control remarks-input" id="printer-remarks-3" placeholder="Enter remarks if needed"></td>
                        <td><span id="printer-time-3">08:55:24</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'printers')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 9. Others Section -->
    <div class="report-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-ellipsis-h me-2"></i>
                    9. Others (Reception TV, Biometric Attendance)
                </div>
                    {% if current_user.role == 'super_admin' %}
                    <button class="btn btn-sm btn-success" onclick="addNewRow('others')" title="Add new others row">
                        <i class="fas fa-plus me-1"></i>Add New Row
                    </button>
                    {% endif %}
            </div>
        </div>
        <div class="section-content">
            <table class="status-table" id="others-table">
                <thead>
                    <tr>
                        <th>S No</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Remarks</th>
                        <th>Submitted Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>1</td>
                        <td>Reception TV Status</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateOthersStatus(this, 1)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager or HR:</label>
                                    <select class="form-select" id="it-hr-1" onchange="handleITHrChange(1)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="it-hr-warning-1" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager or HR
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="others-remarks-1" placeholder="Enter remarks if needed"></td>
                        <td><span id="others-time-1">08:56:04</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'others')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                    <tr data-row="2">
                        <td>2</td>
                        <td>Biometric Attendance</td>
                        <td>
                            <select class="form-select status-dropdown" onchange="updateOthersStatus(this, 2)">
                                <option value="">Select Status</option>
                                <option value="Working">Working</option>
                                <option value="Not Working">Not Working</option>
                            </select>
                        </td>
                        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                            <div class="reason-content">
                                <div class="mb-2">
                                    <label class="form-label">Inform to IT Manager or HR:</label>
                                    <select class="form-select" id="it-hr-2" onchange="handleITHrChange(2)">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div id="it-hr-warning-2" style="display: none;">
                                    <div class="alert alert-warning mb-0">
                                        ❌ Please inform to IT Manager or HR
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="form-control remarks-input" id="others-remarks-2" placeholder="Enter remarks if needed"></td>
                        <td><span id="others-time-2">08:56:06</span></td>
                        {% if current_user.role == 'super_admin' %}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, 'others')" title="Delete row"><i class="fas fa-trash"></i></button></td>
                        {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


</div>

<script>
// Set current date and time when page loads
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };
    document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
    
    // Auto-generate date and submitted time
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
    });
    const timeStr = today.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    
    document.getElementById('date').value = dateStr;
    document.getElementById('submittedTime').value = timeStr;
    
    // Initialize editable tables
    initializeEditableTables();
    
    // Hide all table rows initially until a unit is selected
    hideAllTableRows();
    
    // Load BOD data for dropdowns
    loadBodData();
    
    // Load saved rows from localStorage
    loadSavedRows();
    
    // Clear any existing yesterday readings first
    clearYesterdayReadings();
    
    // Load yesterday's printer readings for current location if selected
    const initialLocation = document.getElementById('location').value;
    if (initialLocation) {
        console.log('DEBUG: Loading yesterday readings for initial location:', initialLocation);
        loadYesterdayPrinterReadings(initialLocation);
        // Also load Primary Internet BOD data for initial location
        loadPrimaryInternetBodData(initialLocation);
        // Update network table for initial location (after dropdowns are populated)
        setTimeout(() => {
            updateNetworkTableForLocation(initialLocation);
        }, 600);
        // Don't show rows for initially selected location - wait for user to change dropdown
        // showTableRowsForLocation(initialLocation);
    }
    
    // Add event listener for location dropdown to load yesterday's readings
    const locationSelect = document.getElementById('location');
    if (locationSelect) {
        locationSelect.addEventListener('change', function() {
            const newLocation = this.value;
            console.log('Location changed to:', newLocation);
            
            if (newLocation) {
                // Show rows for the selected location
                showTableRowsForLocation(newLocation);
                
                // Clear existing dynamically added rows for all sections
                clearDynamicallyAddedRows();
                
                // Load yesterday's printer readings for new location
                loadYesterdayPrinterReadings(newLocation);
                
                // Filter network rows by new location
                filterNetworkRowsByLocation(newLocation);
                
                // Reload dropdown data from location-specific database tables
                loadBodData();
                
                // Load Primary Internet BOD data for the selected location
                loadPrimaryInternetBodData(newLocation);
                
                // Load location-specific saved rows
                loadSavedRows();
                
                // Update network table for the new location (after dropdowns are populated)
                setTimeout(() => {
                    updateNetworkTableForLocation(newLocation);
                }, 600);
                
                // Synchronize network table after loading data
                setTimeout(() => {
                    synchronizeNetworkTableWithCommonItems();
                }, 800);
            } else {
                // Hide all rows if no location is selected
                hideAllTableRows();
            }
        });
    }
    
    // Add event listeners to Primary and Secondary Internet dropdowns
    const primaryInternetSelect = document.getElementById('primaryInternet');
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    
    if (primaryInternetSelect) {
        primaryInternetSelect.addEventListener('change', function() {
            console.log('Primary Internet dropdown changed, updating network table...');
            setTimeout(() => {
                synchronizeNetworkTableWithCommonItems();
            }, 100);
        });
    }
    
    if (secondaryInternetSelect) {
        secondaryInternetSelect.addEventListener('change', function() {
            console.log('Secondary Internet dropdown changed, updating network table...');
            setTimeout(() => {
                synchronizeNetworkTableWithCommonItems();
            }, 100);
        });
    }
    
    // Apply role-based editing restrictions to existing rows
    applyRoleBasedEditingToExistingRows();
    
    // Initialize network row filtering based on current location
    const currentLocation = document.getElementById('location').value;
    if (currentLocation) {
        filterNetworkRowsByLocation(currentLocation);
    } else {
        // If no location is selected, reset dropdowns to default
        resetInternetDropdowns();
    }
});

// Function to hide all table rows initially
function hideAllTableRows() {
    console.log('Hiding all table rows initially...');
    
    const sections = [
        { sectionType: 'network', tableId: 'internet-table' },
        { sectionType: 'server_connectivity', tableId: 'server-table' },
        { sectionType: 'antivirus', tableId: 'antivirus-table' },
        { sectionType: 'common_sharing', tableId: 'sharing-table' },
        { sectionType: 'security', tableId: 'security-table' },
        { sectionType: 'telecom', tableId: 'telecom-table' },
        { sectionType: 'tech_room', tableId: 'techroom-table' },
        { sectionType: 'printers', tableId: 'printers-table' },
        { sectionType: 'others', tableId: 'others-table' }
    ];
    
    sections.forEach(({ sectionType, tableId }) => {
        const table = document.getElementById(tableId);
        if (table) {
            const tbody = table.querySelector('tbody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.style.display = 'none';
                });
            }
        }
    });
}

// Function to show table rows for a specific location
function showTableRowsForLocation(location) {
    console.log('Showing table rows for location:', location);
    
    const sections = [
        { sectionType: 'network', tableId: 'internet-table' },
        { sectionType: 'server_connectivity', tableId: 'server-table' },
        { sectionType: 'antivirus', tableId: 'antivirus-table' },
        { sectionType: 'common_sharing', tableId: 'sharing-table' },
        { sectionType: 'security', tableId: 'security-table' },
        { sectionType: 'telecom', tableId: 'telecom-table' },
        { sectionType: 'tech_room', tableId: 'techroom-table' },
        { sectionType: 'printers', tableId: 'printers-table' },
        { sectionType: 'others', tableId: 'others-table' }
    ];
    
    sections.forEach(({ sectionType, tableId }) => {
        const table = document.getElementById(tableId);
        if (table) {
            const tbody = table.querySelector('tbody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.style.display = '';
                });
            }
        }
    });
}

// Function to clear dynamically added rows when location changes
function clearDynamicallyAddedRows() {
    console.log('Clearing dynamically added rows for location change...');
    
    const sections = [
        { sectionType: 'network', tableId: 'internet-table' },
        { sectionType: 'server_connectivity', tableId: 'server-table' },
        { sectionType: 'antivirus', tableId: 'antivirus-table' },
        { sectionType: 'common_sharing', tableId: 'sharing-table' },
        { sectionType: 'security', tableId: 'security-table' },
        { sectionType: 'telecom', tableId: 'telecom-table' },
        { sectionType: 'tech_room', tableId: 'techroom-table' },
        { sectionType: 'printers', tableId: 'printers-table' },
        { sectionType: 'others', tableId: 'others-table' }
    ];
    
    sections.forEach(({ sectionType, tableId }) => {
        const table = document.getElementById(tableId);
        if (table) {
            const tbody = table.querySelector('tbody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                const originalRowCount = getOriginalRowCount(sectionType);
                
                // Remove rows beyond the original count (dynamically added rows)
                for (let i = rows.length - 1; i >= originalRowCount; i--) {
                    rows[i].remove();
                }
                
                // Update row numbers
                updateRowNumbers(tableId);
            }
        }
    });
}

// Function to get the original row count for each section
function getOriginalRowCount(sectionType) {
    const originalCounts = {
        'network': 5,
        'server_connectivity': 3,
        'antivirus': 2,
        'common_sharing': 1,
        'security': 5,
        'telecom': 1,
        'tech_room': 3,
        'printers': 3,
        'others': 2
    };
    
    return originalCounts[sectionType] || 0;
}

// Function to make leased line field read-only after user moves away
function makeLeasedLineReadOnly(input) {
    if (input.value.trim() !== '') {
        input.readOnly = true;
        input.classList.add('readonly-field');
    }
}

// Function to update Primary and Secondary Internet dropdowns for Unit-3
function updateInternetDropdownsForUnit3() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
        primarySelect.innerHTML += '<option value="DSL Airtel - 136.185.18.128">DSL Airtel - 136.185.18.128</option>';
        primarySelect.innerHTML += '<option value="Spectra LL - 119.82.116.220">Spectra LL - 119.82.116.220</option>';
        primarySelect.innerHTML += '<option value="TATA LL - 14.194.137.58">TATA LL - 14.194.137.58</option>';
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
        secondarySelect.innerHTML += '<option value="DSL Airtel - 136.185.18.128">DSL Airtel - 136.185.18.128</option>';
        secondarySelect.innerHTML += '<option value="Spectra LL - 119.82.116.220">Spectra LL - 119.82.116.220</option>';
        secondarySelect.innerHTML += '<option value="TATA LL - 14.194.137.58">TATA LL - 14.194.137.58</option>';
    }
}

// Function to update Primary and Secondary Internet dropdowns for Unit-4
function updateInternetDropdownsForUnit4() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
        primarySelect.innerHTML += '<option value="DSL Airtel1 300Mbs - 136.185.18.111">DSL Airtel1 300Mbs - 136.185.18.111</option>';
        primarySelect.innerHTML += '<option value="DSL Airtel2 1Gbps - 136.185.18.113">DSL Airtel2 1Gbps - 136.185.18.113</option>';
        primarySelect.innerHTML += '<option value="Spectra LL - 180.151.69.190">Spectra LL - 180.151.69.190</option>';
        primarySelect.innerHTML += '<option value="Tata LL - 14.96.14.26">Tata LL - 14.96.14.26</option>';
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
        secondarySelect.innerHTML += '<option value="DSL Airtel1 300Mbs - 136.185.18.111">DSL Airtel1 300Mbs - 136.185.18.111</option>';
        secondarySelect.innerHTML += '<option value="DSL Airtel2 1Gbps - 136.185.18.113">DSL Airtel2 1Gbps - 136.185.18.113</option>';
        secondarySelect.innerHTML += '<option value="Spectra LL - 180.151.69.190">Spectra LL - 180.151.69.190</option>';
        secondarySelect.innerHTML += '<option value="Tata LL - 14.96.14.26">Tata LL - 14.96.14.26</option>';
    }
}

// Function to update Primary and Secondary Internet dropdowns for Unit-5
function updateInternetDropdownsForUnit5() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
        primarySelect.innerHTML += '<option value="Airtel DSL - 203.101.41.185">Airtel DSL - 203.101.41.185</option>';
        primarySelect.innerHTML += '<option value="Airtel LL - 122.186.163.10">Airtel LL - 122.186.163.10</option>';
        primarySelect.innerHTML += '<option value="Tata LL - 14.96.14.26">Tata LL - 14.96.14.26</option>';
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
        secondarySelect.innerHTML += '<option value="Airtel DSL - 203.101.41.185">Airtel DSL - 203.101.41.185</option>';
        secondarySelect.innerHTML += '<option value="Airtel LL - 122.186.163.10">Airtel LL - 122.186.163.10</option>';
        secondarySelect.innerHTML += '<option value="Tata LL - 14.96.14.26">Tata LL - 14.96.14.26</option>';
    }
}

// Function to update Primary and Secondary Internet dropdowns for GSS
function updateInternetDropdownsForGss() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
        primarySelect.innerHTML += '<option value="Spectra LL - 180.151.66.70">Spectra LL - 180.151.66.70</option>';
        primarySelect.innerHTML += '<option value="Tata LL - 14.96.218.30">Tata LL - 14.96.218.30</option>';
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
        secondarySelect.innerHTML += '<option value="Spectra LL - 180.151.66.70">Spectra LL - 180.151.66.70</option>';
        secondarySelect.innerHTML += '<option value="Tata LL - 14.96.218.30">Tata LL - 14.96.218.30</option>';
    }
}

// Function to reset Primary and Secondary Internet dropdowns to default
function resetInternetDropdowns() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
        secondarySelect.disabled = false;
    }
}

// Function to update dropdowns for Unit-1 and Unit-2 (only Primary Internet)
function updateDropdownsForUnit1And2() {
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    const location = document.getElementById('location').value;
    
    if (primarySelect) {
        primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
        
        if (location === 'unit-1') {
            // Unit-1 specific options
            primarySelect.innerHTML += '<option value="Airtel : No IP">Airtel : No IP</option>';
            primarySelect.innerHTML += '<option value="BSNL">BSNL</option>';
        } else if (location === 'unit-2') {
            // Unit-2 specific options
            primarySelect.innerHTML += '<option value="DSL : No IP">DSL : No IP</option>';
            primarySelect.innerHTML += '<option value="BSNL">BSNL</option>';
        }
    }
    
    if (secondarySelect) {
        secondarySelect.innerHTML = '<option value="">No Secondary Internet for this location</option>';
        secondarySelect.disabled = true;
    }
}

// Function to update network table rows based on dropdown selections
function updateNetworkRowsFromDropdowns() {
    const location = document.getElementById('location').value;
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    const networkTable = document.getElementById('internet-table');
    
    if (!networkTable || !primarySelect) return;
    
    const rows = networkTable.querySelectorAll('tbody tr');
    
    // For Unit-1 and Unit-2, only update the first row (Primary Internet)
    if (location === 'unit-1' || location === 'unit-2') {
        if (rows.length > 0) {
            const firstRow = rows[0];
            const leasedLineInput = firstRow.querySelector('.leased-line-input');
            
            if (leasedLineInput) {
                if (primarySelect.value) {
                    leasedLineInput.value = primarySelect.value;
                } else {
                    // Set default based on location
                    if (location === 'unit-1') {
                        leasedLineInput.value = 'Airtel : No IP';
                    } else if (location === 'unit-2') {
                        leasedLineInput.value = 'DSL : No IP';
                    }
                }
            }
        }
    } else {
        // For other units, update first 2 rows
        if (rows.length > 0) {
            const firstRow = rows[0];
            const leasedLineInput1 = firstRow.querySelector('.leased-line-input');
            
            if (leasedLineInput1) {
                if (primarySelect.value) {
                    leasedLineInput1.value = primarySelect.value;
                }
            }
        }
        
        if (rows.length > 1) {
            const secondRow = rows[1];
            const leasedLineInput2 = secondRow.querySelector('.leased-line-input');
            
            if (leasedLineInput2) {
                if (secondarySelect && secondarySelect.value && secondarySelect.value !== 'No Secondary Internet for this location') {
                    leasedLineInput2.value = secondarySelect.value;
                }
            }
        }
    }
}

// Function to filter network rows and sections based on selected location
function filterNetworkRowsByLocation(location) {
    const networkTable = document.getElementById('internet-table');
    const techRoomSection = document.querySelector('.report-section:has(#techroom-table)');
    const antivirusSection = document.querySelector('.report-section:has(#antivirus-table)');
    const sharingSection = document.querySelector('.report-section:has(#sharing-table)');
    const serverTable = document.getElementById('server-table');
    const securityTable = document.getElementById('security-table');
    const printersTable = document.getElementById('printers-table');
    const othersTable = document.getElementById('others-table');
    
    if (!networkTable) return;
    
    const rows = networkTable.querySelectorAll('tbody tr');
    
    // For unit-1 and unit-2, show only the primary network (first row) and hide Technology Room section
    if (location === 'unit-1' || location === 'unit-2') {
        rows.forEach((row, index) => {
            if (index === 0) {
                // Show primary network row
                row.style.display = '';
            } else {
                // Hide all other network rows
                row.style.display = 'none';
            }
        });
        
        // Update dropdowns for unit-1 and unit-2 (only Primary Internet, no Secondary)
        updateDropdownsForUnit1And2();
        
        // Update network table rows for unit-1 and unit-2
        updateNetworkTableForLocation(location);
        
        // Hide Technology Room section for unit-1 and unit-2
        if (techRoomSection) {
            techRoomSection.style.display = 'none';
        }
        
        // Hide Antivirus Status section for unit-1 and unit-2
        if (antivirusSection) {
            antivirusSection.style.display = 'none';
        }
        
        // Hide Common Sharing section for unit-1 and unit-2
        if (sharingSection) {
            sharingSection.style.display = 'none';
        }
        
        // Hide specific server connectivity rows for unit-1 and unit-2
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    const serverName = nameCell.textContent.trim();
                    if (serverName === 'New NAS Server status' || serverName === 'Server Room AC Status') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                }
            });
        }
        
        // Hide specific security rows for unit-1 and unit-2
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    const securityName = nameCell.textContent.trim();
                    if (securityName === 'DVR 2') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                }
            });
        }
        
        // Hide specific printer rows for unit-1 and unit-2
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    const printerName = nameCell.textContent.trim();
                    if (printerName === 'Rental Printer' || printerName === 'Accounts Printer Ip:') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                }
            });
        }
        
        // Hide specific others rows for unit-1 and unit-2
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    const itemName = nameCell.textContent.trim();
                    if (itemName === 'Reception TV Status') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = '';
                    }
                }
            });
        }
    } else if (location === 'unit-3') {
        // For unit-3, show all rows and update with specific network items
        rows.forEach((row, index) => {
            row.style.display = '';
            
            // Update network items for unit-3
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput) {
                switch(index) {
                    case 0: // First row
                        leasedLineInput.value = 'DSL Airtel - 136.185.18.128';
                        break;
                    case 1: // Second row
                        leasedLineInput.value = 'Spectra LL - 119.82.116.220';
                        break;
                    case 2: // Third row
                        leasedLineInput.value = 'TATA LL - 14.194.137.58';
                        break;
                    default:
                        // Keep other rows as they are
                        break;
                }
            }
        });
        
        // Update Primary and Secondary Internet dropdowns for Unit-3
        updateInternetDropdownsForUnit3();
        
        // Update network table rows for Unit-3
        updateNetworkTableForLocation('unit-3');
        
        // Enable secondary dropdown for Unit-3
        const secondarySelect = document.getElementById('secondaryInternet');
        if (secondarySelect) {
            secondarySelect.disabled = false;
        }
        
        // Show Technology Room section for unit-3
        if (techRoomSection) {
            techRoomSection.style.display = '';
        }
        
        // Show Antivirus Status section for unit-3
        if (antivirusSection) {
            antivirusSection.style.display = '';
        }
        
        // Show Common Sharing section for unit-3
        if (sharingSection) {
            sharingSection.style.display = '';
        }
        
        // Show all server connectivity rows for unit-3
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all security rows for unit-3
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all printer and others rows for unit-3
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach(row => {
                row.style.display = '';
            });
        }
    } else if (location === 'unit-4') {
        // For unit-4, show all rows and update with specific network items
        rows.forEach((row, index) => {
            row.style.display = '';
            
            // Update network items for unit-4
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput) {
                switch(index) {
                    case 0: // First row
                        leasedLineInput.value = 'DSL Airtel1 300Mbs - 136.185.18.111';
                        break;
                    case 1: // Second row
                        leasedLineInput.value = 'DSL Airtel2 1Gbps - 136.185.18.113';
                        break;
                    case 2: // Third row
                        leasedLineInput.value = 'Spectra LL - 180.151.69.190';
                        break;
                    case 3: // Fourth row
                        leasedLineInput.value = 'Tata LL - 14.96.14.26';
                        break;
                    default:
                        // Keep other rows as they are
                        break;
                }
            }
        });
        
        // Update Primary and Secondary Internet dropdowns for Unit-4
        updateInternetDropdownsForUnit4();
        
        // Update network table rows for Unit-4
        updateNetworkTableForLocation('unit-4');
        
        // Enable secondary dropdown for Unit-4
        const secondarySelect = document.getElementById('secondaryInternet');
        if (secondarySelect) {
            secondarySelect.disabled = false;
        }
        
        // Show Technology Room section for unit-4
        if (techRoomSection) {
            techRoomSection.style.display = '';
        }
        
        // Show Antivirus Status section for unit-4
        if (antivirusSection) {
            antivirusSection.style.display = '';
        }
        
        // Show Common Sharing section for unit-4
        if (sharingSection) {
            sharingSection.style.display = '';
        }
        
        // Show all server connectivity rows for unit-4
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all security rows for unit-4
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all printer and others rows for unit-4
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach(row => {
                row.style.display = '';
            });
        }
    } else if (location === 'unit-5') {
        // For unit-5, show all rows and update with specific network items
        rows.forEach((row, index) => {
            row.style.display = '';
            
            // Update network items for unit-5
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput) {
                switch(index) {
                    case 0: // First row
                        leasedLineInput.value = 'Airtel DSL - 203.101.41.185';
                        break;
                    case 1: // Second row
                        leasedLineInput.value = 'Airtel LL - 122.186.163.10';
                        break;
                    case 2: // Third row
                        leasedLineInput.value = 'Tata LL - 14.96.14.26';
                        break;
                    default:
                        // Keep other rows as they are
                        break;
                }
            }
        });
        
        // Update Primary and Secondary Internet dropdowns for Unit-5
        updateInternetDropdownsForUnit5();
        
        // Update network table rows for Unit-5
        updateNetworkTableForLocation('unit-5');
        
        // Enable secondary dropdown for Unit-5
        const secondarySelect = document.getElementById('secondaryInternet');
        if (secondarySelect) {
            secondarySelect.disabled = false;
        }
        
        // Show Technology Room section for unit-5
        if (techRoomSection) {
            techRoomSection.style.display = '';
        }
        
        // Show Antivirus Status section for unit-5
        if (antivirusSection) {
            antivirusSection.style.display = '';
        }
        
        // Show Common Sharing section for unit-5
        if (sharingSection) {
            sharingSection.style.display = '';
        }
        
        // Show all server connectivity rows for unit-5
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all security rows for unit-5
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all printer and others rows for unit-5
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach(row => {
                row.style.display = '';
            });
        }
    } else if (location === 'GSS') {
        // For GSS, show all rows and update with specific network items
        rows.forEach((row, index) => {
            row.style.display = '';
            
            // Update network items for GSS
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput) {
                switch(index) {
                    case 0: // First row
                        leasedLineInput.value = 'Spectra LL - 180.151.66.70';
                        break;
                    case 1: // Second row
                        leasedLineInput.value = 'Tata LL - 14.96.218.30';
                        break;
                    default:
                        // Keep other rows as they are
                        break;
                }
            }
        });
        
        // Update Primary and Secondary Internet dropdowns for GSS
        updateInternetDropdownsForGss();
        
        // Update network table rows for GSS
        updateNetworkTableForLocation('GSS');
        
        // Enable secondary dropdown for GSS
        const secondarySelect = document.getElementById('secondaryInternet');
        if (secondarySelect) {
            secondarySelect.disabled = false;
        }
        
        // Show Technology Room section for GSS
        if (techRoomSection) {
            techRoomSection.style.display = '';
        }
        
        // Show Antivirus Status section for GSS
        if (antivirusSection) {
            antivirusSection.style.display = '';
        }
        
        // Show Common Sharing section for GSS
        if (sharingSection) {
            sharingSection.style.display = '';
        }
        
        // Show all server connectivity rows for GSS
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all security rows for GSS
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all printer and others rows for GSS
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach(row => {
                row.style.display = '';
            });
        }
    } else {
        // For other locations, show all network rows with default values
        rows.forEach((row, index) => {
            row.style.display = '';
            
            // Reset to default values for other units
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput) {
                switch(index) {
                    case 0:
                        leasedLineInput.value = 'Tata Leased Line IP : XXX';
                        break;
                    case 1:
                        leasedLineInput.value = 'Airtel Internet - XXX';
                        break;
                    case 2:
                        leasedLineInput.value = 'DSL XXX';
                        break;
                    case 3:
                        leasedLineInput.value = 'BSNL XXX';
                        break;
                    case 4:
                        leasedLineInput.value = 'DSL - XXX';
                        break;
                    default:
                        break;
                }
            }
        });
        
        // Reset Primary and Secondary Internet dropdowns to default
        resetInternetDropdowns();
        
        // Enable secondary dropdown for other units
        const secondarySelect = document.getElementById('secondaryInternet');
        if (secondarySelect) {
            secondarySelect.disabled = false;
        }
        
        // Show Technology Room section for other units
        if (techRoomSection) {
            techRoomSection.style.display = '';
        }
        
        // Show Antivirus Status section for other units
        if (antivirusSection) {
            antivirusSection.style.display = '';
        }
        
        // Show Common Sharing section for other units
        if (sharingSection) {
            sharingSection.style.display = '';
        }
        
        // Show all server connectivity rows for other units
        if (serverTable) {
            const serverRows = serverTable.querySelectorAll('tbody tr');
            serverRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all security rows for other units
        if (securityTable) {
            const securityRows = securityTable.querySelectorAll('tbody tr');
            securityRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Show all printer and others rows for other units
        if (printersTable) {
            const printerRows = printersTable.querySelectorAll('tbody tr');
            printerRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        if (othersTable) {
            const othersRows = othersTable.querySelectorAll('tbody tr');
            othersRows.forEach(row => {
                row.style.display = '';
            });
        }
    }
}

// Global edit mode state
let editMode = {};

function toggleEditMode(tableId) {
    const table = document.getElementById(tableId);
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    if (!editMode[tableId]) {
        // Enter edit mode
        editMode[tableId] = true;
        table.classList.add('edit-mode');
        icon.className = 'fas fa-save';
        button.innerHTML = '<i class="fas fa-save"></i> Save';
        
        // Make cells editable
        const editableCells = table.querySelectorAll('td[contenteditable="true"]');
        editableCells.forEach(cell => {
            cell.style.backgroundColor = '#fff3cd';
            cell.style.border = '1px dashed #ffc107';
        });
        
        // Add status dropdown for status cells
        addStatusDropdowns(table);
        
    } else {
        // Save and exit edit mode
        editMode[tableId] = false;
        table.classList.remove('edit-mode');
        icon.className = 'fas fa-edit';
        button.innerHTML = '<i class="fas fa-edit"></i> Edit';
        
        // Remove editable styling
        const editableCells = table.querySelectorAll('td[contenteditable="true"]');
        editableCells.forEach(cell => {
            cell.style.backgroundColor = '';
            cell.style.border = '';
        });
        
        // Save data (you can implement AJAX call here)
        saveTableData(tableId);
    }
}

function addStatusDropdowns(table) {
    const statusCells = table.querySelectorAll('td:nth-child(4)'); // Status column
    statusCells.forEach(cell => {
        if (cell.querySelector('span')) {
            const currentStatus = cell.querySelector('span').textContent;
            const dropdown = document.createElement('select');
            dropdown.className = 'status-dropdown';
            dropdown.innerHTML = `
                <option value="Working" ${currentStatus === 'Working' ? 'selected' : ''}>Working</option>
                <option value="Not Working" ${currentStatus === 'Not Working' ? 'selected' : ''}>Not Working</option>
                <option value="Warning" ${currentStatus === 'Warning' ? 'selected' : ''}>Warning</option>
            `;
            
            dropdown.addEventListener('change', function() {
                const status = this.value;
                const statusClass = status === 'Working' ? 'status-working' : 
                                  status === 'Not Working' ? 'status-not-working' : 'status-warning';
                cell.innerHTML = `<span class="${statusClass}">${status}</span>`;
            });
            
            cell.innerHTML = '';
            cell.appendChild(dropdown);
        }
    });
}

function initializeEditableTables() {
    // Add click handlers for editable cells
    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('click', function() {
            if (editMode[this.closest('table').id]) {
                this.focus();
            }
        });
        
        cell.addEventListener('blur', function() {
            // Auto-save on blur (optional)
        });
    });
}

function saveTableData(tableId) {
    const table = document.getElementById(tableId);
    const data = [];
    
    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = {};
        row.querySelectorAll('td').forEach((cell, index) => {
            const header = table.querySelector(`thead th:nth-child(${index + 1})`).textContent;
            rowData[header] = cell.textContent.trim();
        });
        data.push(rowData);
    });
    
    // You can implement AJAX call here to save to server
    console.log('Saving data for table:', tableId, data);
    
    // For now, just show a success message
    showAlert('Data saved successfully!', 'success');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

function exportToMarkdown() {
    // Create markdown content
    let markdown = `# BOD - IT Infrastructure Status Report\n\n`;
    markdown += `**Generated on:** ${new Date().toLocaleString()}\n\n`;
    
    // Add each section
    const sections = document.querySelectorAll('.report-section');
    sections.forEach((section, index) => {
        const header = section.querySelector('.section-header').textContent.trim();
        markdown += `## ${header}\n\n`;
        
        const table = section.querySelector('.status-table');
        if (table) {
            const rows = table.querySelectorAll('tr');
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('th, td');
                if (cells.length > 0) {
                    let rowText = '| ';
                    cells.forEach(cell => {
                        rowText += cell.textContent.trim() + ' | ';
                    });
                    markdown += rowText + '\n';
                    
                    // Add header separator after first row
                    if (rowIndex === 0) {
                        let separator = '| ';
                        cells.forEach(() => {
                            separator += '--- | ';
                        });
                        markdown += separator + '\n';
                    }
                }
            });
        }
        markdown += '\n';
    });
    
    // Add questions
    markdown += `## Daily Questions\n\n`;
    const questions = document.querySelectorAll('.question-item');
    questions.forEach(question => {
        const questionText = question.querySelector('strong').textContent;
        const answerText = question.querySelector('p').textContent;
        markdown += `**${questionText}**\n${answerText}\n\n`;
    });
    
    // Create and download file
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `BOD_Report_${new Date().toISOString().split('T')[0]}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function printReport() {
    window.print();
}

// Function to update status and handle remarks
function updateStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`remarks-${rowId}`);
    const timeSpan = document.getElementById(`checked-time-${rowId}`);
    const reasonColumn = selectElement.closest('tr').querySelector('.reason-column');
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Handle Reason column visibility based on status
    if (selectedStatus === 'Not Working') {
        // Show Reason column when status is "Not Working"
        if (reasonColumn) {
            reasonColumn.style.visibility = 'visible';
            reasonColumn.style.height = 'auto';
            reasonColumn.style.padding = '';
            reasonColumn.style.border = '';
            reasonColumn.style.overflow = 'visible';
        }
    } else {
        // Hide Reason column when status is not "Not Working"
        if (reasonColumn) {
            reasonColumn.style.visibility = 'hidden';
            reasonColumn.style.height = '0';
            reasonColumn.style.padding = '0';
            reasonColumn.style.border = 'none';
            reasonColumn.style.overflow = 'hidden';
            // Reset checkbox and call number
                                   const callRaisedSelect = document.getElementById(`call-raised-${rowId}`);
                       const callNumberContainer = document.getElementById(`call-number-container-${rowId}`);
                       const callNumberInput = document.getElementById(`call-number-${rowId}`);
                       const callWarning = document.getElementById(`call-warning-${rowId}`);
                       if (callRaisedSelect) callRaisedSelect.value = '';
                       if (callNumberContainer) callNumberContainer.style.display = 'none';
                       if (callNumberInput) callNumberInput.value = '';
                       if (callWarning) callWarning.style.display = 'none';
        }
    }
    
    // Handle remarks based on status
    if (selectedStatus === 'Not Working') {
        // Don't prompt for remarks automatically - let user fill in Reason column
        // remarksInput.value = '';
    } else if (selectedStatus === 'Working') {
        // Clear remarks when status is "Working"
        remarksInput.value = '';
    } else {
        // Reset time when status is blank
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Working') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Working') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update server status and handle remarks
function updateServerStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`server-remarks-${rowId}`);
    const timeSpan = document.getElementById(`server-time-${rowId}`);
    const reasonColumn = selectElement.closest('tr').querySelector('.reason-column');
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    if (reasonColumn) {
        if (selectedStatus === 'Not Working') {
            reasonColumn.style.visibility = 'visible';
            reasonColumn.style.height = 'auto';
            reasonColumn.style.padding = '';
            reasonColumn.style.border = '';
            reasonColumn.style.overflow = 'visible';
        } else {
            reasonColumn.style.visibility = 'hidden';
            reasonColumn.style.height = '0';
            reasonColumn.style.padding = '0';
            reasonColumn.style.border = 'none';
            reasonColumn.style.overflow = 'hidden';
            const itManagerSelect = document.getElementById(`it-manager-${rowId}`);
            const itManagerWarning = document.getElementById(`it-manager-warning-${rowId}`);
            if (itManagerSelect) itManagerSelect.value = '';
            if (itManagerWarning) itManagerWarning.style.display = 'none';
        }
    }
    
    // Handle remarks based on status
    if (selectedStatus === 'Working') {
        remarksInput.value = '';
    } else if (selectedStatus === '') {
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Working') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Working') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update antivirus status and handle remarks
function updateAntivirusStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`antivirus-remarks-${rowId}`);
    const timeSpan = document.getElementById(`antivirus-time-${rowId}`);
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Handle remarks based on status
    if (selectedStatus === 'Not Updated') {
        // Prompt for remarks when status is "Not Updated"
        const remarks = prompt('Please enter remarks for the "Not Updated" status:');
        if (remarks !== null) {
            remarksInput.value = remarks;
        } else {
            // If user cancels, reset the dropdown to blank
            selectElement.value = '';
            timeSpan.textContent = '-';
            return;
        }
    } else if (selectedStatus === 'Updated') {
        // Clear remarks when status is "Updated"
        remarksInput.value = '';
    } else {
        // Reset time when status is blank
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Updated') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Updated') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update sharing status and timestamp
function updateSharingStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const timeSpan = document.getElementById(`sharing-time-${rowId}`);
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'ok') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not ok') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update sharing remarks and timestamp
function updateSharingRemarks(inputElement, rowId) {
    const remarksInput = inputElement;
    const timeSpan = document.getElementById(`sharing-time-${rowId}`);
    
    // Update the time to current time when remarks are entered
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
}

// Function to update security status and handle remarks
function updateSecurityStatus(inputElement, rowId) {
    const timeSpan = document.getElementById(`security-time-${rowId}`);
    
    // Update the time to current time when any input changes
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
}

// Function to update telecommunication status and handle remarks
function updateTelecomStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`telecom-remarks-${rowId}`);
    const timeSpan = document.getElementById(`telecom-time-${rowId}`);
    const reasonColumn = selectElement.closest('tr').querySelector('.reason-column');
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Handle dynamic reason column visibility
    if (selectedStatus === 'Not Working') {
        // Show reason column when status is "Not Working"
        reasonColumn.style.visibility = 'visible';
        reasonColumn.style.height = 'auto';
        reasonColumn.style.padding = '';
        reasonColumn.style.border = '';
        reasonColumn.style.overflow = 'visible';
    } else {
        // Hide reason column and reset its contents when status is not "Not Working"
        reasonColumn.style.visibility = 'hidden';
        reasonColumn.style.height = '0';
        reasonColumn.style.padding = '0';
        reasonColumn.style.border = 'none';
        reasonColumn.style.overflow = 'hidden';
        
        // Reset the dropdown and warning
        const itHrDropdown = document.getElementById(`telecom-it-hr-${rowId}`);
        const warningDiv = document.getElementById(`telecom-it-hr-warning-${rowId}`);
        if (itHrDropdown) {
            itHrDropdown.value = '';
        }
        if (warningDiv) {
            warningDiv.style.display = 'none';
        }
    }
    
    // Handle remarks based on status
    if (selectedStatus === 'Working') {
        // Clear remarks when status is "Working"
        remarksInput.value = '';
    } else if (selectedStatus === '') {
        // Reset time when status is blank
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Working') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Working') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update technology room status and handle remarks
function updateTechRoomStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`techroom-remarks-${rowId}`);
    const timeSpan = document.getElementById(`techroom-time-${rowId}`);
    const reasonColumn = selectElement.closest('tr').querySelector('.reason-column');
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Handle dynamic reason column visibility
    if (selectedStatus === 'Not Working') {
        // Show reason column when status is "Not Working"
        reasonColumn.style.visibility = 'visible';
        reasonColumn.style.height = 'auto';
        reasonColumn.style.padding = '';
        reasonColumn.style.border = '';
        reasonColumn.style.overflow = 'visible';
    } else {
        // Hide reason column and reset its contents when status is not "Not Working"
        reasonColumn.style.visibility = 'hidden';
        reasonColumn.style.height = '0';
        reasonColumn.style.padding = '0';
        reasonColumn.style.border = 'none';
        reasonColumn.style.overflow = 'hidden';
        
        // Reset the dropdown and warning
        const itManagerDropdown = document.getElementById(`techroom-it-manager-${rowId}`);
        const warningDiv = document.getElementById(`techroom-it-manager-warning-${rowId}`);
        if (itManagerDropdown) {
            itManagerDropdown.value = '';
        }
        if (warningDiv) {
            warningDiv.style.display = 'none';
        }
    }
    
    // Handle remarks based on status
    if (selectedStatus === 'Working') {
        // Clear remarks when status is "Working"
        remarksInput.value = '';
    } else if (selectedStatus === '') {
        // Reset time when status is blank
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Working') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Working') {
        selectElement.classList.add('status-not-working');
    }
}

// Function to update printer status and handle remarks
function updatePrinterStatus(inputElement, rowId) {
    const timeSpan = document.getElementById(`printer-time-${rowId}`);
    
    // Update the time to current time when any input changes
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // If this is a status dropdown, handle remarks
    if (inputElement.tagName === 'SELECT') {
        const selectedStatus = inputElement.value;
        const remarksInput = document.getElementById(`printer-remarks-${rowId}`);
        const reasonColumn = document.getElementById(`printer-reason-${rowId}`);
        const itManagerSelect = document.getElementById(`printer-it-manager-${rowId}`);
        const itManagerWarning = document.getElementById(`printer-it-manager-warning-${rowId}`);
        
        // Handle Reason column visibility and reset
        if (reasonColumn) {
            if (selectedStatus === 'Not Working') {
                // Show Reason column
                reasonColumn.style.visibility = 'visible';
                reasonColumn.style.height = 'auto';
                reasonColumn.style.padding = '';
                reasonColumn.style.border = '';
                reasonColumn.style.overflow = '';
            } else {
                // Hide Reason column and reset its contents
                reasonColumn.style.visibility = 'hidden';
                reasonColumn.style.height = '0';
                reasonColumn.style.padding = '0';
                reasonColumn.style.border = 'none';
                reasonColumn.style.overflow = 'hidden';
                
                // Reset dropdown and hide warning
                if (itManagerSelect) {
                    itManagerSelect.value = '';
                }
                if (itManagerWarning) {
                    itManagerWarning.style.display = 'none';
                }
            }
        }
        
        // Handle remarks based on status
        if (selectedStatus === 'Not Working') {
            // No prompt - user can type remarks directly in the input field
            // Remarks field remains editable for user to enter text
        } else if (selectedStatus === 'Working') {
            // Clear remarks when status is "Working"
            remarksInput.value = '';
        } else {
            // Reset time when status is blank
            timeSpan.textContent = '-';
            remarksInput.value = '';
        }
        
        // Update dropdown styling based on status
        inputElement.className = 'form-select status-dropdown';
        if (selectedStatus === 'Working') {
            inputElement.classList.add('status-working');
        } else if (selectedStatus === 'Not Working') {
            inputElement.classList.add('status-not-working');
        }
    }
}

// Function to update others status and handle remarks
function updateOthersStatus(selectElement, rowId) {
    const selectedStatus = selectElement.value;
    const remarksInput = document.getElementById(`others-remarks-${rowId}`);
    const timeSpan = document.getElementById(`others-time-${rowId}`);
    const reasonColumn = selectElement.closest('tr').querySelector('.reason-column');
    const itHrSelect = document.getElementById(`it-hr-${rowId}`);
    const itHrWarning = document.getElementById(`it-hr-warning-${rowId}`);
    
    // Update the time to current time
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
    });
    timeSpan.textContent = timeStr;
    
    // Handle Reason column visibility and reset
    if (reasonColumn) {
        if (selectedStatus === 'Not Working') {
            // Show Reason column
            reasonColumn.style.visibility = 'visible';
            reasonColumn.style.height = 'auto';
            reasonColumn.style.padding = '';
            reasonColumn.style.border = '';
            reasonColumn.style.overflow = '';
        } else {
            // Hide Reason column and reset its contents
            reasonColumn.style.visibility = 'hidden';
            reasonColumn.style.height = '0';
            reasonColumn.style.padding = '0';
            reasonColumn.style.border = 'none';
            reasonColumn.style.overflow = 'hidden';
            
            // Reset dropdown and hide warning
            if (itHrSelect) {
                itHrSelect.value = '';
            }
            if (itHrWarning) {
                itHrWarning.style.display = 'none';
            }
        }
    }
    
    // Handle remarks based on status
    if (selectedStatus === 'Not Working') {
        // No prompt - user can type remarks directly in the input field
        // Remarks field remains editable for user to enter text
    } else if (selectedStatus === 'Working') {
        // Clear remarks when status is "Working"
        remarksInput.value = '';
    } else {
        // Reset time when status is blank
        timeSpan.textContent = '-';
        remarksInput.value = '';
    }
    
    // Update dropdown styling based on status
    selectElement.className = 'form-select status-dropdown';
    if (selectedStatus === 'Working') {
        selectElement.classList.add('status-working');
    } else if (selectedStatus === 'Not Working') {
        selectElement.classList.add('status-not-working');
    }
}

// BOD Data Management Functions
function loadBodData() {
    console.log('Loading BOD data...');
    
    // Load BOD names from new BOD_Name table
    loadBodNames();

    // Get current location
    const currentLocation = document.getElementById('location').value;
    
    if (currentLocation && (currentLocation === 'unit-1' || currentLocation === 'unit-2' || 
        currentLocation === 'unit-3' || currentLocation === 'unit-4' || 
        currentLocation === 'unit-5' || currentLocation === 'GSS')) {
        
        console.log('Loading location-specific dropdown data for:', currentLocation);
        
        // Load both Primary and Secondary Internet options from Primary_Internet_BOD table
        loadPrimaryInternetBodData(currentLocation);
            
    } else {
        // Fallback to generic bod_data table for non-location-specific cases
        console.log('Loading generic dropdown data');

    // Load both Primary and Secondary Internet options from Primary_Internet_BOD table
    // For non-location-specific cases, we'll still use the generic approach
    // Load primary internet options
            fetch('/it/api/bod-data/primary_internet')
        .then(response => {
            console.log('Primary internet response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Primary internet data:', data);
            if (data.success) {
                const primarySelect = document.getElementById('primaryInternet');
                primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
                const secondarySelect = document.getElementById('secondaryInternet');
                secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
                
                data.data.forEach(item => {
                    console.log('Processing primary internet item:', item);
                    // Add to Primary Internet dropdown
                    const primaryOption = document.createElement('option');
                    primaryOption.value = item.value;
                    primaryOption.textContent = item.value;
                    primaryOption.dataset.id = item.id;
                    primarySelect.appendChild(primaryOption);
                    
                    // Add to Secondary Internet dropdown
                    const secondaryOption = document.createElement('option');
                    secondaryOption.value = item.value;
                    secondaryOption.textContent = item.value;
                    secondaryOption.dataset.id = item.id;
                    secondarySelect.appendChild(secondaryOption);
                });
            } else {
                console.error('Failed to load primary internet:', data.error);
            }
        })
        .catch(error => console.error('Error loading primary internet options:', error));
    }
    
    // After loading internet options, initialize Tata Leased Line rows
    setTimeout(() => {
        initializeTataLeasedLineRows();
    }, 500);
    
    // Synchronize network table with common dropdown items
    setTimeout(() => {
        synchronizeNetworkTableWithCommonItems();
    }, 300);
}

// Function to synchronize network table with dropdown selections and reorder
function synchronizeNetworkTableWithCommonItems() {
    console.log('Synchronizing network table with dropdown selections...');
    
    const primarySelect = document.getElementById('primaryInternet');
    const secondarySelect = document.getElementById('secondaryInternet');
    const locationSelect = document.getElementById('location');
    
    if (!primarySelect || !secondarySelect) {
        console.error('Primary or Secondary Internet dropdowns not found');
        return;
    }
    
    const selectedLocation = locationSelect ? locationSelect.value : '';
    console.log('Selected location:', selectedLocation);
    
    // Only proceed if a location is selected
    if (!selectedLocation) {
        console.log('No location selected, skipping network table synchronization');
        return;
    }
    
    // Special handling for unit-1 and unit-2
    if (selectedLocation === 'unit-1' || selectedLocation === 'unit-2') {
        updateNetworkTableForUnit12(primarySelect.value);
        return;
    }
    
    // Get all available items from both dropdowns (combined unique list)
    const primaryItems = Array.from(primarySelect.options)
        .map(option => option.value)
        .filter(value => value !== ''); // Exclude empty/placeholder options
    
    const secondaryItems = Array.from(secondarySelect.options)
        .map(option => option.value)
        .filter(value => value !== ''); // Exclude empty/placeholder options
    
    // Get selected values
    const primarySelected = primarySelect.value;
    const secondarySelected = secondarySelect.value;
    
    console.log('Primary Internet items:', primaryItems);
    console.log('Secondary Internet items:', secondaryItems);
    console.log('Primary selected:', primarySelected);
    console.log('Secondary selected:', secondarySelected);
    
    // Create combined list of all unique items
    const allItems = [...new Set([...primaryItems, ...secondaryItems])];
    console.log('All unique items:', allItems);
    
    // Reorder items based on selections
    const reorderedItems = reorderItemsBySelection(allItems, primarySelected, secondarySelected);
    console.log('Reordered items:', reorderedItems);
    
    // Update network table with reordered items
    updateNetworkTableWithReorderedItems(reorderedItems, primarySelected, secondarySelected);
}

// Function to reorder items based on dropdown selections
function reorderItemsBySelection(allItems, primarySelected, secondarySelected) {
    const reorderedItems = [];
    
    // Add primary selected item first (if any)
    if (primarySelected && allItems.includes(primarySelected)) {
        reorderedItems.push(primarySelected);
    }
    
    // Add secondary selected item second (if any and different from primary)
    if (secondarySelected && allItems.includes(secondarySelected) && secondarySelected !== primarySelected) {
        reorderedItems.push(secondarySelected);
    }
    
    // Add remaining items in original order
    allItems.forEach(item => {
        if (item !== primarySelected && item !== secondarySelected) {
            reorderedItems.push(item);
        }
    });
    
    return reorderedItems;
}

// Function to update network table with reordered items
function updateNetworkTableWithReorderedItems(reorderedItems, primarySelected, secondarySelected) {
    const tbody = document.querySelector('#internet-table tbody');
    if (!tbody) {
        console.error('Network table tbody not found');
        return;
    }
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add rows for each item in reordered sequence
    reorderedItems.forEach((item, index) => {
        const newRow = document.createElement('tr');
        
        // Determine link type based on selection
        let linkType = '';
        let linkCell = '';
        
        if (item === primarySelected) {
            linkType = 'Primary';
            linkCell = `<input type="text" class="form-control" value="Primary" readonly>`;
        } else if (item === secondarySelected) {
            linkType = 'Secondary';
            linkCell = `<input type="text" class="form-control" value="Secondary" readonly>`;
        } else {
            linkCell = `
                <select class="form-control">
                    <option value="">Select Link</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                </select>
            `;
        }
        
        newRow.innerHTML = `
            <td>
                <input type="text" class="form-control" value="${index + 1}" readonly>
            </td>
            <td>
                <input type="text" class="form-control" value="${item}" readonly>
            </td>
            <td>
                ${linkCell}
            </td>
            <td>
                <select class="form-control status-select" onchange="handleStatusChange(this)">
                    <option value="">Select Status</option>
                    <option value="Working">Working</option>
                    <option value="Not Working">Not Working</option>
                </select>
            </td>
            <td>
                <div class="reason-container">
                    <select class="form-control reason-select" onchange="handleReasonChange(this)" style="display: none;">
                        <option value="">Select Reason</option>
                        <option value="Call Raised: Yes">Call Raised: Yes</option>
                        <option value="Call Raised: No">Call Raised: No</option>
                    </select>
                    <input type="text" class="form-control call-number-input" placeholder="Enter call number" style="display: none;">
                    <div class="call-message" style="display: none; color: red; font-weight: bold;">Please rise the call</div>
                </div>
            </td>
            <td>
                <input type="text" class="form-control" placeholder="Remarks">
            </td>
            <td>
                <input type="text" class="form-control" value="-" readonly>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this, 'internet')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
    });
    
    console.log(`Network table updated with ${reorderedItems.length} items (reordered by selection priority)`);
}

// Function to update network table for unit-1 and unit-2 (single row)
function updateNetworkTableForUnit12(primarySelected) {
    const tbody = document.querySelector('#internet-table tbody');
    if (!tbody) {
        console.error('Network table tbody not found');
        return;
    }
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Create single row for unit-1 and unit-2
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <input type="text" class="form-control" value="1" readonly>
        </td>
        <td>
            <input type="text" class="form-control" value="${primarySelected || ''}" readonly>
        </td>
        <td>
            <input type="text" class="form-control" value="Primary" readonly>
        </td>
        <td>
            <select class="form-control status-select" onchange="handleStatusChange(this)">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td>
            <div class="reason-container">
                <select class="form-control reason-select" onchange="handleReasonChange(this)" style="display: none;">
                    <option value="">Select Reason</option>
                    <option value="Call Raised: Yes">Call Raised: Yes</option>
                    <option value="Call Raised: No">Call Raised: No</option>
                </select>
                <input type="text" class="form-control call-number-input" placeholder="Enter call number" style="display: none;">
                <div class="call-message" style="display: none; color: red; font-weight: bold;">Please rise the call</div>
            </div>
        </td>
        <td>
            <input type="text" class="form-control" placeholder="Remarks">
        </td>
        <td>
            <input type="text" class="form-control" value="-" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this, 'internet')">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(newRow);
    
    console.log(`Network table updated for unit-1/unit-2 with primary selection: ${primarySelected}`);
}

// Function to handle status change in network table
function handleStatusChange(statusSelect) {
    const row = statusSelect.closest('tr');
    const reasonContainer = row.querySelector('.reason-container');
    const reasonSelect = reasonContainer.querySelector('.reason-select');
    const callNumberInput = reasonContainer.querySelector('.call-number-input');
    const callMessage = reasonContainer.querySelector('.call-message');
    
    // Auto-update Checked Time when status is "Working" or "Not Working"
    if (statusSelect.value === 'Working' || statusSelect.value === 'Not Working') {
        // Find the Checked Time input (7th column, last readonly input in the row)
        const inputs = row.querySelectorAll('input[readonly]');
        const checkedTimeInput = inputs[inputs.length - 1]; // Last readonly input should be Checked Time
        
        if (checkedTimeInput) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            checkedTimeInput.value = timeString;
            console.log(`Updated Checked Time for row to: ${timeString}`);
        } else {
            console.error('Checked Time input not found in row');
        }
    }
    
    if (statusSelect.value === 'Not Working') {
        // Show reason dropdown for "Not Working" status
        reasonSelect.style.display = 'block';
        callNumberInput.style.display = 'none';
        callMessage.style.display = 'none';
        reasonSelect.value = ''; // Reset reason selection
    } else {
        // Hide reason elements for "Working" or empty status
        reasonSelect.style.display = 'none';
        callNumberInput.style.display = 'none';
        callMessage.style.display = 'none';
        reasonSelect.value = '';
        callNumberInput.value = '';
    }
}

// Function to handle reason change in network table
function handleReasonChange(reasonSelect) {
    const row = reasonSelect.closest('tr');
    const callNumberInput = row.querySelector('.call-number-input');
    const callMessage = row.querySelector('.call-message');
    
    if (reasonSelect.value === 'Call Raised: Yes') {
        // Show call number input for "Yes"
        callNumberInput.style.display = 'block';
        callMessage.style.display = 'none';
        callNumberInput.value = ''; // Clear previous value
        callNumberInput.focus(); // Focus on input
    } else if (reasonSelect.value === 'Call Raised: No') {
        // Show message for "No"
        callNumberInput.style.display = 'none';
        callMessage.style.display = 'block';
        callNumberInput.value = '';
    } else {
        // Hide both for empty selection
        callNumberInput.style.display = 'none';
        callMessage.style.display = 'none';
        callNumberInput.value = '';
    }
}

// Function to validate network table before saving
function validateNetworkTable() {
    const rows = document.querySelectorAll('#internet-table tbody tr');
    let isValid = true;
    let errorMessage = '';
    
    rows.forEach((row, index) => {
        const statusSelect = row.querySelector('.status-select');
        const reasonSelect = row.querySelector('.reason-select');
        const callNumberInput = row.querySelector('.call-number-input');
        
        if (statusSelect.value === 'Not Working') {
            if (!reasonSelect.value) {
                isValid = false;
                errorMessage += `Row ${index + 1}: Please select whether call is raised or not.\n`;
            } else if (reasonSelect.value === 'Call Raised: Yes' && !callNumberInput.value.trim()) {
                isValid = false;
                errorMessage += `Row ${index + 1}: Please enter the call number.\n`;
            } else if (reasonSelect.value === 'Call Raised: No') {
                isValid = false;
                errorMessage += `Row ${index + 1}: Please rise the call before saving.\n`;
            }
        }
    });
    
    if (!isValid) {
        alert('Validation Error:\n' + errorMessage);
        return false;
    }
    
    return true;
}

// Function to delete dropdown item
function deleteDropdownItem(dropdownType) {
    const location = document.getElementById('location').value;
    const dropdownSelect = document.getElementById(dropdownType === 'primary_internet' ? 'primaryInternet' : 'secondaryInternet');
    const selectedValue = dropdownSelect.value;
    
    if (!selectedValue) {
        showAlert('Please select an item to delete', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete "${selectedValue}" from ${location} ${dropdownType.replace('_', ' ')} dropdown?`)) {
        return;
    }
    
    console.log(`Deleting ${selectedValue} from ${location} ${dropdownType}`);
    
            fetch(`/it/api/location-dropdown-data/${location}/${dropdownType}/${encodeURIComponent(selectedValue)}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Reload dropdown data from location-specific table
            loadBodData();
            // Then synchronize network table with common items
            setTimeout(() => {
                synchronizeNetworkTableWithCommonItems();
            }, 300);
        } else {
            showAlert(data.error || 'Failed to delete item', 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting dropdown item:', error);
        showAlert('Error deleting item: ' + error.message, 'danger');
    });
}

function addBodData(dataType) {
    let label = '';
    let placeholder = '';
    
    switch(dataType) {
        case 'name':
            label = 'BOD Name';
            placeholder = 'Enter new BOD name';
            break;
        case 'primary_internet':
            label = 'Primary Internet';
            placeholder = 'Enter new primary internet option';
            break;
        case 'secondary_internet':
            label = 'Secondary Internet';
            placeholder = 'Enter new secondary internet option';
            break;
    }
    
    const newValue = prompt(`Enter new ${label}:`, '');
    if (newValue && newValue.trim()) {
        const currentLocation = document.getElementById('location').value;
        
        // For internet options with location-specific tables
        if ((dataType === 'primary_internet' || dataType === 'secondary_internet') && 
            currentLocation && (currentLocation === 'unit-1' || currentLocation === 'unit-2' || 
            currentLocation === 'unit-3' || currentLocation === 'unit-4' || 
            currentLocation === 'unit-5' || currentLocation === 'GSS')) {
            
            console.log(`Adding ${dataType} to location-specific table for ${currentLocation}`);
            console.log(`Will add to BOTH Primary and Secondary Internet dropdowns: ${newValue.trim()}`);
            
            // Add to location-specific table
            fetch(`/it/api/location-dropdown-data/${currentLocation}/${dataType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    value: newValue.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // Reload dropdown data from location-specific table first
                    loadBodData();
                    // Also reload BOD names
                    loadBodNames();
                    // Then synchronize network table with common items
                    setTimeout(() => {
                        synchronizeNetworkTableWithCommonItems();
                    }, 300);
                } else {
                    showAlert(data.error || `Failed to add ${label}`, 'danger');
                }
            })
            .catch(error => {
                console.error(`Error adding ${dataType}:`, error);
                showAlert(`Error adding ${label}: ${error.message}`, 'danger');
            });
            
        } else {
            // For names or non-location-specific cases, use the original bod_data table
        fetch('/it/api/bod-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: dataType,
                value: newValue.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                    showAlert(`${label} added successfully!`, 'success');
                    loadBodData();
                    // Also reload BOD names if it's a name operation
                    if (dataType === 'name') {
                        loadBodNames();
                    }
            } else {
                    showAlert(data.error || `Failed to add ${label}`, 'danger');
            }
        })
        .catch(error => {
                console.error(`Error adding ${dataType}:`, error);
                showAlert(`Error adding ${label}: ${error.message}`, 'danger');
        });
        }
    }
}

// New functions for Primary Internet BOD management
function addPrimaryInternetBod() {
    const currentLocation = document.getElementById('location').value;
    
    if (!currentLocation) {
        showAlert('Please select a location first', 'warning');
        return;
    }
    
    const newValue = prompt('Enter new Primary Internet option:');
    if (newValue && newValue.trim()) {
        console.log(`Adding Primary Internet option to ${currentLocation}: ${newValue.trim()}`);
        
        fetch(`/it/api/primary-internet-bod/${currentLocation}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newValue.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Reload both Primary and Secondary Internet dropdowns
                loadPrimaryInternetBodData(currentLocation);
                // Then synchronize network table
                setTimeout(() => {
                    synchronizeNetworkTableWithCommonItems();
                }, 300);
            } else {
                showAlert(data.error || 'Failed to add Primary Internet option', 'danger');
            }
        })
        .catch(error => {
            console.error('Error adding Primary Internet option:', error);
            showAlert('Error adding Primary Internet option: ' + error.message, 'danger');
        });
    }
}

function deletePrimaryInternetBod() {
    const currentLocation = document.getElementById('location').value;
    const primarySelect = document.getElementById('primaryInternet');
    const selectedValue = primarySelect.value;
    
    if (!currentLocation) {
        showAlert('Please select a location first', 'warning');
        return;
    }
    
    if (!selectedValue) {
        showAlert('Please select a Primary Internet option to delete', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete "${selectedValue}" from ${currentLocation} Primary Internet dropdown?`)) {
        return;
    }
    
    console.log(`Deleting Primary Internet option from ${currentLocation}: ${selectedValue}`);
    
    fetch(`/it/api/primary-internet-bod/${currentLocation}/${encodeURIComponent(selectedValue)}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Reload both Primary and Secondary Internet dropdowns
                loadPrimaryInternetBodData(currentLocation);
                // Then synchronize network table
                setTimeout(() => {
                    synchronizeNetworkTableWithCommonItems();
                }, 300);
            } else {
            showAlert(data.error || 'Failed to delete Primary Internet option', 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting Primary Internet option:', error);
        showAlert('Error deleting Primary Internet option: ' + error.message, 'danger');
    });
}

function loadPrimaryInternetBodData(location) {
    if (!location) return;
    
    fetch(`/it/api/primary-internet-bod/${location}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate Primary Internet dropdown
                const primarySelect = document.getElementById('primaryInternet');
                primarySelect.innerHTML = '<option value="">Select Primary Internet</option>';
                
                // Populate Secondary Internet dropdown with same data
                const secondarySelect = document.getElementById('secondaryInternet');
                secondarySelect.innerHTML = '<option value="">Select Secondary Internet</option>';
                
                data.data.forEach(item => {
                    // Create option for Primary Internet
                    const primaryOption = document.createElement('option');
                    primaryOption.value = item.Name;
                    primaryOption.textContent = item.Name;
                    primaryOption.dataset.id = item.id;
                    primarySelect.appendChild(primaryOption);
                    
                    // Create option for Secondary Internet
                    const secondaryOption = document.createElement('option');
                    secondaryOption.value = item.Name;
                    secondaryOption.textContent = item.Name;
                    secondaryOption.dataset.id = item.id;
                    secondarySelect.appendChild(secondaryOption);
                });
                
                // After populating dropdowns, refresh the network table for the current location
                setTimeout(() => {
                    const currentLocation = document.getElementById('location').value;
                    if (currentLocation === location) {
                        updateNetworkTableForLocation(location);
                    }
                }, 100);
            } else {
                console.error('Failed to load Primary Internet BOD data:', data.error);
            }
        })
        .catch(error => console.error('Error loading Primary Internet BOD data:', error));
}

// BOD Name management functions
function addBodName() {
    const newValue = prompt('Enter new BOD name:');
    if (newValue && newValue.trim()) {
        console.log(`Adding new BOD name: ${newValue.trim()}`);
        
        fetch('/it/api/bod-name', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newValue.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Reload BOD Name dropdown
                loadBodNames();
            } else {
                showAlert(data.error || 'Failed to add BOD name', 'danger');
            }
        })
        .catch(error => {
            console.error('Error adding BOD name:', error);
            showAlert('Error adding BOD name: ' + error.message, 'danger');
        });
    }
}

function deleteBodName() {
    const nameSelect = document.getElementById('name');
    const selectedValue = nameSelect.value;
    
    if (!selectedValue) {
        showAlert('Please select a BOD name to delete', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete "${selectedValue}"?`)) {
        return;
    }
    
    console.log(`Deleting BOD name: ${selectedValue}`);
    
    fetch(`/it/api/bod-name/${encodeURIComponent(selectedValue)}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Reload BOD Name dropdown
            loadBodNames();
        } else {
            showAlert(data.error || 'Failed to delete BOD name', 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting BOD name:', error);
        showAlert('Error deleting BOD name: ' + error.message, 'danger');
    });
}

function loadBodNames() {
    fetch('/it/api/bod-name')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const nameSelect = document.getElementById('name');
                nameSelect.innerHTML = '<option value="">Select your name</option>';
                data.data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.BOD_Name_Data;
                    option.textContent = item.BOD_Name_Data;
                    option.dataset.id = item.id;
                    nameSelect.appendChild(option);
                });
            } else {
                console.error('Failed to load BOD names:', data.error);
            }
        })
        .catch(error => console.error('Error loading BOD names:', error));
}

function removeBodData(dataType) {
    let selectElement;
    let label = '';
    
    switch(dataType) {
        case 'name':
            selectElement = document.getElementById('name');
            label = 'BOD Name';
            break;
        case 'primary_internet':
            selectElement = document.getElementById('primaryInternet');
            label = 'Primary Internet';
            break;
        case 'secondary_internet':
            selectElement = document.getElementById('secondaryInternet');
            label = 'Secondary Internet';
            break;
    }
    
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (!selectedOption || !selectedOption.dataset.id) {
        showAlert(`Please select a ${label} to remove`, 'warning');
        return;
    }
    
    const dataId = selectedOption.dataset.id;
    const value = selectedOption.value;
    
    if (confirm(`Are you sure you want to remove "${value}" from ${label}?`)) {
        fetch(`/api/bod-data/${dataId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Data removed successfully!', 'success');
                loadBodData(); // Reload the dropdowns
            } else {
                showAlert(data.error || 'Failed to remove data', 'danger');
            }
        })
        .catch(error => {
            console.error('Error removing data:', error);
            showAlert('Error removing data', 'danger');
        });
    }
}

// Function to update row numbers after adding/removing rows
function updateRowNumbers(tableId) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
    });
}

// Function to add new row to different sections
function addNewRow(sectionType) {
    let tableId, rowTemplate;
    
    switch(sectionType) {
        case 'network':
            tableId = 'internet-table';
            rowTemplate = createNetworkRow();
            break;
        case 'server_connectivity':
            tableId = 'server-table';
            rowTemplate = createServerRow();
            break;
        case 'antivirus':
            tableId = 'antivirus-table';
            rowTemplate = createAntivirusRow();
            break;
        case 'common_sharing':
            tableId = 'sharing-table';
            rowTemplate = createSharingRow();
            break;
        case 'security':
            tableId = 'security-table';
            rowTemplate = createSecurityRow();
            break;
        case 'telecom':
            tableId = 'telecom-table';
            rowTemplate = createTelecomRow();
            break;
        case 'tech_room':
            tableId = 'techroom-table';
            rowTemplate = createTechRoomRow();
            break;
        case 'printers':
            tableId = 'printers-table';
            rowTemplate = createPrinterRow();
            break;
        case 'others':
            tableId = 'others-table';
            rowTemplate = createOthersRow();
            break;
        default:
            showAlert('Unknown section type', 'danger');
            return;
    }
    
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = rowTemplate;
    
    // Apply role-based editing restrictions
    applyRoleBasedEditing(newRow);
    
    // Add event listeners for automatic localStorage updates
    const inputs = newRow.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            updateLocalStorageOnChange(sectionType, newRow);
        });
        input.addEventListener('blur', () => {
            updateLocalStorageOnChange(sectionType, newRow);
        });
    });
    
    // Update row numbers
    updateRowNumbers(tableId);
    
    // Save the new row to localStorage for persistence
    saveNewRowToLocalStorage(sectionType, newRow);
    
    // If this is a printer row, update yesterday's readings
    if (sectionType === 'printers') {
        updateYesterdayReadingsForNewRows();
    }
    
    showAlert('New row added successfully!', 'success');
}

// Function to save new row to localStorage for persistence
function saveNewRowToLocalStorage(sectionType, row) {
    const currentLocation = document.getElementById('location').value;
    const rowData = {
        sectionType: sectionType,
        location: currentLocation,
        timestamp: Date.now(),
        fields: {}
    };
    
    // Get all input values from the row with proper field identification
    const inputs = row.querySelectorAll('input, select');
    inputs.forEach((input, index) => {
        let fieldKey = '';
        
        // Determine field type based on input attributes and position
        if (input.classList.contains('leased-line-input')) {
            fieldKey = 'leased_line';
        } else if (input.classList.contains('second-column-input')) {
            fieldKey = 'second_column';
        } else if (input.classList.contains('link-select')) {
            fieldKey = 'link';
        } else if (input.classList.contains('status-dropdown')) {
            fieldKey = 'status';
        } else if (input.classList.contains('remarks-input')) {
            fieldKey = 'remarks';
        } else if (input.classList.contains('call-number-input')) {
            fieldKey = 'call_number';
        } else if (input.classList.contains('reason-dropdown')) {
            fieldKey = 'reason';
        } else if (input.id && input.id.startsWith('telecom-it-hr-')) {
            fieldKey = 'telecom_reason';
        } else if (input.id && input.id.startsWith('techroom-it-manager-')) {
            fieldKey = 'techroom_reason';
        } else {
            // Fallback to index-based key
            fieldKey = `field_${index}`;
        }
        
        // Only save S.No and Name fields, clear all other fields on refresh
        if (fieldKey === 'sno' || fieldKey === 'second_column' || fieldKey === 'leased_line') {
            if (input.type === 'text' || input.type === 'number') {
                rowData.fields[fieldKey] = input.value || '';
            } else if (input.tagName === 'SELECT') {
                rowData.fields[fieldKey] = input.value || '';
            }
        } else {
            // Clear all other fields (Status, Reason, Remarks, etc.)
            rowData.fields[fieldKey] = '';
        }
    });
    
    // Get existing rows from localStorage for this location
    const storageKey = `bod_${sectionType}_rows_${currentLocation}`;
    const existingRows = JSON.parse(localStorage.getItem(storageKey) || '[]');
    existingRows.push(rowData);
    
    // Save back to localStorage with location-specific key
    localStorage.setItem(storageKey, JSON.stringify(existingRows));
    
    console.log(`Row saved to localStorage for section: ${sectionType} in location: ${currentLocation}`);
    console.log('Row data:', rowData);
}



// Function to add a new row to the Network table
function addNetworkRow(leasedLine) {
    console.log('Adding new network row:', leasedLine);
    
    const tbody = document.querySelector('#internet-table tbody');
    if (!tbody) {
        console.error('Network table tbody not found');
        console.log('Available tables:', document.querySelectorAll('table'));
        return;
    }
    
    console.log('Found network table tbody, current rows:', tbody.querySelectorAll('tr').length);
    
    // Get the next S.No
    const existingRows = tbody.querySelectorAll('tr');
    const nextSno = existingRows.length + 1;
    
    // Create new row
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <input type="text" class="form-control" value="${nextSno}" readonly>
        </td>
        <td>
            <input type="text" class="form-control" value="${leasedLine}" readonly>
        </td>
        <td>
            <select class="form-control">
                <option value="">Select Link</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
            </select>
        </td>
        <td>
            <select class="form-control">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td>
            <select class="form-control">
                <option value="">Select Reason</option>
                <option value="Inform to IT Manager: Yes">Inform to IT Manager: Yes</option>
                <option value="Inform to IT Manager: No">Inform to IT Manager: No</option>
                <option value="Inform to IT Manager: Pending">Inform to IT Manager: Pending</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control" placeholder="Remarks">
        </td>
        <td>
            <input type="text" class="form-control" value="-" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this, 'internet')">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    // Add the new row to the table
    tbody.appendChild(newRow);
    console.log('New network row added successfully');
    
    // Save to database
    saveNetworkRowToDatabase(newRow, leasedLine);
}

// Function to save network row to database
function saveNetworkRowToDatabase(row, leasedLine) {
    const location = document.getElementById('location').value;
    const rowData = {
        location: location,
        sno: row.querySelector('td:nth-child(1) input').value,
        leased_line: leasedLine,
        link: row.querySelector('td:nth-child(3) select').value,
        status: row.querySelector('td:nth-child(4) select').value,
        reason: row.querySelector('td:nth-child(5) select').value,
        remarks: row.querySelector('td:nth-child(6) input').value,
        checked_time: row.querySelector('td:nth-child(7) input').value
    };
    
    console.log('Saving network row to database:', rowData);
    
            fetch('/it/api/save-network-row', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(rowData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Network row saved to database successfully:', data.message);
            // Also save to localStorage for immediate access
            saveNetworkRowToLocalStorage(row, leasedLine);
        } else {
            console.error('Failed to save network row to database:', data.error);
            showAlert('Failed to save network row: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving network row to database:', error);
        showAlert('Error saving network row: ' + error.message, 'danger');
    });
}

// Function to save network row to localStorage (for immediate access)
function saveNetworkRowToLocalStorage(row, leasedLine) {
    const rowData = {
        sno: row.querySelector('td:nth-child(1) input').value,
        leased_line: leasedLine,
        link: row.querySelector('td:nth-child(3) select').value,
        status: row.querySelector('td:nth-child(4) select').value,
        reason: row.querySelector('td:nth-child(5) select').value,
        remarks: row.querySelector('td:nth-child(6) input').value,
        checked_time: row.querySelector('td:nth-child(7) input').value
    };
    
    // Get existing rows from localStorage
    let existingRows = JSON.parse(localStorage.getItem('bod_internet_rows') || '[]');
    
    // Add new row data
    existingRows.push(rowData);
    
    // Save back to localStorage
    localStorage.setItem('bod_internet_rows', JSON.stringify(existingRows));
    console.log('Network row saved to localStorage:', rowData);
}

// Function to update network table rows based on selected location
function updateNetworkTableForLocation(location) {
    console.log(`Updating network table for location: ${location}`);
    
    const networkTable = document.getElementById('internet-table');
    if (!networkTable) return;
    
    const tbody = networkTable.querySelector('tbody');
    if (!tbody) return;
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    let networkItems = [];
    
    // Define network items for each location
    switch(location) {
        case 'unit-1':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectUnit1 = document.getElementById('primaryInternet');
            console.log('Unit-1: Primary Internet dropdown found:', !!primaryInternetSelectUnit1);
            if (primaryInternetSelectUnit1) {
                console.log('Unit-1: Primary Internet dropdown options count:', primaryInternetSelectUnit1.options.length);
                console.log('Unit-1: Primary Internet dropdown options:', Array.from(primaryInternetSelectUnit1.options).map(opt => opt.value));
            }
            
            if (primaryInternetSelectUnit1 && primaryInternetSelectUnit1.options.length > 1) {
                const options = Array.from(primaryInternetSelectUnit1.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for Unit-1 based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                console.log('Unit-1: Using fallback hardcoded values (dropdown not populated yet)');
                networkItems = [
                    { sno: '1', leased_line: 'Airtel : No IP', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'BSNL', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        case 'unit-2':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectUnit2 = document.getElementById('primaryInternet');
            if (primaryInternetSelectUnit2 && primaryInternetSelectUnit2.options.length > 1) {
                const options = Array.from(primaryInternetSelectUnit2.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for Unit-2 based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'DSL : No IP', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'BSNL', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        case 'unit-3':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelect = document.getElementById('primaryInternet');
            if (primaryInternetSelect && primaryInternetSelect.options.length > 1) {
                const options = Array.from(primaryInternetSelect.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for Unit-3 based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'DSL Airtel - 136.185.18.128', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'Spectra LL - 119.82.116.220', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '3', leased_line: 'TATA LL - 14.194.137.58', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '4', leased_line: 'BSNL', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '5', leased_line: 'MM', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        case 'unit-4':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectUnit4 = document.getElementById('primaryInternet');
            if (primaryInternetSelectUnit4 && primaryInternetSelectUnit4.options.length > 1) {
                const options = Array.from(primaryInternetSelectUnit4.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for Unit-4 based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'DSL Airtel1 300Mbs - 136.185.18.111', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'DSL Airtel2 1Gbps - 136.185.18.113', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '3', leased_line: 'Spectra LL - 180.151.69.190', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '4', leased_line: 'Tata LL - 14.96.14.26', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        case 'unit-5':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectUnit5 = document.getElementById('primaryInternet');
            if (primaryInternetSelectUnit5 && primaryInternetSelectUnit5.options.length > 1) {
                const options = Array.from(primaryInternetSelectUnit5.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for Unit-5 based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'Spectra LL - 180.151.66.70', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'Tata LL - 14.96.218.30', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        case 'GSS':
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectGSS = document.getElementById('primaryInternet');
            if (primaryInternetSelectGSS && primaryInternetSelectGSS.options.length > 1) {
                const options = Array.from(primaryInternetSelectGSS.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for GSS based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'Spectra LL - 180.151.66.70', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'Tata LL - 14.96.218.30', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
        default:
            // Try to get dynamic options from Primary Internet dropdown first
            const primaryInternetSelectDefault = document.getElementById('primaryInternet');
            if (primaryInternetSelectDefault && primaryInternetSelectDefault.options.length > 1) {
                const options = Array.from(primaryInternetSelectDefault.options)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Exclude empty/placeholder options
                
                console.log(`Creating dynamic network rows for default case based on Primary Internet options:`, options);
                
                networkItems = options.map((option, index) => ({
                    sno: (index + 1).toString(),
                    leased_line: option,
                    link: index === 0 ? 'Primary' : 'Secondary', // First option is Primary, rest are Secondary
                    status: '',
                    reason: '',
                    remarks: '',
                    checked_time: '-'
                }));
            } else {
                // Fallback to hardcoded values if dropdown not populated yet
                networkItems = [
                    { sno: '1', leased_line: 'DSL Airtel - 136.185.18.128', link: 'Primary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '2', leased_line: 'Spectra LL - 119.82.116.220', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '3', leased_line: 'TATA LL - 14.194.137.58', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' },
                    { sno: '4', leased_line: 'BSNL', link: 'Secondary', status: '', reason: '', remarks: '', checked_time: '-' }
                ];
            }
            break;
    }
    
    // Add rows to the table
    networkItems.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${item.sno}</td>
            <td><input type="text" class="form-control leased-line-input" value="${item.leased_line}" readonly></td>
            <td>
                <select class="form-control link-select">
                    <option value="Primary" ${item.link === 'Primary' ? 'selected' : ''}>Primary</option>
                    <option value="Secondary" ${item.link === 'Secondary' ? 'selected' : ''}>Secondary</option>
                </select>
            </td>
            <td>
                <select class="form-control status-dropdown">
                    <option value="">Select Status</option>
                    <option value="Working">Working</option>
                    <option value="Not Working">Not Working</option>
                </select>
            </td>
            <td>
                <input type="text" class="form-control" placeholder="Enter reason if needed">
            </td>
            <td>
                <input type="text" class="form-control remarks-input" placeholder="Enter remarks if needed" value="${item.remarks}">
            </td>
            <td>
                <span class="checked-time">${item.checked_time}</span>
            </td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteRow(this, 'network')" title="Delete Row">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    
    console.log(`Updated network table with ${networkItems.length} rows for ${location}`);
}

// Function to manually clear problematic rows (for debugging)
function clearProblematicRows() {
    console.log('Clearing problematic rows...');
    
    // Clear the specific "DSL - XXX" row from network section
    const networkRows = JSON.parse(localStorage.getItem('bod_network_rows') || '[]');
    const filteredRows = networkRows.filter(row => !(row.leased_line === 'DSL - XXX' && row.sno === '5'));
    localStorage.setItem('bod_network_rows', JSON.stringify(filteredRows));
    
    // Add deletion markers
    localStorage.setItem('deleted_network_5_DSL - XXX', 'deleted');
    
    console.log('Cleared problematic rows. Please refresh the page.');
    alert('Problematic rows cleared. Please refresh the page.');
}

// Function to load network rows from database
function loadNetworkRowsFromDatabase() {
    const location = document.getElementById('location').value;
    if (!location) {
        console.log('No location selected, skipping database load');
        return;
    }
    
    console.log('Loading network rows from database for location:', location);
    
            fetch(`/it/api/saved-bod-reports/${location}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.report && data.report.report_data) {
                const reportData = data.report.report_data;
                if (reportData.internet && Array.isArray(reportData.internet)) {
                    console.log('Found network rows in database:', reportData.internet.length);
                    
                    // Clear existing network table rows (except header)
                    const tbody = document.querySelector('#internet-table tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        
                        // Add rows from database
                        reportData.internet.forEach(rowData => {
                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
                                <td>
                                    <input type="text" class="form-control" value="${rowData.sno || ''}" readonly>
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="${rowData.leased_line || ''}" readonly>
                                </td>
                                <td>
                                    <select class="form-control">
                                        <option value="">Select Link</option>
                                        <option value="Primary" ${rowData.link === 'Primary' ? 'selected' : ''}>Primary</option>
                                        <option value="Secondary" ${rowData.link === 'Secondary' ? 'selected' : ''}>Secondary</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-control">
                                        <option value="">Select Status</option>
                                        <option value="Working" ${rowData.status === 'Working' ? 'selected' : ''}>Working</option>
                                        <option value="Not Working" ${rowData.status === 'Not Working' ? 'selected' : ''}>Not Working</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-control">
                                        <option value="">Select Reason</option>
                                        <option value="Inform to IT Manager: Yes" ${rowData.reason === 'Inform to IT Manager: Yes' ? 'selected' : ''}>Inform to IT Manager: Yes</option>
                                        <option value="Inform to IT Manager: No" ${rowData.reason === 'Inform to IT Manager: No' ? 'selected' : ''}>Inform to IT Manager: No</option>
                                        <option value="Inform to IT Manager: Pending" ${rowData.reason === 'Inform to IT Manager: Pending' ? 'selected' : ''}>Inform to IT Manager: Pending</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="${rowData.remarks || ''}" placeholder="Remarks">
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="${rowData.checked_time || '-'}" readonly>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this, 'internet')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(newRow);
                        });
                        
                        console.log('Network rows loaded from database successfully');
                    }
                } else {
                    console.log('No network rows found in database');
                }
            } else {
                console.log('No report found in database for location:', location);
            }
        })
        .catch(error => {
            console.error('Error loading network rows from database:', error);
        });
}

// Function to load saved rows from localStorage on page load
function loadSavedRows() {
    console.log('Loading saved rows from localStorage...');
    
    // Load network rows from database first
    loadNetworkRowsFromDatabase();
    
    const currentLocation = document.getElementById('location').value;
    const sections = ['network', 'server_connectivity', 'antivirus', 'common_sharing', 'security', 'telecom', 'tech_room', 'printers', 'others'];
    
    sections.forEach(sectionType => {
        // Skip network section as it's loaded from database
        if (sectionType === 'network') {
            console.log('Skipping network section - loaded from database');
            return;
        }
        
        // Load rows specific to current location
        const storageKey = `bod_${sectionType}_rows_${currentLocation}`;
        const savedRows = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const deletedRows = JSON.parse(localStorage.getItem(`bod_${sectionType}_deleted_rows_${currentLocation}`) || '[]');
        console.log(`Section ${sectionType} for location ${currentLocation}: ${savedRows.length} saved rows, ${deletedRows.length} deleted rows`);
        
        // Filter out deleted rows
        const filteredRows = savedRows.filter(row => {
            const rowKey = sectionType === 'network' ? row.leased_line : 
                          sectionType === 'server_connectivity' ? row.server_name : 
                          row.sno;
            
            // Check deletion markers first
            const rowMarker = `deleted_${sectionType}_${row.sno}_${rowKey}_${currentLocation}`;
            if (localStorage.getItem(rowMarker) === 'deleted') {
                console.log(`Skipping row with deletion marker: ${rowKey} (S.No: ${row.sno})`);
                return false;
            }
            
            const isDeleted = deletedRows.some(deletedRow => {
                const deletedKey = sectionType === 'network' ? deletedRow.leased_line : 
                                 sectionType === 'server_connectivity' ? deletedRow.server_name : 
                                 deletedRow.sno;
                return deletedKey === rowKey && deletedRow.sno === row.sno;
            });
            
            if (isDeleted) {
                console.log(`Skipping deleted row: ${rowKey} (S.No: ${row.sno})`);
                return false;
            }
            return true;
        });
        
        console.log(`Section ${sectionType} for location ${currentLocation}: Loading ${filteredRows.length} rows after filtering deleted ones`);
        
        filteredRows.forEach(rowData => {
            let tableId, rowTemplate;
            
            switch(sectionType) {
                case 'network':
                    tableId = 'internet-table';
                    rowTemplate = createNetworkRow();
                    break;
                case 'server_connectivity':
                    tableId = 'server-table';
                    rowTemplate = createServerRow();
                    break;
                case 'antivirus':
                    tableId = 'antivirus-table';
                    rowTemplate = createAntivirusRow();
                    break;
                case 'common_sharing':
                    tableId = 'sharing-table';
                    rowTemplate = createSharingRow();
                    break;
                case 'security':
                    tableId = 'security-table';
                    rowTemplate = createSecurityRow();
                    break;
                case 'telecom':
                    tableId = 'telecom-table';
                    rowTemplate = createTelecomRow();
                    break;
                case 'tech_room':
                    tableId = 'techroom-table';
                    rowTemplate = createTechRoomRow();
                    break;
                case 'printers':
                    tableId = 'printers-table';
                    rowTemplate = createPrinterRow();
                    break;
                case 'others':
                    tableId = 'others-table';
                    rowTemplate = createOthersRow();
                    break;
            }
            
            if (tableId) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const newRow = tbody.insertRow();
                newRow.innerHTML = rowTemplate;
                
                // Populate the fields with saved data
                const inputs = newRow.querySelectorAll('input, select');
                inputs.forEach((input, index) => {
                    let fieldKey = '';
                    
                    // Determine field type based on input attributes and position
                    if (input.classList.contains('leased-line-input')) {
                        fieldKey = 'leased_line';
                    } else if (input.classList.contains('second-column-input')) {
                        fieldKey = 'second_column';
                    } else if (input.classList.contains('link-select')) {
                        fieldKey = 'link';
                    } else if (input.classList.contains('status-dropdown')) {
                        fieldKey = 'status';
                    } else if (input.classList.contains('remarks-input')) {
                        fieldKey = 'remarks';
                    } else if (input.classList.contains('call-number-input')) {
                        fieldKey = 'call_number';
                    } else if (input.classList.contains('reason-dropdown')) {
                        fieldKey = 'reason';
                    } else if (input.id && input.id.startsWith('telecom-it-hr-')) {
                        fieldKey = 'telecom_reason';
                    } else if (input.id && input.id.startsWith('techroom-it-manager-')) {
                        fieldKey = 'techroom_reason';
                    } else {
                        // Fallback to index-based key
                        fieldKey = `field_${index}`;
                    }
                    
                    // Only restore S.No and Name fields, leave all other fields empty
                    if (fieldKey === 'sno' || fieldKey === 'second_column' || fieldKey === 'leased_line') {
                        if (rowData.fields[fieldKey]) {
                            input.value = rowData.fields[fieldKey];
                            console.log(`Restored ${fieldKey}: ${rowData.fields[fieldKey]}`);
                            
                            // Make leased line fields read-only if they have data
                            if (input.classList.contains('leased-line-input') && input.value.trim() !== '') {
                                input.readOnly = true;
                                input.classList.add('readonly-field');
                            }
                        }
                    } else {
                        // Clear all other fields (Status, Reason, Remarks, etc.)
                        input.value = '';
                        console.log(`Cleared ${fieldKey} field`);
                    }
                });
                
                // Apply role-based editing restrictions to restored rows
                applyRoleBasedEditing(newRow);
                
                // Add event listeners for automatic localStorage updates to restored rows
                const restoredInputs = newRow.querySelectorAll('input, select');
                restoredInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        updateLocalStorageOnChange(sectionType, newRow);
                    });
                    input.addEventListener('blur', () => {
                        updateLocalStorageOnChange(sectionType, newRow);
                    });
                });
            }
        });
        
        // Update row numbers for each section
        if (savedRows.length > 0) {
            let tableId;
            switch(sectionType) {
                case 'network': tableId = 'internet-table'; break;
                case 'server_connectivity': tableId = 'server-table'; break;
                case 'antivirus': tableId = 'antivirus-table'; break;
                case 'common_sharing': tableId = 'sharing-table'; break;
                case 'security': tableId = 'security-table'; break;
                case 'telecom': tableId = 'telecom-table'; break;
                case 'tech_room': tableId = 'techroom-table'; break;
                case 'printers': tableId = 'printers-table'; break;
                case 'others': tableId = 'others-table'; break;
            }
            if (tableId) {
                updateRowNumbers(tableId);
            }
        }
    });
}

// Function to delete a specific row
function deleteRow(button, sectionType) {
    if (confirm('Are you sure you want to delete this row? This action cannot be undone.')) {
        const row = button.closest('tr');
        const rowIndex = row.rowIndex - 1; // Get the row index (subtract 1 for header)
        const location = document.getElementById('location').value;
        
        // Get row data for permanent deletion
        const rowData = getRowDataForDeletion(row, sectionType);
        
        // Debug: Log the data being sent
        console.log('DEBUG: Sending delete request with data:', {
            sectionType: sectionType,
            location: location,
            rowData: rowData,
            rowIndex: rowIndex
        });
        
        // Validate row data
        if (!rowData || Object.keys(rowData).length === 0) {
            showAlert('Error: Could not collect row data for deletion', 'danger');
            return;
        }
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Send delete request to backend
        fetch('/it/api/delete-bod-row', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sectionType: sectionType,
                location: location,
                rowData: rowData,
                rowIndex: rowIndex
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
        // Remove from localStorage if it's a saved row
        const storageKey = `bod_${sectionType}_rows_${location}`;
        const savedRows = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (savedRows.length > 0) {
            // Find the corresponding saved row and remove it
            const table = row.closest('table');
            const tbody = table.querySelector('tbody');
            const allRows = tbody.querySelectorAll('tr');
            const originalRowCount = allRows.length - savedRows.length;
            
            if (rowIndex >= originalRowCount) {
                // This is a saved row, remove it from localStorage
                const savedRowIndex = rowIndex - originalRowCount;
                savedRows.splice(savedRowIndex, 1);
                localStorage.setItem(storageKey, JSON.stringify(savedRows));
                console.log(`Row removed from localStorage for location: ${location}`);
            }
        }
            } else if (data.error && data.error.includes('No matching row found')) {
                // Row not found in database, but might be in localStorage
                console.log('Row not found in database, checking localStorage...');
                
                // Remove from localStorage if it's a saved row
                const storageKey = `bod_${sectionType}_rows_${location}`;
                const savedRows = JSON.parse(localStorage.getItem(storageKey) || '[]');
                if (savedRows.length > 0) {
                    // Find the corresponding saved row and remove it
                    const table = row.closest('table');
                    const tbody = table.querySelector('tbody');
                    const allRows = tbody.querySelectorAll('tr');
                    const originalRowCount = allRows.length - savedRows.length;
                    
                    if (rowIndex >= originalRowCount) {
                        // This is a saved row, remove it from localStorage
                        const savedRowIndex = rowIndex - originalRowCount;
                        savedRows.splice(savedRowIndex, 1);
                        localStorage.setItem(storageKey, JSON.stringify(savedRows));
                        console.log(`Row removed from localStorage for location: ${location}`);
                        
                        // Continue with UI removal
        row.remove();
        
        // Update row numbers
        let tableId;
        switch(sectionType) {
            case 'network':
                tableId = 'internet-table';
                break;
            case 'server_connectivity':
                tableId = 'server-table';
                break;
            case 'antivirus':
                tableId = 'antivirus-table';
                break;
            case 'common_sharing':
                tableId = 'sharing-table';
                break;
            case 'security':
                tableId = 'security-table';
                break;
            case 'telecom':
                tableId = 'telecom-table';
                break;
            case 'tech_room':
                tableId = 'techroom-table';
                break;
            case 'printers':
                tableId = 'printers-table';
                break;
            case 'others':
                tableId = 'others-table';
                break;
        }
        
        updateRowNumbers(tableId);
                        showAlert('Row deleted from local storage!', 'success');
                        return;
                    }
                }
                
                row.remove();
                
                // Update row numbers
                let tableId;
                switch(sectionType) {
                    case 'network':
                        tableId = 'internet-table';
                        break;
                    case 'server_connectivity':
                        tableId = 'server-table';
                        break;
                    case 'antivirus':
                        tableId = 'antivirus-table';
                        break;
                    case 'common_sharing':
                        tableId = 'sharing-table';
                        break;
                    case 'security':
                        tableId = 'security-table';
                        break;
                    case 'telecom':
                        tableId = 'telecom-table';
                        break;
                    case 'tech_room':
                        tableId = 'techroom-table';
                        break;
                    case 'printers':
                        tableId = 'printers-table';
                        break;
                    case 'others':
                        tableId = 'others-table';
                        break;
                }
                
                updateRowNumbers(tableId);
                showAlert('Row permanently deleted successfully!', 'success');
            } else {
                // Check if the error is about row not found in database
                if (data.error && (data.error.includes('No matching row found') || data.error.includes('Row index') || data.error.includes('invalid'))) {
                    console.log('Row not found in database, removing from localStorage...');
                    
                    // Get the row data to identify which localStorage row to remove
                    const rowData = getRowDataForDeletion(row, sectionType);
                    console.log('Row data for localStorage deletion:', rowData);
                    
                    // Remove from localStorage if it's a saved row
                    const savedRows = JSON.parse(localStorage.getItem(`bod_${sectionType}_rows`) || '[]');
                    console.log('Current saved rows:', savedRows);
                    
                    if (savedRows.length > 0) {
                        // Find the matching row in localStorage by comparing data
                        let foundIndex = -1;
                        for (let i = 0; i < savedRows.length; i++) {
                            const savedRow = savedRows[i];
                            console.log(`Comparing saved row ${i}:`, savedRow);
                            
                            // Compare key fields to find the matching row
                            if (sectionType === 'network') {
                                if (savedRow.leased_line === rowData.leased_line && savedRow.sno === rowData.sno) {
                                    foundIndex = i;
                                    break;
                                }
                            } else if (sectionType === 'server_connectivity') {
                                if (savedRow.server_name === rowData.server_name && savedRow.sno === rowData.sno) {
                                    foundIndex = i;
                                    break;
                                }
                            } else {
                                // For other sections, compare sno and other key fields
                                if (savedRow.sno === rowData.sno) {
                                    foundIndex = i;
                                    break;
                                }
                            }
                        }
                        
                        if (foundIndex !== -1) {
                            console.log(`Found matching row at index ${foundIndex}, removing from localStorage`);
                            
                            // Add to deleted rows list to prevent reloading
                            const deletedRows = JSON.parse(localStorage.getItem(`bod_${sectionType}_deleted_rows`) || '[]');
                            deletedRows.push(rowData);
                            localStorage.setItem(`bod_${sectionType}_deleted_rows`, JSON.stringify(deletedRows));
                            console.log('Row added to deleted rows list');
                            
                            savedRows.splice(foundIndex, 1);
                            localStorage.setItem(`bod_${sectionType}_rows`, JSON.stringify(savedRows));
                            console.log('Row removed from localStorage');
                            
                            // Also clear any cached data for this specific row
                            const cacheKey = `bod_${sectionType}_row_${rowData.sno}_${rowData.leased_line || rowData.server_name || ''}`;
                            localStorage.removeItem(cacheKey);
                            console.log('Cleared cached data for row');
                            
                            // Add a specific marker to prevent this row from being reloaded
                            const rowMarker = `deleted_${sectionType}_${rowData.sno}_${rowData.leased_line || rowData.server_name || ''}`;
                            localStorage.setItem(rowMarker, 'deleted');
                            console.log(`Added deletion marker: ${rowMarker}`);
                            
                            // Continue with UI removal
                            row.remove();
                            
                            // Update row numbers
                            let tableId;
                            switch(sectionType) {
                                case 'network':
                                    tableId = 'internet-table';
                                    break;
                                case 'server_connectivity':
                                    tableId = 'server-table';
                                    break;
                                case 'antivirus':
                                    tableId = 'antivirus-table';
                                    break;
                                case 'common_sharing':
                                    tableId = 'sharing-table';
                                    break;
                                case 'security':
                                    tableId = 'security-table';
                                    break;
                                case 'telecom':
                                    tableId = 'telecom-table';
                                    break;
                                case 'tech_room':
                                    tableId = 'techroom-table';
                                    break;
                                case 'printers':
                                    tableId = 'printers-table';
                                    break;
                                case 'others':
                                    tableId = 'others-table';
                                    break;
                            }
                            
                            updateRowNumbers(tableId);
                            showAlert('Row deleted from local storage!', 'success');
                            return;
                        } else {
                            console.log('No matching row found in localStorage');
                        }
                    }
                    
                    // If we get here, the row wasn't found in localStorage either
                    showAlert('Row not found in database or local storage', 'danger');
                } else {
                    showAlert('Error deleting row: ' + data.error, 'danger');
                }
                
                // Restore button state
                button.innerHTML = '<i class="fas fa-trash"></i>';
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting row', 'danger');
            // Restore button state
            button.innerHTML = '<i class="fas fa-trash"></i>';
            button.disabled = false;
        });
    }
}

// Function to get row data for deletion
function getRowDataForDeletion(row, sectionType) {
    const cells = row.querySelectorAll('td');
    const rowData = {};
    
    // Debug: Log the cells found
    console.log('DEBUG: Found cells:', cells.length);
    console.log('DEBUG: Section type:', sectionType);
    
    if (cells.length === 0) {
        console.error('DEBUG: No cells found in row');
        return null;
    }
    
    switch(sectionType) {
        case 'network':
            if (cells.length >= 7) {
                rowData.sno = cells[0].textContent.trim();
                rowData.leased_line = cells[1].querySelector('input') ? cells[1].querySelector('input').value : cells[1].textContent.trim();
                rowData.link = cells[2].textContent.trim();
                rowData.status = cells[3].querySelector('select') ? cells[3].querySelector('select').value : cells[3].textContent.trim();
                rowData.reason = cells[4].textContent.trim();
                rowData.remarks = cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent.trim();
                rowData.checked_time = cells[6].querySelector('span') ? cells[6].querySelector('span').textContent.trim() : cells[6].textContent.trim();
            } else {
                console.error('DEBUG: Network row has insufficient cells:', cells.length);
                return null;
            }
            break;
        case 'server_connectivity':
            if (cells.length >= 6) {
                rowData.sno = cells[0].textContent.trim();
                rowData.server_name = cells[1].querySelector('input') ? cells[1].querySelector('input').value : cells[1].textContent.trim();
                rowData.status = cells[2].querySelector('select') ? cells[2].querySelector('select').value : cells[2].textContent.trim();
                rowData.reason = cells[3].textContent.trim();
                rowData.remarks = cells[4].querySelector('input') ? cells[4].querySelector('input').value : cells[4].textContent.trim();
                rowData.checked_time = cells[5].querySelector('span') ? cells[5].querySelector('span').textContent.trim() : cells[5].textContent.trim();
            } else {
                console.error('DEBUG: Server connectivity row has insufficient cells:', cells.length);
                return null;
            }
            break;
        // Add other cases for different section types as needed
        default:
            // For other sections, collect basic data
            if (cells.length >= 2) {
                rowData.sno = cells[0].textContent.trim();
                for (let i = 1; i < cells.length - 1; i++) { // Skip first (S.No) and last (Action) cells
                    const input = cells[i].querySelector('input, select');
                    if (input) {
                        rowData[`field_${i}`] = input.value;
                    } else {
                        rowData[`field_${i}`] = cells[i].textContent.trim();
                    }
                }
            } else {
                console.error('DEBUG: Row has insufficient cells:', cells.length);
                return null;
            }
            break;
    }
    
    console.log('DEBUG: Collected row data:', rowData);
    return rowData;
}

// Function to clear all saved rows from localStorage for current location
function clearAllSavedRows() {
    const currentLocation = document.getElementById('location').value;
    if (!currentLocation) {
        showAlert('Please select a location first!', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to clear all saved rows for ${currentLocation}? This action cannot be undone.`)) {
        const sections = ['network', 'server_connectivity', 'antivirus', 'common_sharing', 'security', 'telecom', 'tech_room', 'printers', 'others'];
        
        sections.forEach(sectionType => {
            const storageKey = `bod_${sectionType}_rows_${currentLocation}`;
            localStorage.removeItem(storageKey);
            console.log(`Cleared localStorage for ${sectionType} in ${currentLocation}`);
        });
        
        // Clear dynamically added rows from the UI
        clearDynamicallyAddedRows();
        
        showAlert(`All saved rows for ${currentLocation} cleared successfully!`, 'success');
    }
}

// Function to update localStorage when field values change
function updateLocalStorageOnChange(sectionType, rowElement) {
    const currentLocation = document.getElementById('location').value;
    const storageKey = `bod_${sectionType}_rows_${currentLocation}`;
    const savedRows = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const table = rowElement.closest('table');
    const tbody = table.querySelector('tbody');
    const allRows = tbody.querySelectorAll('tr');
    const rowIndex = rowElement.rowIndex - 1;
    const originalRowCount = allRows.length - savedRows.length;
    
    if (rowIndex >= originalRowCount) {
        // This is a saved row, update it in localStorage
        const savedRowIndex = rowIndex - originalRowCount;
        const rowData = savedRows[savedRowIndex];
        
        // Update the fields data
        const inputs = rowElement.querySelectorAll('input, select');
        inputs.forEach((input, index) => {
            let fieldKey = '';
            
            if (input.classList.contains('leased-line-input')) {
                fieldKey = 'leased_line';
            } else if (input.classList.contains('second-column-input')) {
                fieldKey = 'second_column';
            } else if (input.classList.contains('link-select')) {
                fieldKey = 'link';
            } else if (input.classList.contains('status-dropdown')) {
                fieldKey = 'status';
            } else if (input.classList.contains('remarks-input')) {
                fieldKey = 'remarks';
            } else if (input.classList.contains('call-number-input')) {
                fieldKey = 'call_number';
            } else if (input.classList.contains('reason-dropdown')) {
                fieldKey = 'reason';
            } else if (input.id && input.id.startsWith('telecom-it-hr-')) {
                fieldKey = 'telecom_reason';
            } else if (input.id && input.id.startsWith('techroom-it-manager-')) {
                fieldKey = 'techroom_reason';
            } else {
                fieldKey = `field_${index}`;
            }
            
            // Only save changes to S.No and Name fields, ignore changes to other fields
            if (fieldKey === 'sno' || fieldKey === 'second_column' || fieldKey === 'leased_line') {
                if (input.type === 'text' || input.type === 'number') {
                    rowData.fields[fieldKey] = input.value || '';
                } else if (input.tagName === 'SELECT') {
                    rowData.fields[fieldKey] = input.value || '';
                }
            }
            // Don't save changes to Status, Reason, Remarks, etc. - they will be cleared on refresh
        });
        
        // Save back to localStorage with location-specific key
        localStorage.setItem(storageKey, JSON.stringify(savedRows));
        console.log(`Updated localStorage for section: ${sectionType}, location: ${currentLocation}, row: ${savedRowIndex}`);
    }
}

// Function to apply role-based editing restrictions
function applyRoleBasedEditing(rowElement) {
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    
    if (!isSuperAdmin) {
        // For admin users, make the 2nd column read-only across all tables
        const cells = rowElement.querySelectorAll('td');
        
        // Check if we have at least 2 columns (index 1 is the 2nd column)
        if (cells.length > 1) {
            const secondColumn = cells[1];
            const inputs = secondColumn.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                input.readOnly = true;
                input.disabled = true;
                input.classList.add('readonly-field');
                input.style.backgroundColor = '#f8f9fa';
                input.style.cursor = 'not-allowed';
                input.title = 'This field is read-only for admin users';
            });
        }
    }
}

// Function to apply role-based editing restrictions to all existing rows
function applyRoleBasedEditingToExistingRows() {
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    
    if (!isSuperAdmin) {
        // Apply restrictions to all tables
        const tables = [
            'internet-table', 'server-table', 'antivirus-table', 'sharing-table',
            'security-table', 'telecom-table', 'techroom-table', 'printers-table', 'others-table'
        ];
        
        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    applyRoleBasedEditing(row);
                });
            }
        });
    }
}

// Helper functions to create row templates
function createNetworkRow() {
    const rowCount = document.querySelectorAll('#internet-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    const currentLocation = document.getElementById('location').value;
    
    // Set default value based on location
    let defaultValue = 'Enter leased line/DSL link';
    if (currentLocation === 'unit-3') {
        switch(rowCount) {
            case 1:
                defaultValue = 'DSL Airtel - 136.185.18.128';
                break;
            case 2:
                defaultValue = 'Spectra LL - 119.82.116.220';
                break;
            case 3:
                defaultValue = 'TATA LL - 14.194.137.58';
                break;
            default:
                defaultValue = 'Enter leased line/DSL link';
                break;
        }
    } else if (currentLocation === 'unit-4') {
        switch(rowCount) {
            case 1:
                defaultValue = 'DSL Airtel1 300Mbs - 136.185.18.111';
                break;
            case 2:
                defaultValue = 'DSL Airtel2 1Gbps - 136.185.18.113';
                break;
            case 3:
                defaultValue = 'Spectra LL - 180.151.69.190';
                break;
            case 4:
                defaultValue = 'Tata LL - 14.96.14.26';
                break;
            default:
                defaultValue = 'Enter leased line/DSL link';
                break;
        }
    } else if (currentLocation === 'unit-5') {
        switch(rowCount) {
            case 1:
                defaultValue = 'Airtel DSL - 203.101.41.185';
                break;
            case 2:
                defaultValue = 'Airtel LL - 122.186.163.10';
                break;
            case 3:
                defaultValue = 'Tata LL - 14.96.14.26';
                break;
            default:
                defaultValue = 'Enter leased line/DSL link';
                break;
        }
    } else if (currentLocation === 'GSS') {
        switch(rowCount) {
            case 1:
                defaultValue = 'Spectra LL - 180.151.66.70';
                break;
            case 2:
                defaultValue = 'Tata LL - 14.96.218.30';
                break;
            default:
                defaultValue = 'Enter leased line/DSL link';
                break;
        }
    }
    
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control leased-line-input second-column-input" value="${defaultValue}" placeholder="Enter leased line/DSL link" onblur="makeLeasedLineReadOnly(this)" oninput="checkTataLeasedLine(this)"></td>
        <td>
            <select class="form-select link-select">
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
            </select>
        </td>
        <td>
            <select class="form-select status-dropdown" onchange="updateStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
                           <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
                       <div class="reason-content">
                           <div class="mb-2">
                               <label class="form-label">call raised or not:</label>
                               <select class="form-select" id="call-raised-${rowCount}" onchange="handleCallRaisedChange(${rowCount})">
                                   <option value="">Select</option>
                                   <option value="Yes">Yes</option>
                                   <option value="No">No</option>
                               </select>
                           </div>
                           <div id="call-number-container-${rowCount}" style="display: none;">
                               <input type="text" class="form-control" id="call-number-${rowCount}" placeholder="Enter call number">
                           </div>
                           <div id="call-warning-${rowCount}" style="display: none;">
                               <div class="alert alert-warning py-2 mb-0">
                                   <small>❌ Please raise the call and put the ticket</small>
                               </div>
                           </div>
                       </div>
                   </td>
        <td><input type="text" class="form-control remarks-input" id="remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="checked-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'network\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createServerRow() {
    const rowCount = document.querySelectorAll('#server-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter server connectivity item"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateServerStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
            <div class="reason-content">
                <div class="mb-2">
                    <label class="form-label">In form to IT Manager:</label>
                    <select class="form-select" id="it-manager-${rowCount}" onchange="handleITManagerChange(${rowCount})">
                        <option value="">Select</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div id="it-manager-warning-${rowCount}" style="display: none;">
                    <div class="alert alert-warning mb-0">
                        ❌ Please call the IT manager
                    </div>
                </div>
            </div>
        </td>
        <td><input type="text" class="form-control remarks-input" id="server-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="server-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'server_connectivity\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createAntivirusRow() {
    const rowCount = document.querySelectorAll('#antivirus-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter antivirus name"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateAntivirusStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Updated">Updated</option>
                <option value="Not Updated">Not Updated</option>
            </select>
        </td>
        <td><input type="text" class="form-control" placeholder="Last updated date"></td>
        <td><input type="text" class="form-control remarks-input" id="antivirus-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="antivirus-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'antivirus\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createSharingRow() {
    const rowCount = document.querySelectorAll('#sharing-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter folder name"></td>
        <td><input type="text" class="form-control" placeholder="Enter access rights"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateSharingStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="ok">ok</option>
                <option value="Not ok">Not ok</option>
            </select>
        </td>
        <td><input type="text" class="form-control remarks-input" id="sharing-remarks-${rowCount}" placeholder="Enter remarks if needed" onchange="updateSharingRemarks(this, ${rowCount})"></td>
        <td><span id="sharing-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'common_sharing\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createSecurityRow() {
    const rowCount = document.querySelectorAll('#security-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter security item name"></td>
        <td><input type="number" class="form-control" value="0" min="0"></td>
        <td><input type="number" class="form-control" value="0" min="0"></td>
        <td><input type="text" class="form-control remarks-input" id="remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="checked-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'security\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createTelecomRow() {
    const rowCount = document.querySelectorAll('#telecom-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter telecom item name"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateTelecomStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
            <div class="reason-content">
                <div class="mb-2">
                    <label class="form-label">Inform to IT Manager or HR:</label>
                    <select class="form-select" id="telecom-it-hr-${rowCount}" onchange="handleTelecomITHrChange(${rowCount})">
                        <option value="">Select</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div id="telecom-it-hr-warning-${rowCount}" style="display: none;">
                    <div class="alert alert-warning mb-0">
                        ❌ Please inform to IT Manager or HR
                    </div>
                </div>
            </div>
        </td>
        <td><input type="text" class="form-control remarks-input" id="telecom-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="telecom-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'telecom\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createTechRoomRow() {
    const rowCount = document.querySelectorAll('#techroom-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter tech room item name"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateTechRoomStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
            <div class="reason-content">
                <div class="mb-2">
                    <label class="form-label">Inform to IT Manager:</label>
                    <select class="form-select" id="techroom-it-manager-${rowCount}" onchange="handleTechRoomITManagerChange(${rowCount})">
                        <option value="">Select</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div id="techroom-it-manager-warning-${rowCount}" style="display: none;">
                    <div class="alert alert-warning mb-0">
                        ❌ Please inform to IT Manager
                    </div>
                </div>
            </div>
        </td>
        <td><input type="text" class="form-control remarks-input" id="techroom-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="techroom-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'tech_room\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createPrinterRow() {
    const rowCount = document.querySelectorAll('#printers-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter printer name" onblur="makeNameReadonly(this)"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updatePrinterStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td class="reason-column" id="printer-reason-${rowCount}" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
            <div>
                <label>Inform to IT Manager:</label>
                <select class="form-select" id="printer-it-manager-${rowCount}" onchange="handlePrinterITManagerChange(${rowCount})">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
                <div id="printer-it-manager-warning-${rowCount}" style="display: none;">
                    <div class="alert alert-warning mb-0">
                        ❌ Please inform to IT Manager
                    </div>
                </div>
            </div>
        </td>
        <td><input type="text" class="form-control" id="printer-yesterday-${rowCount}" placeholder="No Data" readonly style="background-color: #f8f9fa;"></td>
        <td><input type="text" class="form-control" placeholder="Today's reading"></td>
        <td><input type="text" class="form-control remarks-input" id="printer-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="printer-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'printers\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

function createOthersRow() {
    const rowCount = document.querySelectorAll('#others-table tbody tr').length + 1;
    const isSuperAdmin = '{{ current_user.role }}' === 'super_admin';
    return `
        <td>${rowCount}</td>
        <td><input type="text" class="form-control second-column-input" placeholder="Enter other item name" onblur="makeNameReadonly(this)"></td>
        <td>
            <select class="form-select status-dropdown" onchange="updateOthersStatus(this, ${rowCount})">
                <option value="">Select Status</option>
                <option value="Working">Working</option>
                <option value="Not Working">Not Working</option>
            </select>
        </td>
        <td class="reason-column" style="visibility: hidden; height: 0; padding: 0; border: none; overflow: hidden;">
            <div class="reason-content">
                <div class="mb-2">
                    <label class="form-label">Inform to IT Manager or HR:</label>
                    <select class="form-select" id="it-hr-${rowCount}" onchange="handleITHrChange(${rowCount})">
                        <option value="">Select</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div id="it-hr-warning-${rowCount}" style="display: none;">
                    <div class="alert alert-warning mb-0">
                        ❌ Please inform to IT Manager or HR
                    </div>
                </div>
            </div>
        </td>
        <td><input type="text" class="form-control remarks-input" id="others-remarks-${rowCount}" placeholder="Enter remarks if needed"></td>
        <td><span id="others-time-${rowCount}">-</span></td>
        ${isSuperAdmin ? '<td><button class="btn btn-sm btn-danger" onclick="deleteRow(this, \'others\')" title="Delete row"><i class="fas fa-trash"></i></button></td>' : ''}
    `;
}

// Function to validate call numbers for "Not Working" status with "Yes" selection
function validateCallNumbers() {
    const networkRows = document.querySelectorAll('#internet-table tbody tr');
    
    for (let index = 0; index < networkRows.length; index++) {
        const row = networkRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const callRaisedSelect = row.querySelector('select[id^="call-raised-"]');
        const callNumberInput = row.querySelector('input[id^="call-number-"]');
        
        // Check if status is "Not Working"
        if (statusSelect && statusSelect.value === 'Not Working') {
            // If call raised is "No", block save
            if (callRaisedSelect && callRaisedSelect.value === 'No') {
                alert(`❌ 1. Network - When status is "Not Working", you must select "Yes" for call raised or not. "No" is not allowed for row ${index + 1}`);
                return false;
            }
            
            // If call raised is "Yes" but call number is empty, block save
            if (callRaisedSelect && callRaisedSelect.value === 'Yes' &&
                callNumberInput && (!callNumberInput.value || callNumberInput.value.trim() === '')) {
                alert(`❌ 1. Network - Please enter the call number for row ${index + 1}`);
                return false;
            }
            
            // If call raised is empty/not selected, block save
            if (!callRaisedSelect || !callRaisedSelect.value || callRaisedSelect.value === '') {
                alert(`❌ 1. Network - When status is "Not Working", you must select "Yes" for call raised or not for row ${index + 1}`);
                return false;
            }
        }
    }
    
    return true;
}

// Function to validate IT Manager form for "Not Working" status
function validateITManagerForm() {
    const serverRows = document.querySelectorAll('#server-table tbody tr');
    
    for (let index = 0; index < serverRows.length; index++) {
        const row = serverRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const itManagerSelect = row.querySelector('select[id^="it-manager-"]');
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            (!itManagerSelect || itManagerSelect.value === '')) {
            alert(`❌ 2. Server Connectivity Check - When status is "Not Working", you must select "Yes" for IT Manager form. Empty selection is not allowed for row ${index + 1}`);
            return false;
        }
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            itManagerSelect && itManagerSelect.value === 'No') {
            alert(`❌ 2. Server Connectivity Check - When status is "Not Working", you must select "Yes" for IT Manager form. "No" is not allowed for row ${index + 1}`);
            return false;
        }
    }
    
    return true;
}

// Function to validate IT/HR form for "Not Working" status in Others section
function validateITHrForm() {
    const othersRows = document.querySelectorAll('#others-table tbody tr');
    
    for (let index = 0; index < othersRows.length; index++) {
        const row = othersRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const itHrSelect = row.querySelector('select[id^="it-hr-"]');
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            (!itHrSelect || itHrSelect.value === '')) {
            alert(`❌ 9. Others (Reception TV, Biometric Attendance) - When status is "Not Working", you must select "Yes" for IT Manager or HR form. Empty selection is not allowed for row ${index + 1}`);
            return false;
        }
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            itHrSelect && itHrSelect.value === 'No') {
            alert(`❌ 9. Others (Reception TV, Biometric Attendance) - When status is "Not Working", you must select "Yes" for IT Manager or HR form. "No" is not allowed for row ${index + 1}`);
            return false;
        }
    }
    
    return true;
}

// Function to validate IT/HR form for "Not Working" status in Telecom section
function validateTelecomITHrForm() {
    const telecomRows = document.querySelectorAll('#telecom-table tbody tr');
    
    for (let index = 0; index < telecomRows.length; index++) {
        const row = telecomRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const itHrSelect = row.querySelector('select[id^="telecom-it-hr-"]');
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            (!itHrSelect || itHrSelect.value === '')) {
            alert(`❌ 6. Telecommunication (Local Phone) - When status is "Not Working", you must select "Yes" for IT Manager or HR form. Empty selection is not allowed for row ${index + 1}`);
            return false;
        }
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            itHrSelect && itHrSelect.value === 'No') {
            alert(`❌ 6. Telecommunication (Local Phone) - When status is "Not Working", you must select "Yes" for IT Manager or HR form. "No" is not allowed for row ${index + 1}`);
            return false;
        }
    }
    
    return true;
}

// Function to validate IT Manager form for "Not Working" status in Technology Room section
function validateTechRoomITManagerForm() {
    const techRoomRows = document.querySelectorAll('#techroom-table tbody tr');
    
    for (let index = 0; index < techRoomRows.length; index++) {
        const row = techRoomRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const itManagerSelect = row.querySelector('select[id^="techroom-it-manager-"]');
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            (!itManagerSelect || itManagerSelect.value === '')) {
            alert(`❌ 7. Technology Room (TV, Audio, Network) - When status is "Not Working", you must select "Yes" for IT Manager form. Empty selection is not allowed for row ${index + 1}`);
            return false;
        }
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            itManagerSelect && itManagerSelect.value === 'No') {
            alert(`❌ 7. Technology Room (TV, Audio, Network) - When status is "Not Working", you must select "Yes" for IT Manager form. "No" is not allowed for row ${index + 1}`);
            return false;
        }
    }
    
    return true;
}

// Function to validate IT Manager form for "Not Working" status in Printers section
function validatePrinterITManagerForm() {
    const printerRows = document.querySelectorAll('#printers-table tbody tr');
    
    for (let index = 0; index < printerRows.length; index++) {
        const row = printerRows[index];
        const statusSelect = row.querySelector('.status-dropdown');
        const itManagerSelect = row.querySelector('select[id^="printer-it-manager-"]');
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            (!itManagerSelect || itManagerSelect.value === '')) {
            alert(`❌ 8. Printers (Status, Readings) - When status is "Not Working", you must select "Yes" for IT Manager form. Empty selection is not allowed for row ${index + 1}`);
            return false;
        }
        
        if (statusSelect && statusSelect.value === 'Not Working' && 
            itManagerSelect && itManagerSelect.value === 'No') {
            alert(`❌ 8. Printers (Status, Readings) - When status is "Not Working", you must select "Yes" for IT Manager form. "No" is not allowed for row ${index + 1}`);
            return false;
        }
    }
    
    return true;
}

function saveBodReport() {
    console.log('saveBodReport function called');
    
    // Get form data first (needed for validation)
    const name = document.getElementById('name').value;
    const date = document.getElementById('date').value;
    const selectedLocation = document.getElementById('location').value;
    const secondaryInternet = document.getElementById('secondaryInternet').value;
    
    console.log('Form data:', { name, date, selectedLocation, secondaryInternet });
    
    // Validate network table first
    if (!validateNetworkTable()) {
        console.log('validateNetworkTable failed');
        return; // Stop if validation fails
    }
    console.log('validateNetworkTable passed');
    
    // Validate call numbers
    if (!validateCallNumbers()) {
        console.log('validateCallNumbers failed');
        return; // Stop if validation fails
    }
    console.log('validateCallNumbers passed');
    
    // Validate IT Manager form
    if (!validateITManagerForm()) {
        console.log('validateITManagerForm failed');
        return; // Stop if validation fails
    }
    console.log('validateITManagerForm passed');
    
    // Validate IT/HR form for Others section
    if (!validateITHrForm()) {
        console.log('validateITHrForm failed');
        return; // Stop if validation fails
    }
    console.log('validateITHrForm passed');
    
    // Validate IT/HR form for Telecom section
    if (!validateTelecomITHrForm()) {
        console.log('validateTelecomITHrForm failed');
        return; // Stop if validation fails
    }
    console.log('validateTelecomITHrForm passed');
    
    // Validate IT Manager form for Technology Room section (only if section is visible)
    if (selectedLocation !== 'unit-1' && selectedLocation !== 'unit-2') {
    if (!validateTechRoomITManagerForm()) {
            console.log('validateTechRoomITManagerForm failed');
        return; // Stop if validation fails
        }
        console.log('validateTechRoomITManagerForm passed');
    }
    
    // Validate IT Manager form for Printers section
    if (!validatePrinterITManagerForm()) {
        console.log('validatePrinterITManagerForm failed');
        return; // Stop if validation fails
    }
    console.log('validatePrinterITManagerForm passed');
    
    // Validate required fields
    if (!name || !date || !selectedLocation) {
        console.log('Required fields validation failed:', { name, date, selectedLocation });
        showAlert('Please fill in all required fields (Name, Date, Location)', 'warning');
        return;
    }
    console.log('Required fields validation passed');
    
    // Collect all report data from tables (checked_time will be set to current time automatically)
    const reportData = {
        network: collectTableData('internet-table'),
        server_connectivity: collectTableData('server-table'),
        security: collectTableData('security-table'),
        telecom: collectTableData('telecom-table'),
        printers: collectTableData('printers-table'),
        others: collectTableData('others-table')
    };
    
    console.log('Report data collected:', reportData);
    
    // Only include Antivirus data if the section is visible (not for unit-1 and unit-2)
    if (selectedLocation !== 'unit-1' && selectedLocation !== 'unit-2') {
        reportData.antivirus = collectTableData('antivirus-table');
    }
    
    // Only include Common Sharing data if the section is visible (not for unit-1 and unit-2)
    if (selectedLocation !== 'unit-1' && selectedLocation !== 'unit-2') {
        reportData.common_sharing = collectTableData('sharing-table');
    }
    
    // Only include Technology Room data if the section is visible (not for unit-1 and unit-2)
    if (selectedLocation !== 'unit-1' && selectedLocation !== 'unit-2') {
        reportData.tech_room = collectTableData('techroom-table');
    }
    
    // Prepare data for saving
    const saveData = {
        name: name,
        date: date,
        location: selectedLocation,
        secondary_internet: secondaryInternet,
        report_data: reportData
    };
    
    console.log('Saving data:', saveData);
    
    // Send save request
            fetch('/it/save-bod-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saveData)
    })
    .then(response => {
        if (!response.ok) {
            // Handle HTTP error status codes
            if (response.status === 409) {
                return response.json().then(data => {
                    throw new Error(data.error || 'A report for this unit and date already exists');
                });
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('BOD report saved successfully!', 'success');
            // Update button state after successful save
            const saveBtn = document.getElementById('saveReportBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Already Saved';
            saveBtn.className = 'btn btn-secondary me-2';
            saveBtn.title = 'Report has been saved successfully';
        } else {
            showAlert('Error saving report: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert(error.message, 'warning');
    });
}

function collectTableData(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return [];
    
    const rows = table.querySelectorAll('tbody tr');
    const data = [];
    
    rows.forEach((row, index) => {
        // Skip hidden rows (for network filtering)
        if (row.style.display === 'none') {
            return;
        }
        const cells = row.querySelectorAll('td');
        const rowData = {};
        
        // Get headers for this table
        const headers = getTableHeaders(tableId);
        
        cells.forEach((cell, cellIndex) => {
            if (cellIndex < headers.length) {
                const header = headers[cellIndex];
                const key = getHeaderKey(header, tableId);
                
                // Get value from input, select, or text content
                const input = cell.querySelector('input, select');
                if (key === 'reason' && tableId === 'server-table') {
                    // Special handling for server table reason column (IT Manager dropdown)
                    const reasonSelect = cell.querySelector('select');
                    if (reasonSelect && reasonSelect.value) {
                        // Get the label from the reason column
                        const labelElement = cell.querySelector('label');
                        let label = 'Inform to IT Manager:'; // Default for server section
                        
                        if (labelElement) {
                            label = labelElement.textContent.trim();
                        }
                        
                        rowData[key] = `${label} ${reasonSelect.value}`;
                    } else {
                        rowData[key] = '';
                    }
                } else if (key === 'remarks' && tableId === 'server-table') {
                    // Special handling for server table remarks column (user input)
                    const remarksInput = cell.querySelector('input[type="text"]');
                    if (remarksInput) {
                        rowData[key] = remarksInput.value;
                    } else {
                        rowData[key] = '';
                    }
                } else if (key === 'reason' && tableId === 'techroom-table') {
                    // Special handling for techroom table reason column (IT Manager dropdown)
                    const reasonSelect = cell.querySelector('select');
                    const statusCell = row.querySelector('td:nth-child(3)'); // Status column
                    const statusSelect = statusCell ? statusCell.querySelector('select') : null;
                    
                    // Only collect reason data if status is "Not Working"
                    if (statusSelect && statusSelect.value === 'Not Working') {
                        if (reasonSelect && reasonSelect.value) {
                            // Get the label from the reason column
                            const labelElement = cell.querySelector('label');
                            let label = 'Inform to IT Manager:'; // Default for techroom section
                            
                            if (labelElement) {
                                label = labelElement.textContent.trim();
                            }
                            
                            rowData[key] = `${label} ${reasonSelect.value}`;
                        } else {
                            rowData[key] = '';
                        }
                    } else {
                        // If status is not "Not Working", set reason to empty
                        rowData[key] = '';
                    }
                } else if (key === 'remarks' && tableId === 'techroom-table') {
                    // Special handling for techroom table remarks column (user input)
                    const remarksInput = cell.querySelector('input[type="text"]');
                    if (remarksInput) {
                        rowData[key] = remarksInput.value;
                    } else {
                        rowData[key] = '';
                    }
                } else if (key === 'reason') {
                    // Special handling for reason column which contains complex HTML (other tables)
                    const reasonSelect = cell.querySelector('select');
                    const callNumberInput = cell.querySelector('input[type="text"]');
                    
                    if (reasonSelect && reasonSelect.value) {
                        // Get the label from the reason column
                        const labelElement = cell.querySelector('label');
                        let label = 'call raised or not:'; // Default for network section
                        
                        if (labelElement) {
                            label = labelElement.textContent.trim();
                        }
                        
                        let reasonValue = `${label} ${reasonSelect.value}`;
                        if (callNumberInput && callNumberInput.value) {
                            reasonValue += ` ${callNumberInput.value}`;
                        }
                        rowData[key] = reasonValue;
                    } else {
                        rowData[key] = '';
                    }
                } else if (key === 'checked_time') {
                    // Always set checked_time to current time when collecting data
                    const currentTime = getCurrentTime();
                    rowData[key] = currentTime;
                    console.log('Set checked_time to current time:', currentTime, 'for table:', tableId);
                    
                    // Also update the DOM to show the current time
                    const timeSpan = cell.querySelector('span');
                    if (timeSpan) {
                        timeSpan.textContent = currentTime;
                    }
                } else if (input) {
                    rowData[key] = input.value;
                } else {
                    rowData[key] = cell.textContent.trim();
                }
            }
        });
        
        if (Object.keys(rowData).length > 0) {
            data.push(rowData);
        }
    });
    
    return data;
}

function getTableHeaders(tableId) {
    const headers = {
        'internet-table': ['S.No', 'Leased Lines/DSL Links', 'Link', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'server-table': ['S.No', 'Server Name', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'antivirus-table': ['S.No', 'System Name', 'Antivirus Status', 'Last Updated', 'Remarks', 'Checked Time'],
        'sharing-table': ['S.No', 'Folder Name', 'Access Rights', 'Status', 'Remarks', 'Checked Time'],
        'security-table': ['S.No', 'Security Device', 'Location', 'Status', 'Remarks', 'Checked Time'],
        'telecom-table': ['S.No', 'Name', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'techroom-table': ['S.No', 'Equipment', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'printers-table': ['S.No', 'Printer Name', 'Status', 'Reason', 'Yesterday Reading', 'Today Reading', 'Remarks', 'Checked Time'],
        'others-table': ['S.No', 'Item', 'Status', 'Reason', 'Remarks', 'Checked Time']
    };
    return headers[tableId] || [];
}

function getHeaderKey(header, tableId) {
    const keyMappings = {
        'internet-table': {
            'S.No': 'sno',
            'Leased Lines/DSL Links': 'leased_line',
            'Link': 'link',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'server-table': {
            'S.No': 'sno',
            'Server Name': 'server_name',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'antivirus-table': {
            'S.No': 'sno',
            'System Name': 'system_name',
            'Antivirus Status': 'antivirus_status',
            'Last Updated': 'last_updated',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'sharing-table': {
            'S.No': 'sno',
            'Folder Name': 'folder_name',
            'Access Rights': 'access_rights',
            'Status': 'status',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'security-table': {
            'S.No': 'sno',
            'Security Device': 'security_device',
            'Location': 'location',
            'Status': 'status',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'telecom-table': {
            'S.No': 'sno',
            'Name': 'name',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'techroom-table': {
            'S.No': 'sno',
            'Equipment': 'equipment',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'printers-table': {
            'S.No': 'sno',
            'Printer Name': 'printer_name',
            'Status': 'status',
            'Reason': 'reason',
            'Yesterday Reading': 'yesterday_reading',
            'Today Reading': 'today_reading',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'others-table': {
            'S.No': 'sno',
            'Item': 'item',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        }
    };
    
    return keyMappings[tableId]?.[header] || header.toLowerCase().replace(/\s+/g, '_');
}

// Function to check if a report already exists for the current unit and date
function checkExistingReport() {
    const date = document.getElementById('date').value;
    const location = document.getElementById('location').value;
    const saveBtn = document.getElementById('saveReportBtn');
    
    if (!date || !location) {
        return; // Don't check if date or location is not selected
    }
    
    // Convert date format from MM/DD/YYYY to YYYY-MM-DD for API
    const [month, day, year] = date.split('/');
    const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`; // YYYY-MM-DD format
    
            fetch(`/it/api/saved-bod-reports/${formattedDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.reports) {
                // Check if a report already exists for this specific location and date
                const existingReport = data.reports.find(report => report.location === location);
                if (existingReport) {
                    // Report exists for this unit and date
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Already Saved';
                    saveBtn.className = 'btn btn-secondary me-2';
                    saveBtn.title = `Report for ${location} on ${date} already submitted by ${existingReport.name} at ${existingReport.submitted_time}`;
                } else {
                    // No existing report
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Report';
                    saveBtn.className = 'btn btn-success me-2';
                    saveBtn.title = 'Save BOD Report';
                }
            }
        })
        .catch(error => {
            console.error('Error checking existing report:', error);
        });
}

// Function to check if input contains "Tata Leased Line IP:" and update Link column accordingly
function checkTataLeasedLine(inputElement) {
    const inputValue = inputElement.value;
    const row = inputElement.closest('tr');
    const primaryInternetSelect = document.getElementById('primaryInternet');
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    
    console.log('checkTataLeasedLine called with:', inputValue);
    console.log('Primary Internet value:', primaryInternetSelect ? primaryInternetSelect.value : 'not found');
    console.log('Secondary Internet value:', secondaryInternetSelect ? secondaryInternetSelect.value : 'not found');
    
    if (inputValue.includes('Tata Leased Line IP')) {
        console.log('✅ Found "Tata Leased Line IP" in input');
        // If Primary Internet is selected, update the input field
        if (primaryInternetSelect && primaryInternetSelect.value) {
            console.log('✅ Primary Internet selected:', primaryInternetSelect.value);
            // Update the input field with Primary Internet value
            inputElement.value = primaryInternetSelect.value;
            console.log('✅ Updated Leased Lines/DSL Links to:', primaryInternetSelect.value);
        } else {
            console.log('❌ No Primary Internet selected');
        }
    } else if (inputValue.includes('Airtel Internet -')) {
        console.log('✅ Found "Airtel Internet -" in input');
        // If Secondary Internet is selected, update the input field
        if (secondaryInternetSelect && secondaryInternetSelect.value) {
            console.log('✅ Secondary Internet selected:', secondaryInternetSelect.value);
            // Update the input field with Secondary Internet value
            inputElement.value = secondaryInternetSelect.value;
            console.log('✅ Updated Leased Lines/DSL Links to:', secondaryInternetSelect.value);
        } else {
            console.log('❌ No Secondary Internet selected');
        }
    } else {
        console.log('❌ Input does not contain "Tata Leased Line IP" or "Airtel Internet -"');
    }
}

// Function to initialize Tata Leased Line rows on page load
function initializeTataLeasedLineRows() {
    console.log('🔧 Initializing Tata Leased Line rows...');
    const networkRows = document.querySelectorAll('#internet-table tbody tr');
    const primaryInternetSelect = document.getElementById('primaryInternet');
    
    console.log('Found network rows:', networkRows.length);
    console.log('Primary Internet select:', primaryInternetSelect);
    console.log('Primary Internet value:', primaryInternetSelect ? primaryInternetSelect.value : 'not found');
    
    networkRows.forEach((row, index) => {
        const leasedLineInput = row.querySelector('.leased-line-input');
        const linkSelect = row.querySelector('.link-select');
        
        console.log(`Row ${index + 1}:`, {
            leasedLineInput: leasedLineInput ? leasedLineInput.value : 'not found',
            linkSelect: linkSelect ? 'found' : 'not found'
        });
        
        if (leasedLineInput && leasedLineInput.value.includes('Tata Leased Line IP')) {
            console.log(`✅ Row ${index + 1} contains "Tata Leased Line IP"`);
            if (primaryInternetSelect && primaryInternetSelect.value) {
                console.log(`✅ Updating row ${index + 1} Leased Lines/DSL Links to:`, primaryInternetSelect.value);
                // Update the input field with Primary Internet value
                leasedLineInput.value = primaryInternetSelect.value;
            } else {
                console.log(`❌ No Primary Internet selected for row ${index + 1}`);
            }
        } else if (leasedLineInput && leasedLineInput.value.includes('Airtel Internet -')) {
            console.log(`✅ Row ${index + 1} contains "Airtel Internet -"`);
            const secondaryInternetSelect = document.getElementById('secondaryInternet');
            if (secondaryInternetSelect && secondaryInternetSelect.value) {
                console.log(`✅ Updating row ${index + 1} Leased Lines/DSL Links to:`, secondaryInternetSelect.value);
                // Update the input field with Secondary Internet value
                leasedLineInput.value = secondaryInternetSelect.value;
            } else {
                console.log(`❌ No Secondary Internet selected for row ${index + 1}`);
            }
        }
    });
}

// Function to update all Tata Leased Line rows when Primary Internet changes
function updateTataLeasedLineRows() {
    const primaryInternetValue = document.getElementById('primaryInternet').value;
    const networkRows = document.querySelectorAll('#internet-table tbody tr');
    
    networkRows.forEach(row => {
        const leasedLineInput = row.querySelector('.leased-line-input');
        
        if (leasedLineInput && leasedLineInput.value.includes('Tata Leased Line IP')) {
            if (primaryInternetValue) {
                // Update the input field with Primary Internet value
                leasedLineInput.value = primaryInternetValue;
                console.log('✅ Updated Tata Leased Line row to:', primaryInternetValue);
            }
        }
    });
}

// Function to update Airtel Internet rows when Secondary Internet changes
function updateAirtelInternetRows() {
    const secondaryInternetValue = document.getElementById('secondaryInternet').value;
    const networkRows = document.querySelectorAll('#internet-table tbody tr');
    
    networkRows.forEach(row => {
        const leasedLineInput = row.querySelector('.leased-line-input');
        
        if (leasedLineInput && leasedLineInput.value.includes('Airtel Internet -')) {
            if (secondaryInternetValue) {
                // Update the input field with Secondary Internet value
                leasedLineInput.value = secondaryInternetValue;
                console.log('✅ Updated Airtel Internet row to:', secondaryInternetValue);
            }
        }
    });
}

// Function to validate Secondary Internet selection
function validateSecondaryInternet() {
    const primaryInternetSelect = document.getElementById('primaryInternet');
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    
    if (primaryInternetSelect && secondaryInternetSelect) {
        const primaryValue = primaryInternetSelect.value;
        const secondaryValue = secondaryInternetSelect.value;
        
        if (primaryValue && secondaryValue && primaryValue === secondaryValue) {
            // Show error message
            alert('❌ PRIMARY INTERNET ALREADY SELECTED');
            
            // Reset Secondary Internet to empty
            secondaryInternetSelect.value = '';
            
            // Update Airtel Internet rows since Secondary Internet changed
            updateAirtelInternetRows();
            
            return false;
        }
    }
    return true;
}

// Function to validate Primary Internet selection
function validatePrimaryInternet() {
    const primaryInternetSelect = document.getElementById('primaryInternet');
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    
    if (primaryInternetSelect && secondaryInternetSelect) {
        const primaryValue = primaryInternetSelect.value;
        const secondaryValue = secondaryInternetSelect.value;
        
        if (primaryValue && secondaryValue && primaryValue === secondaryValue) {
            // Show error message
            alert('❌ SECONDARY INTERNET ALREADY SELECTED');
            
            // Reset Primary Internet to empty
            primaryInternetSelect.value = '';
            
            // Update Tata Leased Line rows since Primary Internet changed
            updateTataLeasedLineRows();
            
            return false;
        }
    }
    return true;
}

// Add event listeners to check for existing reports when date or location changes
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    const locationSelect = document.getElementById('location');
    const primaryInternetSelect = document.getElementById('primaryInternet');
    
    if (dateInput) {
        dateInput.addEventListener('change', checkExistingReport);
    }
    if (locationSelect) {
        locationSelect.addEventListener('change', checkExistingReport);
    }
    
    // Add event listener for Primary Internet dropdown changes
    if (primaryInternetSelect) {
        primaryInternetSelect.addEventListener('change', function() {
            if (validatePrimaryInternet()) {
                updateTataLeasedLineRows();
                updateNetworkRowsFromDropdowns();
            }
        });
    }
    
    // Add event listener for Secondary Internet dropdown changes
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    if (secondaryInternetSelect) {
        secondaryInternetSelect.addEventListener('change', function() {
            if (validateSecondaryInternet()) {
                updateAirtelInternetRows();
                updateNetworkRowsFromDropdowns();
            }
        });
    }
    
    // Initialize Tata Leased Line rows on page load
    setTimeout(() => {
        initializeTataLeasedLineRows();
        // Also trigger the check for existing rows
        const existingRows = document.querySelectorAll('#internet-table tbody tr');
        existingRows.forEach(row => {
            const leasedLineInput = row.querySelector('.leased-line-input');
            if (leasedLineInput && (leasedLineInput.value.includes('Tata Leased Line IP') || leasedLineInput.value.includes('Airtel Internet -'))) {
                checkTataLeasedLine(leasedLineInput);
            }
        });
    }, 1000); // Small delay to ensure dropdowns are loaded
    
    // Check on page load if both date and location are already set
    if (dateInput && locationSelect && dateInput.value && locationSelect.value) {
        checkExistingReport();
    }
});

// Function to handle call raised dropdown change
function handleCallRaisedChange(rowId) {
    const callRaisedSelect = document.getElementById(`call-raised-${rowId}`);
    const callNumberContainer = document.getElementById(`call-number-container-${rowId}`);
    const callNumberInput = document.getElementById(`call-number-${rowId}`);
    const callWarning = document.getElementById(`call-warning-${rowId}`);
    
    if (callRaisedSelect && callNumberContainer && callNumberInput && callWarning) {
        const selectedValue = callRaisedSelect.value;
        
        // Hide both containers initially
        callNumberContainer.style.display = 'none';
        callWarning.style.display = 'none';
        
        if (selectedValue === 'Yes') {
            // Show call number input
            callNumberContainer.style.display = 'block';
            callNumberInput.focus();
        } else if (selectedValue === 'No') {
            // Show warning message
            callWarning.style.display = 'block';
        }
        // If empty selection, both remain hidden
    }
}

// Function to handle IT Manager dropdown change
function handleITManagerChange(rowId) {
    const itManagerSelect = document.getElementById(`it-manager-${rowId}`);
    const itManagerWarning = document.getElementById(`it-manager-warning-${rowId}`);
    
    if (itManagerSelect && itManagerWarning) {
        const selectedValue = itManagerSelect.value;
        
        if (selectedValue === 'Yes') {
            // Hide warning when "Yes" is selected
            itManagerWarning.style.display = 'none';
        } else if (selectedValue === 'No') {
            // Show warning when "No" is selected
            itManagerWarning.style.display = 'block';
        } else {
            // Hide warning when nothing is selected
            itManagerWarning.style.display = 'none';
        }
    }
}

// Function to handle IT/HR dropdown change for Others section
function handleITHrChange(rowId) {
    const itHrSelect = document.getElementById(`it-hr-${rowId}`);
    const itHrWarning = document.getElementById(`it-hr-warning-${rowId}`);
    
    if (itHrSelect && itHrWarning) {
        const selectedValue = itHrSelect.value;
        
        if (selectedValue === 'Yes') {
            // Hide warning when "Yes" is selected
            itHrWarning.style.display = 'none';
        } else if (selectedValue === 'No') {
            // Show warning when "No" is selected
            itHrWarning.style.display = 'block';
        } else {
            // Hide warning when nothing is selected
            itHrWarning.style.display = 'none';
        }
    }
}

// Function to handle IT/HR dropdown change for Telecom section
function handleTelecomITHrChange(rowId) {
    const itHrSelect = document.getElementById(`telecom-it-hr-${rowId}`);
    const itHrWarning = document.getElementById(`telecom-it-hr-warning-${rowId}`);
    
    if (itHrSelect && itHrWarning) {
        const selectedValue = itHrSelect.value;
        
        if (selectedValue === 'Yes') {
            // Hide warning when "Yes" is selected
            itHrWarning.style.display = 'none';
        } else if (selectedValue === 'No') {
            // Show warning when "No" is selected
            itHrWarning.style.display = 'block';
        } else {
            // Hide warning when nothing is selected
            itHrWarning.style.display = 'none';
        }
    }
}

// Function to handle IT Manager dropdown change for Technology Room section
function handleTechRoomITManagerChange(rowId) {
    const itManagerSelect = document.getElementById(`techroom-it-manager-${rowId}`);
    const itManagerWarning = document.getElementById(`techroom-it-manager-warning-${rowId}`);
    
    if (itManagerSelect && itManagerWarning) {
        const selectedValue = itManagerSelect.value;
        
        if (selectedValue === 'Yes') {
            // Hide warning when "Yes" is selected
            itManagerWarning.style.display = 'none';
        } else if (selectedValue === 'No') {
            // Show warning when "No" is selected
            itManagerWarning.style.display = 'block';
        } else {
            // Hide warning when nothing is selected
            itManagerWarning.style.display = 'none';
        }
    }
}

// Function to handle IT Manager dropdown change for Printers section
function handlePrinterITManagerChange(rowId) {
    const itManagerSelect = document.getElementById(`printer-it-manager-${rowId}`);
    const itManagerWarning = document.getElementById(`printer-it-manager-warning-${rowId}`);
    
    if (itManagerSelect && itManagerWarning) {
        const selectedValue = itManagerSelect.value;
        
        if (selectedValue === 'Yes') {
            // Hide warning when "Yes" is selected
            itManagerWarning.style.display = 'none';
        } else if (selectedValue === 'No') {
            // Show warning when "No" is selected
            itManagerWarning.style.display = 'block';
        } else {
            // Hide warning when nothing is selected
            itManagerWarning.style.display = 'none';
        }
    }
}

// Function to load yesterday's printer readings when location changes
function loadYesterdayPrinterReadings(location) {
    if (!location) {
        // Clear all yesterday reading fields if no location selected
        clearYesterdayReadings();
        return;
    }
    
    fetch(`/it/api/yesterday-printer-readings/${encodeURIComponent(location)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateYesterdayReadings(data.yesterday_readings);
            } else {
                console.error('Error loading yesterday readings:', data.error);
                clearYesterdayReadings();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            clearYesterdayReadings();
        });
}

// Function to populate yesterday's readings in the form
function populateYesterdayReadings(yesterdayReadings) {
    const printerRows = document.querySelectorAll('#printers-table tbody tr');
    
    console.log('DEBUG: Populating yesterday readings with:', yesterdayReadings);
    console.log('DEBUG: Available printer names in DB:', Object.keys(yesterdayReadings));
    
    // If no yesterday's data available, all printers should show "No Data"
    if (!yesterdayReadings || Object.keys(yesterdayReadings).length === 0) {
        console.log('DEBUG: No yesterday\'s data available - setting all printers to "No Data"');
        printerRows.forEach((row, index) => {
            const yesterdayInput = row.querySelector('input[id^="printer-yesterday-"]');
            if (yesterdayInput) {
                yesterdayInput.value = 'No Data';
                yesterdayInput.readOnly = true;
                yesterdayInput.style.backgroundColor = '#fff3cd';
                yesterdayInput.style.cursor = 'not-allowed';
                yesterdayInput.placeholder = 'No previous data';
            }
        });
        return;
    }
    
    printerRows.forEach((row, index) => {
        // Get printer name from the second column (td:nth-child(2))
        const printerNameCell = row.querySelector('td:nth-child(2)');
        const yesterdayInput = row.querySelector('input[id^="printer-yesterday-"]');
        
        if (printerNameCell && yesterdayInput) {
            // Get printer name from the cell text content
            let printerName = printerNameCell.textContent.trim();
            console.log(`DEBUG: Row ${index + 1} - Looking for printer: "${printerName}"`);
            
            // Check if this is an input field (for dynamically added rows)
            const printerNameInput = printerNameCell.querySelector('input');
            if (printerNameInput) {
                const inputValue = printerNameInput.value.trim();
                console.log(`DEBUG: Row ${index + 1} - Input field value: "${inputValue}"`);
                if (inputValue) {
                    printerName = inputValue; // Use input value if available
                }
            }
            
            // IMPORTANT: Only use exact matches, no partial matching to avoid wrong data assignment
            if (yesterdayReadings[printerName]) {
                console.log(`DEBUG: Found EXACT match for "${printerName}": ${yesterdayReadings[printerName]}`);
                yesterdayInput.value = yesterdayReadings[printerName];
                yesterdayInput.readOnly = true;
                yesterdayInput.style.backgroundColor = '#f8f9fa';
                yesterdayInput.style.cursor = 'not-allowed';
                yesterdayInput.placeholder = 'Yesterday\'s reading';
            } else {
                console.log(`DEBUG: NO EXACT match found for "${printerName}" - setting to "No Data"`);
                // Clear and show "No Data" if no exact match found
                yesterdayInput.value = 'No Data';
                yesterdayInput.readOnly = true;
                yesterdayInput.style.backgroundColor = '#fff3cd';
                yesterdayInput.style.cursor = 'not-allowed';
                yesterdayInput.placeholder = 'No previous data';
            }
        }
    });
}

// Function to clear yesterday's readings
function clearYesterdayReadings() {
    const printerRows = document.querySelectorAll('#printers-table tbody tr');
    
    console.log('DEBUG: Clearing all yesterday readings');
    
    printerRows.forEach((row, index) => {
        const yesterdayInput = row.querySelector('input[id^="printer-yesterday-"]');
        
        if (yesterdayInput) {
            console.log(`DEBUG: Clearing yesterday reading for row ${index + 1}`);
            yesterdayInput.value = 'No Data';
            yesterdayInput.readOnly = true;
            yesterdayInput.style.backgroundColor = '#fff3cd';
            yesterdayInput.style.cursor = 'not-allowed';
            yesterdayInput.placeholder = 'No previous data';
        }
    });
}

// Function to show alerts
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Function to add new BOD data (name, primary_internet, secondary_internet)
function addBodData(type) {
    const newValue = prompt(`Enter new ${type.replace('_', ' ')}:`);
    if (newValue && newValue.trim() !== '') {
        // Add to dropdown
        const selectElement = document.getElementById(type === 'name' ? 'name' : type === 'primary_internet' ? 'primaryInternet' : 'secondaryInternet');
        if (selectElement) {
            const option = document.createElement('option');
            option.value = newValue.trim();
            option.textContent = newValue.trim();
            selectElement.appendChild(option);
            
            // Save to localStorage
            const key = `bod_${type}_options`;
            let options = JSON.parse(localStorage.getItem(key) || '[]');
            options.push(newValue.trim());
            localStorage.setItem(key, JSON.stringify(options));
            
            showAlert(`New ${type.replace('_', ' ')} added successfully!`, 'success');
        }
    }
}

// Function to remove BOD data (name, primary_internet, secondary_internet)
function removeBodData(type) {
    const selectElement = document.getElementById(type === 'name' ? 'name' : type === 'primary_internet' ? 'primaryInternet' : 'secondaryInternet');
    if (selectElement && selectElement.value) {
        const selectedValue = selectElement.value;
        
        // Remove from dropdown
        const optionToRemove = selectElement.querySelector(`option[value="${selectedValue}"]`);
        if (optionToRemove) {
            optionToRemove.remove();
            
            // Reset selection
            selectElement.value = '';
            
            // Remove from localStorage
            const key = `bod_${type}_options`;
            let options = JSON.parse(localStorage.getItem(key) || '[]');
            options = options.filter(option => option !== selectedValue);
            localStorage.setItem(key, JSON.stringify(options));
            
            showAlert(`${type.replace('_', ' ')} removed successfully!`, 'success');
        }
    } else {
        showAlert('Please select a BOD Name to remove', 'warning');
    }
}

// Function to delete dropdown item (for primary and secondary internet)
function deleteDropdownItem(type) {
    const selectElement = document.getElementById(type === 'primary_internet' ? 'primaryInternet' : 'secondaryInternet');
    if (selectElement && selectElement.value) {
        const selectedValue = selectElement.value;
        
        // Remove from dropdown
        const optionToRemove = selectElement.querySelector(`option[value="${selectedValue}"]`);
        if (optionToRemove) {
            optionToRemove.remove();
            
            // Reset selection
            selectElement.value = '';
            
            // Remove from localStorage
            const key = `bod_${type}_options`;
            let options = JSON.parse(localStorage.getItem(key) || '[]');
            options = options.filter(option => option !== selectedValue);
            localStorage.setItem(key, JSON.stringify(options));
            
            showAlert(`${type.replace('_', ' ')} removed successfully!`, 'success');
        }
    } else {
        showAlert(`Please select a ${type.replace('_', ' ')} to remove`, 'warning');
    }
}

// Function to make name field readonly after user enters a value
function makeNameReadonly(input) {
    if (input.value.trim() !== '') {
        input.readOnly = true;
        input.style.backgroundColor = '#f8f9fa';
        input.style.cursor = 'not-allowed';
        input.classList.add('readonly-field');
        console.log('DEBUG: Made name field readonly for:', input.value);
    }
}

// Function to update yesterday readings for newly added printer rows
function updateYesterdayReadingsForNewRows() {
    const locationSelect = document.getElementById('location');
    if (locationSelect && locationSelect.value) {
        loadYesterdayPrinterReadings(locationSelect.value);
    }
}

// Function to get current time in HH:MM:SS format
function getCurrentTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
}

// Function to update checked time when any field in a row is changed
function updateCheckedTime(element) {
    const row = element.closest('tr');
    if (row) {
        // Find the time span - it's the span in the checked time column
        // Try different selectors to find the checked time span
        let checkedTimeSpan = row.querySelector('td:nth-last-child(2) span');
        if (!checkedTimeSpan) {
            checkedTimeSpan = row.querySelector('td:last-child span');
        }
        if (!checkedTimeSpan) {
            // Try to find by looking for spans in the row
            const spans = row.querySelectorAll('span');
            checkedTimeSpan = spans[spans.length - 1]; // Last span in the row
        }
        
        if (checkedTimeSpan) {
            const currentTime = getCurrentTime();
            checkedTimeSpan.textContent = currentTime;
            console.log('Updated checked time to:', currentTime, 'for row:', row);
        } else {
            console.log('Could not find checked time span in row:', row);
        }
    }
}

// Function to update all checked times to current time before form submission
function updateAllCheckedTimes() {
    console.log('Updating all checked times to current time...');
    const currentTime = getCurrentTime();
    console.log('Current time is:', currentTime);
    
    // Update all tables
    const tableIds = ['internet-table', 'server-table', 'antivirus-table', 'sharing-table', 'security-table', 'telecom-table', 'techroom-table', 'printers-table', 'others-table'];
    
    tableIds.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (table) {
            console.log('Processing table:', tableId);
            const rows = table.querySelectorAll('tbody tr');
            console.log('Found', rows.length, 'rows in table', tableId);
            
            rows.forEach((row, index) => {
                // Skip hidden rows
                if (row.style.display === 'none') {
                    console.log('Skipping hidden row', index + 1, 'in', tableId);
                    return;
                }
                
                // Find the checked time span in this row - try multiple strategies
                let checkedTimeSpan = null;
                
                // Strategy 1: Look for span in the last column
                checkedTimeSpan = row.querySelector('td:last-child span');
                
                // Strategy 2: Look for span in second-to-last column
                if (!checkedTimeSpan) {
                    checkedTimeSpan = row.querySelector('td:nth-last-child(2) span');
                }
                
                // Strategy 3: Look for any span in the row
                if (!checkedTimeSpan) {
                    const spans = row.querySelectorAll('span');
                    if (spans.length > 0) {
                        checkedTimeSpan = spans[spans.length - 1]; // Last span in the row
                    }
                }
                
                if (checkedTimeSpan) {
                    const oldTime = checkedTimeSpan.textContent.trim();
                    checkedTimeSpan.textContent = currentTime;
                    console.log(`Updated row ${index + 1} in ${tableId}: "${oldTime}" → "${currentTime}"`);
                } else {
                    console.log(`Could not find checked time span in row ${index + 1} of ${tableId}`);
                    // Debug: show what's in the row
                    const cells = row.querySelectorAll('td');
                    console.log(`Row ${index + 1} has ${cells.length} cells:`, Array.from(cells).map(cell => cell.textContent.trim()));
                }
            });
        } else {
            console.log('Table not found:', tableId);
        }
    });
    
    console.log('All checked times updated to:', currentTime);
    
    // Force a small delay to ensure DOM updates are complete
    return new Promise(resolve => {
        setTimeout(() => {
            console.log('DOM update delay completed');
            resolve();
        }, 100);
    });
}

// Add event listeners to all form controls to update checked time when changed
document.addEventListener('DOMContentLoaded', function() {
    // Function to add listeners to a container
    function addCheckedTimeListeners(container) {
        const selects = container.querySelectorAll('select');
        const inputs = container.querySelectorAll('input[type="text"]');
        
        selects.forEach(select => {
            select.addEventListener('change', function() {
                updateCheckedTime(this);
            });
        });
        
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() !== '') {
                    updateCheckedTime(this);
                }
            });
            input.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    updateCheckedTime(this);
                }
            });
        });
    }
    
    // Add listeners to all existing tables
    const tables = document.querySelectorAll('table');
    tables.forEach(table => {
        addCheckedTimeListeners(table);
    });
    
    // Re-add listeners when new rows are added (for dynamically added content)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    if (node.tagName === 'TR' || node.querySelector('tr')) {
                        addCheckedTimeListeners(node);
                    }
                }
            });
        });
    });
    
    // Start observing
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    // Test function to check current time and data collection
    window.testCheckedTimeData = function() {
        console.log('Testing checked time data collection...');
        console.log('Current time function returns:', getCurrentTime());
        
        // Test data collection for one table
        const testData = collectTableData('internet-table');
        console.log('Test data collection result:', testData);
        
        alert('Check console for test results. Current time: ' + getCurrentTime());
    };
    
    // Add a test button to the page for easy testing
    setTimeout(() => {
        const testButton = document.createElement('button');
        testButton.textContent = 'Test Checked Time Data';
        testButton.className = 'btn btn-info btn-sm';
        testButton.style.position = 'fixed';
        testButton.style.top = '10px';
        testButton.style.right = '10px';
        testButton.style.zIndex = '9999';
        testButton.onclick = window.testCheckedTimeData;
        document.body.appendChild(testButton);
        console.log('Test button added to page');
    }, 2000);
    
    // Load saved BOD data options from localStorage
    loadBodDataOptions();
});

// Function to load saved BOD data options from localStorage
function loadBodDataOptions() {
    // Load name options
    const nameOptions = JSON.parse(localStorage.getItem('bod_name_options') || '[]');
    const nameSelect = document.getElementById('name');
    if (nameSelect) {
        nameOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            nameSelect.appendChild(optionElement);
        });
    }
    
    // Load primary internet options
    const primaryInternetOptions = JSON.parse(localStorage.getItem('bod_primary_internet_options') || '[]');
    const primaryInternetSelect = document.getElementById('primaryInternet');
    if (primaryInternetSelect) {
        primaryInternetOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            primaryInternetSelect.appendChild(optionElement);
        });
    }
    
    // Load secondary internet options
    const secondaryInternetOptions = JSON.parse(localStorage.getItem('bod_secondary_internet_options') || '[]');
    const secondaryInternetSelect = document.getElementById('secondaryInternet');
    if (secondaryInternetSelect) {
        secondaryInternetOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            secondaryInternetSelect.appendChild(optionElement);
        });
    }
}

</script>
{% endblock %}
