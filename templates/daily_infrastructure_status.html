{% extends 'base.html' %}

{% block title %}Daily Pre-Day Infrastructure Status Check{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-calendar-check me-2"></i>
                        Daily Pre-Day Infrastructure Status Check
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="infrastructure-status-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Submitted Time</th>
                                    <th>Secondary Internet</th>
                                    <th>Actions</th>
                                    <th>Send Mail</th>
                                </tr>
                            </thead>
                            <tbody id="reports-tbody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for showing detailed report -->
<div class="modal fade" id="reportDetailModal" tabindex="-1" aria-labelledby="reportDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportDetailModalLabel">BOD Report Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reportDetailContent">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for delete confirmation -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteConfirmContent">
                <!-- Delete confirmation message will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
    .clickable-date {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
    }
    .clickable-date:hover {
        color: #0056b3;
    }
    .report-section {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .report-section-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
    }
    .report-section-body {
        padding: 15px;
    }
    .report-table {
        width: 100%;
        margin-bottom: 0;
    }
    .report-table th {
        background-color: #e9ecef;
        font-weight: 600;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .locked-delete {
        color: #6c757d;
        font-size: 0.875rem;
        cursor: not-allowed;
    }
    .locked-delete:hover {
        color: #495057;
    }
    
    /* Highlight rows with "Not Working" status */
    .status-not-working-row {
        background-color: #ffebee !important;
        border-left: 4px solid #dc3545 !important;
    }
    
    .status-not-working-row:hover {
        background-color: #ffcdd2 !important;
    }
    
    /* Make the red background more prominent */
    .status-not-working-row td {
        background-color: #ffebee !important;
        color: #d32f2f !important;
        font-weight: 500;
    }
    
    .status-not-working-row:hover td {
        background-color: #ffcdd2 !important;
    }
    
    /* Status indicators */
    .status-working {
        color: #28a745;
        font-weight: 600;
    }
    
    .status-not-working {
        color: #dc3545;
        font-weight: 600;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSavedReports();
});

function loadSavedReports() {
            fetch('/it/api/saved-bod-reports')
        .then(response => {
            if (response.status === 401) {
                // Authentication required - redirect to login
                window.location.href = '/it/login';
                return;
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Already handled redirect
            if (data.success) {
                displayReports(data.reports);
            } else {
                console.error('Error loading reports:', data.error);
                showAlert('Error loading reports: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading reports: ' + error.message, 'danger');
        });
}

function displayReports(reports) {
    const tbody = document.getElementById('reports-tbody');
    tbody.innerHTML = '';
    
    // Get user role from the body data attribute
    const userRole = document.body.getAttribute('data-user-role');
    const isSuperAdmin = userRole === 'super_admin';
    
    if (reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No saved reports found</td></tr>';
        return;
    }
    
    reports.forEach(report => {
        const row = document.createElement('tr');
        
        // Conditionally include delete button based on user role
        const deleteButton = isSuperAdmin ? `
            <button class="btn btn-sm btn-danger" onclick="deleteReport('${report.id}', '${report.date}', '${report.location}')" title="Delete Report for ${report.location}">
                <i class="fas fa-trash"></i> Delete
            </button>
        ` : `
            <span class="locked-delete" title="Only Super Admin can delete reports">
                <i class="fas fa-lock"></i> Delete
            </span>
        `;
        
        row.innerHTML = `
            <td>
                <span class="clickable-date" onclick="viewReportDetails('${report.date}', '${report.location}')">
                    ${formatDate(report.date)}
                </span>
            </td>
            <td>${report.name || '-'}</td>
            <td>
                <span class="badge bg-primary">${report.location || '-'}</span>
            </td>
            <td>${report.submitted_time || '-'}</td>
            <td>${report.secondary_internet || '-'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="viewReportDetails('${report.date}', '${report.location}')" title="View Report Details for ${report.location}">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${deleteButton}
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-success" onclick="sendBodReportEmail('${report.date}', '${report.location}', '${report.name}')" title="Send BOD Report to all admins">
                    <i class="fas fa-envelope"></i> Send Mail
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function viewReportDetails(date, location) {
    const formattedDate = formatDateForAPI(date);
                fetch(`/it/api/saved-bod-reports/${formattedDate}?location=${encodeURIComponent(location)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReportDetails(data.reports, date, location);
            } else {
                console.error('Error loading report details:', data.error);
                showAlert('Error loading report details: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading report details', 'danger');
        });
}

function displayReportDetails(reports, date, location) {
    const modalContent = document.getElementById('reportDetailContent');
    const modalLabel = document.getElementById('reportDetailModalLabel');
    
    modalLabel.textContent = `BOD Report Details - ${formatDate(date)} (${location})`;
    
    let content = '';
    
    if (reports.length === 0) {
        content = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No reports found for ${location} on ${formatDate(date)}.
            </div>
        `;
    } else {
        // Add a header showing the unit information
        content += `
            <div class="alert alert-primary mb-3">
                <i class="fas fa-building me-2"></i>
                <strong>Unit:</strong> ${location} | <strong>Date:</strong> ${formatDate(date)}
            </div>
        `;
        
        reports.forEach((report, index) => {
        content += `
            <div class="report-section">
                <div class="report-section-header">
                    Report ${index + 1} - Submitted by ${report.name}
                    <small class="text-muted ms-2">(${report.submitted_time})</small>
                </div>
                <div class="report-section-body">
        `;
        
        if (report.report_data) {
            // Debug: Log the report data
            console.log('Report data:', report.report_data);
            console.log('Report data type:', typeof report.report_data);
            
            // Parse report_data if it's a string
            let parsedData = report.report_data;
            if (typeof report.report_data === 'string') {
                try {
                    parsedData = JSON.parse(report.report_data);
                    console.log('Parsed data:', parsedData);
                } catch (e) {
                    console.error('Error parsing report data:', e);
                    parsedData = {};
                }
            }
            
            // Display each section of the BOD report
            const sections = ['network', 'server_connectivity', 'antivirus', 'common_sharing', 'security', 'telecom', 'tech_room', 'printers', 'others'];
            
            sections.forEach(section => {
                console.log(`Checking section: ${section}`);
                console.log(`Section data:`, parsedData[section]);
                
                if (parsedData[section] && parsedData[section].length > 0) {
                    content += `<h6 class="mt-3 mb-2">${formatSectionName(section)}</h6>`;
                    content += '<div class="table-responsive"><table class="table table-sm report-table">';
                    
                    // Get headers based on section
                    const headers = getSectionHeaders(section);
                    content += '<thead><tr>';
                    headers.forEach(header => {
                        content += `<th>${header}</th>`;
                    });
                    content += '</tr></thead><tbody>';
                    
                    parsedData[section].forEach(row => {
                        // Check if this row has "Not Working" status
                        const statusKey = getHeaderKey('Status', section);
                        const status = row[statusKey];
                        const isNotWorking = status && status.toLowerCase().includes('not working');
                        
                        // Apply CSS class for highlighting
                        const rowClass = isNotWorking ? 'status-not-working-row' : '';
                        content += `<tr class="${rowClass}">`;
                        
                        headers.forEach(header => {
                            const key = getHeaderKey(header, section);
                            const value = row[key];
                            
                            // Add status-specific styling to status column
                            if (header === 'Status' && value) {
                                const statusClass = value.toLowerCase().includes('not working') ? 'status-not-working' : 'status-working';
                                content += `<td><span class="${statusClass}">${value}</span></td>`;
                            } else {
                                content += `<td>${value || '-'}</td>`;
                            }
                        });
                        content += '</tr>';
                    });
                    
                    content += '</tbody></table></div>';
                }
            });
        }
        
        content += '</div></div>';
        });
    }
    
    modalContent.innerHTML = content;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('reportDetailModal'));
    modal.show();
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function formatDateForAPI(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatSectionName(section) {
    const names = {
        'network': 'Network',
        'server_connectivity': 'Server Connectivity',
        'antivirus': 'Antivirus Status For Renganathan T',
        'common_sharing': 'Common Sharing',
        'security': 'Security',
        'telecom': 'Telecommunication',
        'tech_room': 'Technology Room',
        'printers': 'Printers',
        'others': 'Others'
    };
    return names[section] || section;
}

function getSectionHeaders(section) {
    const headers = {
        'network': ['S.No', 'Leased Lines/DSL Links', 'Link', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'server_connectivity': ['S.No', 'Server Name', 'IP Address', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'antivirus': ['S.No', 'System Name', 'Antivirus Status', 'Last Updated', 'Remarks', 'Checked Time'],
        'common_sharing': ['S.No', 'Folder Name', 'Access Rights', 'Status', 'Remarks', 'Checked Time'],
        'security': ['S.No', 'Security Device', 'Location', 'Status', 'Remarks', 'Checked Time'],
        'telecom': ['S.No', 'Name', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'tech_room': ['S.No', 'Equipment', 'Status', 'Reason', 'Remarks', 'Checked Time'],
        'printers': ['S.No', 'Printer Name', 'Status', 'Reason', 'Yesterday Reading', 'Today Reading', 'Remarks', 'Checked Time'],
        'others': ['S.No', 'Item', 'Status', 'Reason', 'Remarks', 'Checked Time']
    };
    return headers[section] || [];
}

function getHeaderKey(header, section) {
    const keyMappings = {
        'network': {
            'S.No': 'sno',
            'Leased Lines/DSL Links': 'leased_line',
            'Link': 'link',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'server_connectivity': {
            'S.No': 'sno',
            'Server Name': 'server_name',
            'IP Address': 'ip_address',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'antivirus': {
            'S.No': 'sno',
            'System Name': 'system_name',
            'Antivirus Status': 'antivirus_status',
            'Last Updated': 'last_updated',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'common_sharing': {
            'S.No': 'sno',
            'Folder Name': 'folder_name',
            'Access Rights': 'access_rights',
            'Status': 'status',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'security': {
            'S.No': 'sno',
            'Security Device': 'security_device',
            'Location': 'location',
            'Status': 'status',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'telecom': {
            'S.No': 'sno',
            'Name': 'name',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'tech_room': {
            'S.No': 'sno',
            'Equipment': 'equipment',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'printers': {
            'S.No': 'sno',
            'Printer Name': 'printer_name',
            'Status': 'status',
            'Reason': 'reason',
            'Yesterday Reading': 'yesterday_reading',
            'Today Reading': 'today_reading',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        },
        'others': {
            'S.No': 'sno',
            'Item': 'item',
            'Status': 'status',
            'Reason': 'reason',
            'Remarks': 'remarks',
            'Checked Time': 'checked_time'
        }
    };
    
    return keyMappings[section]?.[header] || header.toLowerCase().replace(/\s+/g, '_');
}

function deleteReport(reportId, date, location) {
    // Show confirmation modal
    const modalContent = document.getElementById('deleteConfirmContent');
    modalContent.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone.
        </div>
        <p>Are you sure you want to delete the BOD report for <strong>${location}</strong> on <strong>${formatDate(date)}</strong>?</p>
    `;
    
    // Set up the confirm button
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = function() {
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modal.hide();
        
        // Send delete request
        fetch(`/it/api/saved-bod-reports/${reportId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Report deleted successfully!', 'success');
                // Reload the reports table
                loadSavedReports();
            } else {
                showAlert('Error deleting report: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting report', 'danger');
        });
    };
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function sendBodReportEmail(date, location, name) {
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    button.disabled = true;
    
    const formattedDate = formatDateForAPI(date);
    
            fetch('/it/api/send-bod-report-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: formattedDate,
            location: location,
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('BOD Report email sent successfully to all admins!', 'success');
        } else {
            showAlert('Error sending email: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error sending email', 'danger');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
